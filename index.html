<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± | ÙŠÙˆÙ…ÙŠØ© â€¢ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© â€¢ Ø´Ù‡Ø±ÙŠØ©</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;800&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
  /* Ù…ÙˆØ§ÙÙ‚ Ù„ØªÙØ¶ÙŠÙ„Ø§ØªÙƒ:
     - ØªÙ†Ø²ÙŠÙ„ PDF Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø©).
     - Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© ØªØªÙƒØ±Ø± Ø£Ø¹Ù„Ù‰ ÙƒÙ„ ØµÙØ­Ø© (position:fixed + spacer).
     - Ø§Ù„ØµÙˆØ± Ø¨Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª 60mm.
     - Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø¨Ù†Ù‚Ø§Ø·.
     - ØªØ°ÙŠÙŠÙ„ Ø£Ø®Ø¶Ø±.
  */

  :root {
    --brand:#006C35; --brand-2:#0A8A4F; --accent:#00A36C; --brand-weak:#E8F4EC;
    --ink:#101315; --muted:#69707D; --bg:#F6F8F7; --card:#FFFFFF; --border:#E3E7EA; --danger:#DA3C3C;
    --radius:14px; --line:1.85; --page-w:920px; --shadow:0 14px 40px rgba(0,0,0,.06);
    --a4-w:210mm; --a4-h:297mm; --paper-pad:12mm;
  }
  html, body { margin:0; background:var(--bg); color:var(--ink); font-family:"Cairo",system-ui,-apple-system,"Segoe UI","Noto Kufi Arabic",Arial,sans-serif; line-height:var(--line);}  

  /* Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ø³ØªØ¹Ø±Ø§Ø¶ÙŠ ÙÙ‚Ø·ØŒ ØºÙŠØ± Ù…Ø·Ø¨ÙˆØ¹) */
  .site-letterhead { position: sticky; top: 0; z-index: 1000; background:#fff; border-bottom:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,.05);} 
  .site-letterhead .inner { max-width:var(--page-w); margin:0 auto; padding:8px 16px; }
  .site-letterhead img { display:block; margin:0 auto; max-width:100%; height:auto; max-height:140px; }
  .lh-placeholder { text-align:center; color:var(--muted); padding:16px 0; font-weight:700; }

  /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
  .container { max-width:var(--page-w); margin:22px auto 44px; padding:0 16px; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }

  /* Ø±Ø£Ø³ ÙˆØªØ¨ÙˆÙŠØ¨Ø§Øª */
  .header { padding:16px 18px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; background:linear-gradient(180deg, var(--brand-weak), #fff); border-bottom:1px solid var(--border);} 
  .brand { display:flex; align-items:center; gap:10px; font-weight:800; color:var(--brand-2);} 
  .brand .dot { width:12px; height:12px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 6px rgba(0,108,53,.12);} 
  .tabs { display:flex; gap:8px; flex-wrap:wrap; }
  .tab { border:1px solid var(--border); background:#fff; color:#1f242b; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:800; transition:.2s; }
  .tab:hover { transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08);} 
  .tab.active { background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 6px 16px rgba(0,108,53,.25);} 

  /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
  .form { padding:20px; display:grid; gap:16px; }
  .row { display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  @media (max-width:680px){ .row{ grid-template-columns:1fr; } }
  label { font-weight:700; font-size:15px; margin-bottom:6px; color:#273036; display:block; }
  input[type="text"], input[type="date"], textarea { width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; color:var(--ink); font-size:15px; outline:none; transition:border .2s, box-shadow .2s, transform .08s; }
  input:focus, textarea:focus { border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-weak); }
  textarea { min-height:140px; resize:vertical; }
  ::placeholder { color:transparent; }
  .is-invalid { border-color:var(--danger) !important; box-shadow:0 0 0 3px rgba(218,60,60,.15) !important; }

  .upload { border:1.5px dashed var(--border); border-radius:12px; padding:16px; background:#FBFEFC; text-align:center; transition:background .2s, border-color .2s; }
  .upload input { display:none; }
  .thumbs { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .thumb { width:96px; height:72px; border-radius:10px; overflow:hidden; border:1px solid var(--border); background:#f2f6f4; position:relative; }
  .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
  .thumb button { position:absolute; inset-inline-start:4px; inset-block-start:4px; border:0; border-radius:8px; padding:4px 7px; font-size:12px; cursor:pointer; background:rgba(218,60,60,.9); color:#fff; }

  .btn { appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:14px; transition:.12s; }
  .btn:hover { filter:brightness(1.02); transform:translateY(-1px);} 
  .btn-primary { background:linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%); color:#fff; box-shadow:0 8px 22px rgba(0,108,53,.25); }
  .btn-ghost { background:#fff; color:#1e232e; border:1px solid var(--border); }
  .btn-danger { background:var(--danger); color:#fff; }
  .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
  .note { color:var(--muted); font-size:12.5px; }

  /* Ù…Ù†Ø·Ù‚Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€PDF (Ù…Ø®ÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©) */
  #printArea { position:absolute; left:-99999px; top:-99999px; }

  /* Ø§Ù„ÙˆØ±Ù‚Ø© */
  .paper { width:var(--a4-w); min-height:var(--a4-h); padding:var(--paper-pad); box-sizing:border-box; margin:0 auto; background:#fff; color:#000; -webkit-print-color-adjust:exact; print-color-adjust:exact; }

  /* ØªØ®Ø·ÙŠØ· Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ±Ù‚Ø© */
  .report { position:relative; }
  /* ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø£Ø¹Ù„Ù‰ ÙƒÙ„ ØµÙØ­Ø© */
  .report .letterhead { position:fixed; inset-inline:var(--paper-pad); top:var(--paper-pad); height:26mm; display:flex; align-items:center; justify-content:center; text-align:center; }
  .report .letterhead img { max-height:26mm; width:auto; }
  .report .letterhead-spacer { height:28mm; }

  .report .title h1 { margin:4mm 0 4mm; font-size:20pt; line-height:1.35; color:#0a5231; }
  .meta { display:grid; grid-template-columns:1fr 1fr; gap:4mm; margin-bottom:6mm; }
  .meta .field { border:1px solid #e6eaee; border-radius:8px; padding:3mm; background:#fafcfa; }
  .meta .label { font-weight:800; color:#1c3b2b; margin-bottom:1mm; }
  .meta .value { color:#222; }

  .block { margin-bottom:6mm; }
  .block h3 { margin:0 0 2mm; font-size:13pt; color:#0b6a3d; }
  .block ul { margin:0; padding-inline-start:18px; list-style-type:disc; }

  /* ØªÙˆØ­ÙŠØ¯ Ù…Ù‚Ø§Ø³ Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
  .gallery { display:flex; flex-wrap:wrap; gap:4mm; }
  .gallery figure { width:calc(50% - 2mm); height:60mm; margin:0; border:1px solid #e6eaee; border-radius:8px; overflow:hidden; background:#fff; }
  .gallery img { width:100%; height:100%; object-fit:cover; display:block; }

  /* ØªØ°Ù„ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± */
  .footer { margin-top:8mm; display:flex; justify-content:space-between; color:var(--brand); font-weight:800; }

  /* Ù…Ù†Ø¹ Ø§Ù†ÙƒØ³Ø§Ø±Ø§Øª Ø®Ø§Ø·Ø¦Ø© */
  .meta, .block, .gallery, .footer { break-inside:avoid; page-break-inside:avoid; }

  /* Ø·Ø¨Ø§Ø¹Ø© */
  @media print {
    body > *:not(#printArea) { display:none !important; }
    html[dir="rtl"] *, .paper { direction:rtl; text-align:right; }
  }

  /* ÙˆØ±Ù‚ A4 */
  @page { size:A4 portrait; margin:0; }

  @media (prefers-reduced-motion:reduce){ *{ animation:none !important; transition:none !important; } }
</style>
</head>
<body>

<div class="site-letterhead">
  <div class="inner" id="siteLetterhead">
    <div class="lh-placeholder">Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù…Ù„Ù Ø¨Ø§Ø³Ù… <b>26</b> ÙÙŠ Ø¬Ø°Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹).</div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="header">
      <div class="brand"><span class="dot"></span> Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
      <nav class="tabs" id="tabs">
        <button class="tab active" data-tab="daily" type="button" aria-pressed="true">ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠØ©</button>
        <button class="tab" data-tab="weekly" type="button" aria-pressed="false">ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</button>
        <button class="tab" data-tab="monthly" type="button" aria-pressed="false">ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ©</button>
      </nav>
    </div>

    <form class="form" id="form" onsubmit="return false;" novalidate>
      <div>
        <label for="programName">Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
        <input id="programName" type="text" />
      </div>

      <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® / Ø§Ù„Ù…Ù‚Ø± -->
      <div class="row" id="row-date-one">
        <div>
          <label for="dateOne">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="dateOne" type="date" />
        </div>
        <div>
          <label for="place">Ù…Ù‚Ø± Ø§Ù„ØªÙ†ÙÙŠØ°</label>
          <input id="place" type="text" />
        </div>
      </div>
      <div class="row" id="row-date-range" style="display:none">
        <div>
          <label for="dateFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input id="dateFrom" type="date" />
        </div>
        <div>
          <label for="dateTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input id="dateTo" type="date" />
        </div>
      </div>

      <div>
        <label for="executor">Ø§Ù„Ù…Ù†ÙØ°Ø©</label>
        <input id="executor" type="text" />
      </div>

      <!-- Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© Ù‚Ø¨Ù„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ù…Ø¨Ø§Ø´Ø±Ø© -->
      <div>
        <label for="audience">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
        <input id="audience" type="text" />
      </div>

      <div>
        <label for="objectives">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</label>
        <textarea id="objectives"></textarea>
      </div>

      <div>
        <label>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (Ø­ØªÙ‰ 4 ØµÙˆØ±)</label>
        <div class="upload" id="dropZone" role="button" tabindex="0" aria-label="Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯">
          <input id="evidenceFiles" type="file" accept="image/*" multiple />
          <label for="evidenceFiles" class="btn btn-ghost">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±</label>
          <div class="note" id="uploadMsg">ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ Ù‡Ù†Ø§. Ø§Ù„Ø­Ø¯ 4 ØµÙˆØ±.</div>
          <div class="thumbs" id="thumbs" aria-live="polite"></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="downloadBtn" type="button">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ PDF</button>
        <button class="btn btn-ghost" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn btn-danger" id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
      <div class="note">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØµÙˆØµ Ù…Ø­Ù„ÙŠÙ‹Ø§ (LocalStorage)ØŒ ÙˆØ§Ù„ØµÙˆØ± Ù…Ø¤Ù‚ØªÙ‹Ø§ (SessionStorage) Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©.</div>
    </form>
  </div>
</div>

<!-- Ù…Ù†Ø·Ù‚Ø© ØªÙˆÙ„ÙŠØ¯ PDF ÙÙ‚Ø· -->
<div id="printArea"></div>

<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ®Ø²ÙŠÙ† ÙˆØ£Ø³Ù…Ø§Ø¡
  const SCHOOL_HEADER_BASENAME = "26"; 
  const STORAGE_KEY = "report-suite-pro-v5"; // bump key Ù„ØªÙØ§Ø¯ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
  const IMG_KEY_PREFIX = "report-suite-pro-v5-img-"; // ØµÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨

  const $ = (sel) => document.querySelector(sel);

  // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø©
  const tabsEl = $("#tabs"), thumbsEl = $("#thumbs"), dropZone = $("#dropZone");
  const filesInput = $("#evidenceFiles"), uploadMsg = $("#uploadMsg");
  const printArea = $("#printArea"), siteLetterhead = $("#siteLetterhead");

  // Ø­Ù‚ÙˆÙ„
  const programName = $("#programName"), audience = $("#audience"), dateOne = $("#dateOne"), dateFrom = $("#dateFrom"), dateTo = $("#dateTo"), place = $("#place"), executor = $("#executor"), objectives = $("#objectives");
  const rowDateOne = $("#row-date-one"), rowDateRange = $("#row-date-range");

  // Ø£Ø²Ø±Ø§Ø±
  const downloadBtn = $("#downloadBtn"), clearBtn = $("#clearBtn"), saveBtn = $("#saveBtn");

  // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  const blank = () => ({ programName:"", audience:"", dateOne:"", dateFrom:"", dateTo:"", place:"", executor:"", objectives:"" });
  const state = { currentTab:"daily", daily:blank(), weekly:blank(), monthly:blank() };
  const cur = () => state[state.currentTab];
  const imgKey = () => IMG_KEY_PREFIX + state.currentTab;

  // Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„
  function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadAll(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return; const p = JSON.parse(raw); if(p && typeof p === 'object'){ ["daily","weekly","monthly"].forEach(k=>{ if(p[k]) state[k] = { ...blank(), ...p[k] }; }); if(p.currentTab) state.currentTab = p.currentTab; } }catch{} }
  function saveImages(list){ sessionStorage.setItem(imgKey(), JSON.stringify(list||[])); }
  function loadImages(){ try{ const raw = sessionStorage.getItem(imgKey()); return raw? JSON.parse(raw): []; }catch{ return []; } }

  // Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© (Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©)
  let letterheadSrc = null;
  async function resolveLetterheadSrc(base){ const exts = ["", ".png", ".jpg", ".jpeg", ".webp", ".svg"]; for(const ext of exts){ const url = `${base}${ext}`; if(await imgExists(url)) return url; } return null; }
  function imgExists(url){ return new Promise((res)=>{ const i = new Image(); i.onload = ()=>res(true); i.onerror = ()=>res(false); i.src = `${url}?v=${Date.now()}`; }); }
  async function loadSiteLetterhead(){ letterheadSrc = await resolveLetterheadSrc(SCHOOL_HEADER_BASENAME); siteLetterhead.innerHTML = ""; if(letterheadSrc){ const img = document.createElement("img"); img.alt = "Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"; img.crossOrigin = "anonymous"; img.src = `${letterheadSrc}?v=${Date.now()}`; siteLetterhead.appendChild(img); } else { const div = document.createElement("div"); div.className = "lh-placeholder"; div.innerHTML = `ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø¨Ø§Ø³Ù… <b>${SCHOOL_HEADER_BASENAME}</b> (Ù…Ø«Ø§Ù„: 26.png / 26.jpg / 26.svg)`; siteLetterhead.appendChild(div); } }

  // ØªØ¨ÙˆÙŠØ¨Ø§Øª
  function switchTab(tab){ state.currentTab = tab; document.querySelectorAll(".tab").forEach((t)=>{ const active = (t.dataset.tab===tab); t.classList.toggle("active", active); t.setAttribute('aria-pressed', active? 'true':'false'); });
    rowDateOne.style.display = tab === "daily" ? "" : "none"; rowDateRange.style.display = tab === "daily" ? "none" : "";
    const s = cur(); programName.value = s.programName||""; audience.value = s.audience||""; dateOne.value = s.dateOne||""; dateFrom.value = s.dateFrom||""; dateTo.value = s.dateTo||""; place.value = s.place||""; executor.value = s.executor||""; objectives.value = s.objectives||"";
    renderThumbs(loadImages()); saveAll(); }
  tabsEl.addEventListener("click", (e)=>{ const b = e.target.closest(".tab"); if(!b) return; switchTab(b.dataset.tab); });

  // Ø±Ø¨Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„
  [programName,audience,dateOne,dateFrom,dateTo,place,executor,objectives].forEach(el=>{ el.addEventListener('input', ()=>{ cur()[el.id] = el.value; saveAll(); }); });
  saveBtn.addEventListener("click", ()=>{ saveAll(); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ”ï¸"); });
  clearBtn.addEventListener("click", ()=>{ if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø·ØŸ")) return; state[state.currentTab] = blank(); saveImages([]); switchTab(state.currentTab); toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­"); });

  // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
  filesInput.addEventListener("change", ()=> handleFiles(filesInput.files));
  dropZone.addEventListener("dragover", (e)=>{ e.preventDefault(); dropZone.style.background = "#E8F4EC"; dropZone.style.borderColor = "var(--brand)"; });
  dropZone.addEventListener("dragleave", ()=>{ dropZone.style.background = "#FBFEFC"; dropZone.style.borderColor = "var(--border)"; });
  dropZone.addEventListener("drop", (e)=>{ e.preventDefault(); dropZone.style.background = "#FBFEFC"; dropZone.style.borderColor = "var(--border)"; handleFiles(e.dataTransfer.files); });

  async function handleFiles(files){ const arr = Array.from(files||[]); if(!arr.length) return; const list = loadImages(); const room = Math.max(0, 4 - list.length); if(room <= 0){ setUploadMsg("ÙˆØµÙ„ØªÙ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (4 ØµÙˆØ±).", true); return; }
    if(arr.length > room){ setUploadMsg(`Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ${room} ØµÙˆØ± ÙÙ‚Ø· (Ø§Ù„Ø­Ø¯ 4).`, true); } else { setUploadMsg("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± âœ”ï¸"); }
    for(const f of arr.slice(0, room)){ if(!f.type.startsWith("image/")) continue; const data = await compressImage(f, 1400, 0.9); list.push(data); }
    saveImages(list); renderThumbs(list); saveAll(); }

  function renderThumbs(list){ thumbsEl.innerHTML = ""; (list||[]).slice(0,4).forEach((src,idx)=>{ const d = document.createElement("div"); d.className = "thumb"; const img = document.createElement("img"); img.src = src; img.alt = `Ø´Ø§Ù‡ÙØ¯ ${idx+1}`; const rm = document.createElement("button"); rm.type='button'; rm.textContent='Ø­Ø°Ù'; rm.title='Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©'; rm.addEventListener('click', ()=>{ const arr = loadImages(); arr.splice(idx,1); saveImages(arr); renderThumbs(arr); }); d.appendChild(img); d.appendChild(rm); thumbsEl.appendChild(d); }); }

  function setUploadMsg(msg, danger=false){ uploadMsg.textContent = msg; uploadMsg.style.color = danger? "var(--danger)":"var(--muted)"; if(!danger){ setTimeout(()=>{ uploadMsg.textContent = "ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ Ù‡Ù†Ø§. Ø§Ù„Ø­Ø¯ 4 ØµÙˆØ±."; uploadMsg.style.color = "var(--muted)"; }, 2000);} }

  // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
  function loadImage(src){ return new Promise((res,rej)=>{ const img = new Image(); img.onload=()=>res(img); img.onerror=rej; img.src = src; }); }
  async function compressImage(file, maxW=1200, quality=0.9){ const dataUrl = await fileToDataURL(file); const img = await loadImage(dataUrl); const ratio = img.width / img.height; const w = Math.min(maxW, img.width); const h = Math.round(w / ratio); const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.fillStyle = "#fff"; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h); return canvas.toDataURL("image/jpeg", quality); }

  async function waitForImages(container){ const imgs = Array.from(container.querySelectorAll("img")); await Promise.all(imgs.map((img)=> img.complete? Promise.resolve(): new Promise((res)=>{ img.onload=res; img.onerror=res; }))); }

  // ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® + HTML
  function fmtDate(iso){ if(!iso) return "â€”"; try{ return new Intl.DateTimeFormat("ar", { dateStyle:"long" }).format(new Date(iso)); }catch{ return iso; } }
  function fmtRange(a,b){ if(!a||!b) return "â€”"; return `${fmtDate(a)} â€” ${fmtDate(b)}`; }
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, (m)=> ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }

  // âœ… ØªÙ‚Ø³ÙŠÙ… Ø³Ù„ÙŠÙ… Ù„Ù„Ø£Ø³Ø·Ø±
  function objectivesHTML(text){
    const lines = (text || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    return lines.length
      ? `<ul>${lines.map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul>`
      : `<ul><li>â€”</li></ul>`;
  }

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ±Ù‚Ø© (Ù…Ø¹ Ù…ÙØ¨Ø§Ø¹Ø¯ Ù„Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø©)
  function buildReportDOM(){ const s = cur(); const paper = document.createElement("div"); paper.className = "paper"; paper.innerHTML = `
      <div class=\"report\"> 
        <div class=\"letterhead\">${ letterheadSrc? `<img alt=\"Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©\" crossorigin=\"anonymous\" src=\"${letterheadSrc}?v=${Date.now()}\">` : `<div class=\"note\" style=\"color:#b00020\">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø©</div>` }</div>
        <div class=\"letterhead-spacer\"></div>
        <div class=\"title\"><h1>${escapeHtml(s.programName || "â€”")}</h1></div>
        <div class=\"meta\">
          <div class=\"field\"><div class=\"label\">${ state.currentTab === "daily" ? "Ø§Ù„ØªØ§Ø±ÙŠØ®" : "Ø§Ù„ÙØªØ±Ø©" }</div><div class=\"value\">${ state.currentTab === "daily" ? fmtDate(s.dateOne) : fmtRange(s.dateFrom, s.dateTo) }</div></div>
          <div class=\"field\"><div class=\"label\">Ù…Ù‚Ø± Ø§Ù„ØªÙ†ÙÙŠØ°</div><div class=\"value\">${escapeHtml(s.place||"â€”")}</div></div>
          <div class=\"field\"><div class=\"label\">Ø§Ù„Ù…Ù†ÙØ°Ø©</div><div class=\"value\">${escapeHtml(s.executor||"â€”")}</div></div>
          <div class=\"field\"><div class=\"label\">Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</div><div class=\"value\">${(loadImages()||[]).length} / 4</div></div>
        </div>
        <div class=\"block\"><h3>Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</h3><div class=\"value\">${escapeHtml(s.audience||"â€”")}</div></div>
        <div class=\"block objectives\"><h3>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</h3><div>${objectivesHTML(s.objectives)}</div></div>
        <div class=\"block\"><h3>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (ØµÙˆØ±)</h3><div class=\"gallery\" id=\"rep-gallery\"></div></div>
        <div class=\"footer\"><div>Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£Ù…Ø§Ù†ÙŠ Ø¢Ù„ Ø¹Ø¨Ø´Ø§Ù†</div><div>ØªØµÙ…ÙŠÙ… : Ø£ Ø±ÙŠÙ… Ù†Ø§ÙÙ„</div></div>
      </div>`;
    const gal = paper.querySelector('#rep-gallery'); (loadImages()||[]).slice(0,4).forEach((src)=>{ const fig=document.createElement('figure'); const img=document.createElement('img'); img.src=src; img.alt='Ø´Ø§Ù‡ÙØ¯'; fig.appendChild(img); gal.appendChild(fig); }); return paper; }

  // Ø§Ø³Ù… Ù…Ù„Ù PDF
  function pdfFileName(){ const s = cur(); const base = (s.programName||"ØªÙ‚Ø±ÙŠØ±").replace(/[\\/:*?"<>|]/g, "").trim() || "ØªÙ‚Ø±ÙŠØ±"; let suffix=""; if(state.currentTab==='daily' && s.dateOne) suffix = s.dateOne; if(state.currentTab!=='daily' && s.dateFrom && s.dateTo) suffix = `${s.dateFrom}_Ø§Ù„Ù‰_${s.dateTo}`; return `${base}-${suffix || new Date().toISOString().slice(0,10)}.pdf`; }

  // ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© html2pdf Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
  function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>res(true); s.onerror=()=>rej(); document.head.appendChild(s); }); }
  async function ensureHtml2Pdf(){ if(window.html2pdf) return true; const fallbacks=["https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"]; for(const url of fallbacks){ try{ await loadScript(url); if(window.html2pdf) return true; }catch{} } alert("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© PDF. ØªØ­Ù‚Ù‘Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø«Ù… Ø£Ø¹ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."); return false; }

  // ØªÙˆÙ„ÙŠØ¯ ÙˆØªÙ†Ø²ÙŠÙ„ PDF (Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§ÙŠÙ†Ø©)
  async function generatePdf(){ const ok = await ensureHtml2Pdf(); if(!ok) return; printArea.innerHTML = ""; const paper = buildReportDOM(); printArea.appendChild(paper); await waitForImages(printArea);
    const opt = { margin:0, filename: pdfFileName(), image:{ type:"jpeg", quality:0.96 }, html2canvas:{ scale:2, useCORS:true, backgroundColor:'#ffffff' }, jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }, pagebreak:{ mode:["avoid-all","css","legacy"], avoid:[".meta", ".block", ".gallery", ".footer"] } };
    try{ await window.html2pdf().set(opt).from(printArea.querySelector('.paper')).save(); }catch(e){ console.error(e); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ PDF."); }
  }

  // Ø£Ø²Ø±Ø§Ø±
  downloadBtn.addEventListener('click', async()=>{ if(!ensureValid()) return alert('Ø£ÙƒÙ…Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©.'); await generatePdf(); });

  // ØªØ­Ù‚Ù‚ Ø¥Ø¯Ø®Ø§Ù„Ø§Øª
  function ensureValid(){ const s = cur(); let ok = true; const mark = (el, bad) => { if(!el) return; el.classList.toggle('is-invalid', !!bad); };
    const badName = !s.programName.trim(); mark(programName, badName); if(badName) ok=false;
    if(state.currentTab === 'daily'){ const badDate = !s.dateOne; mark(dateOne, badDate); if(badDate) ok=false; }
    else { const badFrom=!s.dateFrom, badTo=!s.dateTo, badOrder=(s.dateFrom&&s.dateTo)?(new Date(s.dateFrom)>new Date(s.dateTo)):false; mark(dateFrom, badFrom||badOrder); mark(dateTo, badTo||badOrder); if(badFrom||badTo||badOrder) ok=false; }
    return ok; }

  // Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ±
  function toast(msg){ uploadMsg.textContent = msg; uploadMsg.style.color = 'var(--muted)'; setTimeout(()=>{ uploadMsg.textContent = 'ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ Ù‡Ù†Ø§. Ø§Ù„Ø­Ø¯ 4 ØµÙˆØ±.'; uploadMsg.style.color = 'var(--muted)'; }, 2000); }

  // ====== Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Console ======
  function runTests(){
    const results = [];
    try{
      // objectives parsing
      let html = objectivesHTML("");
      results.push({name:'empty objectives', pass: /<ul>\s*<li>â€”<\/li>\s*<\/ul>/.test(html)});
      html = objectivesHTML("Ø£\nØ¨\nØ¬");
      results.push({name:'newline split', pass: (html.match(/<li>/g)||[]).length === 3});
      html = objectivesHTML("Ø£\r\nØ¨\r\nØ¬");
      results.push({name:'CRLF support', pass: (html.match(/<li>/g)||[]).length === 3});
      html = objectivesHTML("  Ø£ÙˆÙ„  \n\n  Ø«Ø§Ù†ÙŠ \n  Ø«Ø§Ù„Ø«  ");
      results.push({name:'trim & filter', pass: (html.match(/<li>/g)||[]).length === 3});

      // filename sanitize
      state.currentTab='daily'; state.daily={...state.daily, programName:'ØªÙ‚Ø±ÙŠØ±/Ø§Ø³Ù…*ØºÙŠØ±?ØµØ§Ù„Ø­|', dateOne:'2025-09-01'};
      const f1 = pdfFileName();
      results.push({name:'filename sanitized', pass: !(/[\\/:*?"<>|]/.test(f1))});

      // validation order
      state.currentTab='weekly';
      state.weekly={...state.weekly, programName:'X', dateFrom:'2025-09-10', dateTo:'2025-09-01'};
      const vBad = ensureValid();
      results.push({name:'date order invalid', pass: vBad===false});
    }catch(e){ results.push({name:'_crash_', pass:false, err:String(e)}); }
    console.log('%c[tests]', 'color:'+(results.every(r=>r.pass)?'green':'red')+';font-weight:bold;', results);
  }

  (async function init(){ loadAll(); switchTab(state.currentTab || 'daily'); await loadSiteLetterhead(); runTests(); })();
</script>

</body>
</html>
