<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تقرير البرنامج</title>

  <!-- خط عربي أنيق -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- html2pdf (يتضمن html2canvas + jsPDF) لتوليد PDF في الواجهة الأمامية -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPfS+vJr4k2bV5Sef9cYk1Y1gE0jYbHcUarWnms0i3dHf/9QF9lqzNwbtCw2dTmtQ1qClgZsxK9Y1sGfLwQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#1a1a1a;
      --muted:#6a6a6a;
      --brand:#185adb;
      --brand-weak:#e8f0ff;
      --border:#e6e6ef;
      --accent:#00a37a;
    }
    html,body{
      margin:0; padding:0; background:var(--bg); color:var(--ink);
      font-family:"Cairo", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", Arial, sans-serif;
    }
    .container{
      max-width:1100px; margin:32px auto; padding:0 16px;
    }
    .grid{
      display:grid; gap:16px;
      grid-template-columns: 1fr 1.2fr;
    }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      padding:20px; box-shadow:0 6px 20px rgba(10,10,50,0.05);
    }
    .card h2{
      margin:0 0 12px; font-size:20px; font-weight:700;
      display:flex; align-items:center; gap:10px;
    }
    .help{
      font-size:13px; color:var(--muted); margin-top:-4px; margin-bottom:12px;
    }
    label{ display:block; font-weight:600; margin:10px 0 6px; }
    input[type="text"], input[type="date"], textarea{
      width:100%; border:1px solid var(--border); border-radius:10px;
      padding:12px 14px; font-size:15px; background:#fff; color:var(--ink);
      outline:none; transition:border .2s, box-shadow .2s;
    }
    textarea{ resize:vertical; min-height:120px; }
    input:focus, textarea:focus{
      border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-weak);
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:600px){ .row{ grid-template-columns:1fr; } }

    .upload{
      border:1.5px dashed var(--border); border-radius:12px; padding:16px; text-align:center;
      background:#fcfcff;
    }
    .upload input{ display:none; }
    .upload .btn{
      display:inline-block; cursor:pointer; background:var(--brand); color:#fff;
      padding:10px 16px; border-radius:10px; font-weight:600; border:0;
    }
    .note{ font-size:12px; color:var(--muted); margin-top:8px; }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;
    }
    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 16px;
      font-weight:700; cursor:pointer;
    }
    .btn-primary{ background:var(--accent); color:#fff; }
    .btn-secondary{ background:var(--brand); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid var(--border); color:var(--ink); }

    /* معاينة التقرير (الذي يُطبع) */
    .report{
      background:#fff; border:1px solid var(--border); border-radius:14px; padding:28px; position:relative;
    }
    .letterhead{
      width:100%; display:flex; justify-content:center; align-items:center; margin-bottom:16px;
    }
    .letterhead .placeholder{
      width:100%; text-align:center; color:var(--muted); padding:24px; border:1px dashed var(--border); border-radius:10px;
      font-weight:600;
    }
    .letterhead img{
      max-width:100%; height:auto; display:block; margin:auto;
    }

    .title{
      text-align:center; margin:6px 0 18px;
    }
    .title h1{ font-size:24px; margin:0; }
    .meta{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin:12px 0 16px;
    }
    .meta .field{
      border:1px solid var(--border); border-radius:10px; padding:10px 12px;
    }
    .meta .label{ font-size:13px; color:var(--muted); margin-bottom:4px; }
    .meta .value{ font-weight:700; }

    .block{ margin:18px 0; }
    .block h3{ margin:0 0 8px; font-size:18px; border-right:4px solid var(--brand); padding-right:8px; }
    .objectives ul{ margin:0; padding:0 18px; }
    .objectives li{ margin:6px 0; }

    .gallery{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;
    }
    .gallery figure{
      margin:0; border:1px solid var(--border); border-radius:10px; overflow:hidden;
      /* توحيد نسبة العرض للارتفاع لتخرج الصور بمقاس موحّد في PDF */
      aspect-ratio: 4 / 3;
      display:flex; align-items:center; justify-content:center; background:#fafafa;
    }
    .gallery img{ width:100%; height:100%; object-fit:cover; display:block; }

    .footer{
      margin-top:24px; border-top:1px solid var(--border); padding-top:12px;
      display:flex; gap:10px; justify-content:space-between; font-weight:700;
    }

    /* تحسينات الطباعة */
    @media print{
      body{ background:#fff; }
      .container, .grid, .card{ box-shadow:none; border:none; }
      .not-for-print{ display:none !important; }
      .report{ border:none; padding:0; }
      @page{ size:A4; margin:12mm; }
      .block, .meta, .gallery{ break-inside: avoid; }
    }

    /* شارة صغيرة أعلى التقرير أثناء المعاينة */
    .watermark{
      position:absolute; top:8px; left:12px; font-size:11px; color:#9aa3b2;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="grid">
      <!-- لوحة الإدخال -->
      <section class="card">
        <h2>📝 إدخال بيانات التقرير</h2>
        <p class="help">املأ الحقول التالية، ثم أضف الشواهد (حتى 4 صور)، واضغط "فتح التقرير PDF".</p>

        <label for="programName">اسم البرنامج</label>
        <input id="programName" type="text" placeholder="مثال: برنامج تعزيز القيم" required>

        <div class="row">
          <div>
            <label for="date">التاريخ</label>
            <input id="date" type="date" required>
          </div>
          <div>
            <label for="place">مقر التنفيذ</label>
            <input id="place" type="text" placeholder="مثال: القاعة الكبرى">
          </div>
        </div>

        <label for="executor">المنفذة</label>
        <input id="executor" type="text" placeholder="اسم المنفذة">

        <label for="objectives">الأهداف (سطر لكل هدف)</label>
        <textarea id="objectives" placeholder="اكتب كل هدف في سطر مستقل"></textarea>

        <label>الشواهد (صور، كحد أقصى 4)</label>
        <div id="dropZone" class="upload">
          <input id="evidenceFiles" type="file" accept="image/*" multiple>
          <label for="evidenceFiles" class="btn">اختر الصور</label>
          <div class="note">يمكن سحب الصور وإفلاتها هنا. تُعرض الصور بمقاسات موحّدة في التقرير.</div>
          <div id="uploadMsg" class="note"></div>
        </div>

        <div class="actions">
          <button id="openPdf" class="btn btn-primary">📄 فتح التقرير PDF</button>
          <button id="printDirect" class="btn btn-secondary">🖨️ طباعة مباشرة</button>
          <button id="resetAll" class="btn btn-ghost">↺ مسح المدخلات</button>
        </div>
        <div class="note">سيتم حفظ البيانات تلقائيًا على جهازك (لا تُرفع للإنترنت).</div>
      </section>

      <!-- معاينة التقرير (هذا هو العنصر الذي يتحول إلى PDF) -->
      <section class="report card" id="report">
        <div class="watermark not-for-print">معاينة</div>

        <!-- ديباجة المدرسة (من ملف اسمه 26 بالمستودع) -->
        <div class="letterhead" id="letterhead">
          <div class="placeholder">ديباجة المدرسة — ضَع/ي ملفًا باسم <b>26</b> (png/jpg/webp/svg) في جذر المستودع.</div>
        </div>

        <div class="title">
          <h1 id="r_programName">—</h1>
        </div>

        <div class="meta">
          <div class="field">
            <div class="label">التاريخ</div>
            <div class="value" id="r_date">—</div>
          </div>
          <div class="field">
            <div class="label">مقر التنفيذ</div>
            <div class="value" id="r_place">—</div>
          </div>
          <div class="field">
            <div class="label">المنفذة</div>
            <div class="value" id="r_executor">—</div>
          </div>
          <div class="field">
            <div class="label">عدد الشواهد</div>
            <div class="value"><span id="r_count">0</span> / 4</div>
          </div>
        </div>

        <div class="block objectives">
          <h3>الأهداف</h3>
          <div id="r_objectives">
            <ul><li>—</li></ul>
          </div>
        </div>

        <div class="block">
          <h3>الشواهد (صور)</h3>
          <div class="gallery" id="r_gallery"></div>
        </div>

        <div class="footer">
          <div>مديرة المدرسة: أماني آل عبشان</div>
          <div>تصميم: أ ريم نافل</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ---------- إعدادات ----------
    const SCHOOL_HEADER_BASENAME = "26"; // اسم ملف الديباجة بالمستودع (بدون امتداد)

    // محاولة اكتشاف امتداد ملف "26" آليًا (png, jpg, jpeg, webp, svg) أو استعماله كما هو إن وُجد.
    async function resolveLetterheadSrc(base){
      const candidates = [
        base, base + ".png", base + ".jpg", base + ".jpeg", base + ".webp", base + ".svg"
      ];
      for (const url of candidates){
        try{
          const res = await fetch(url, { method:"HEAD", cache:"no-cache" });
          if (res.ok){
            const ct = res.headers.get("content-type") || "";
            if (ct.includes("image") || url === base){ return url; }
          }
        }catch(e){ /* تجاهل */ }
      }
      return null;
    }

    function setLetterhead(src){
      const box = document.getElementById("letterhead");
      box.innerHTML = "";
      if(!src){
        const ph = document.createElement("div");
        ph.className = "placeholder";
        ph.innerHTML = 'تعذّر العثور على ملف الديباجة "<b>' + SCHOOL_HEADER_BASENAME + '</b>"';
        box.appendChild(ph);
        return;
      }
      const img = document.createElement("img");
      img.alt = "ديباجة المدرسة";
      img.src = src;
      box.appendChild(img);
    }

    // ---------- عناصر الواجهة ----------
    const $ = (s) => document.querySelector(s);
    const programName = $("#programName");
    const dateInput   = $("#date");
    const place       = $("#place");
    const executor    = $("#executor");
    const objectives  = $("#objectives");
    const filesInput  = $("#evidenceFiles");
    const dropZone    = $("#dropZone");
    const uploadMsg   = $("#uploadMsg");

    const r_programName = $("#r_programName");
    const r_date        = $("#r_date");
    const r_place       = $("#r_place");
    const r_executor    = $("#r_executor");
    const r_objectives  = $("#r_objectives");
    const r_gallery     = $("#r_gallery");
    const r_count       = $("#r_count");

    const openPdfBtn    = $("#openPdf");
    const printBtn      = $("#printDirect");
    const resetBtn      = $("#resetAll");

    // ---------- حالة التطبيق ----------
    const state = {
      programName: "", date: "", place: "", executor: "", objectives: "",
      images: [] // DataURL[]
    };

    // ---------- أدوات مساعدة ----------
    const fmtDate = (iso) => {
      if(!iso) return "—";
      try{
        // تنسيق عربي طويل (هجري/ميلادي يخضع لإعدادات المتصفح)
        return new Intl.DateTimeFormat('ar', { dateStyle:'long' }).format(new Date(iso));
      }catch{ return iso; }
    };

    function saveState(){
      localStorage.setItem("report-state", JSON.stringify(state));
    }
    function loadState(){
      try{
        const raw = localStorage.getItem("report-state");
        if(!raw) return;
        const s = JSON.parse(raw);
        Object.assign(state, s);
      }catch{}
    }
    function bindInputsToState(){
      programName.value = state.programName || "";
      dateInput.value   = state.date || todayISO();
      place.value       = state.place || "";
      executor.value    = state.executor || "";
      objectives.value  = state.objectives || "";
      render();
    }
    function todayISO(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${m}-${day}`;
    }

    function render(){
      r_programName.textContent = state.programName || "—";
      r_date.textContent        = fmtDate(state.date);
      r_place.textContent       = state.place || "—";
      r_executor.textContent    = state.executor || "—";

      // الأهداف كسطور -> قائمة نقطية
      const lines = (state.objectives || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      r_objectives.innerHTML = lines.length
        ? `<ul>${lines.map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul>`
        : `<ul><li>—</li></ul>`;

      r_gallery.innerHTML = "";
      (state.images || []).slice(0,4).forEach(src => {
        const fig = document.createElement("figure");
        const img = document.createElement("img");
        img.src = src; img.alt = "شاهِد";
        fig.appendChild(img);
        r_gallery.appendChild(fig);
      });
      r_count.textContent = (state.images || []).length;
      saveState();
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // ضغط الصور (تقليل الحجم وتوحيد العرض)
    async function compressImage(file, maxW = 1200, quality = 0.9){
      const dataUrl = await fileToDataURL(file);
      const img = await loadImage(dataUrl);
      const ratio = img.width / img.height;

      let w = Math.min(maxW, img.width);
      let h = Math.round(w / ratio);

      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff"; // خلفية بيضاء في حال كانت الصورة شفافة
      ctx.fillRect(0,0,w,h);
      ctx.drawImage(img, 0, 0, w, h);
      return canvas.toDataURL("image/jpeg", quality);
    }
    function fileToDataURL(file){
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
    }
    function loadImage(src){
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = rej;
        img.src = src;
      });
    }

    // ---------- معالجة الرفع ----------
    function showMsg(msg, ok=true){
      uploadMsg.textContent = msg;
      uploadMsg.style.color = ok ? "var(--muted)" : "#b00020";
    }

    async function handleFiles(files){
      const arr = Array.from(files || []);
      if(!arr.length) return;

      const room = Math.max(0, 4 - state.images.length);
      if(room <= 0){ showMsg("وصلت إلى الحد الأقصى (4 صور).", false); return; }

      if(arr.length > room){
        showMsg(`سيتم إضافة ${room} صور فقط (الحد 4).`, false);
      }

      for (const file of arr.slice(0, room)){
        if(!file.type.startsWith("image/")){ continue; }
        const compressed = await compressImage(file, 1400, 0.88);
        state.images.push(compressed);
      }
      render();
      showMsg(`تمت إضافة ${Math.min(arr.length, room)} صورة. ✔️`, true);
    }

    // سحب وإفلات
    dropZone.addEventListener("dragover", e => {
      e.preventDefault(); dropZone.style.background = "#f0f6ff"; dropZone.style.borderColor = "var(--brand)";
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.style.background = "#fcfcff"; dropZone.style.borderColor = "var(--border)";
    });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.style.background = "#fcfcff"; dropZone.style.borderColor = "var(--border)";
      handleFiles(e.dataTransfer.files);
    });
    filesInput.addEventListener("change", () => handleFiles(filesInput.files));

    // ---------- توليد PDF ----------
    function getFileName(){
      const n = (state.programName || "تقرير").replace(/[\\/:*?"<>|]/g, "").trim();
      const d = state.date ? new Date(state.date) : new Date();
      const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      return `${n}-${iso}.pdf`;
    }

    async function openAsPdf(){
      // ضبط خيارات PDF (A4 عمودي)
      const opt = {
        margin:       [10, 10, 12, 10], // أعلى، يمين، أسفل، يسار (مم)
        filename:     getFileName(),
        image:        { type: 'jpeg', quality: 0.96 },
        html2canvas:  { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak:    { mode: ['css', 'legacy'] }
      };

      const element = document.getElementById("report");

      // افتح PDF في تبويب جديد بدون تنزيل تلقائي
      await html2pdf().set(opt).from(element).toPdf().get('pdf').then(pdf => {
        const blobUrl = pdf.output('bloburl');
        window.open(blobUrl, '_blank', 'noopener');
      });
    }

    // طباعة مباشرة (باستعمال نافذة الطباعة)
    function printDirect(){
      window.print();
    }

    // ---------- ربط الأحداث ----------
    programName.addEventListener("input", e => { state.programName = e.target.value; render(); });
    dateInput.addEventListener("input", e => { state.date = e.target.value; render(); });
    place.addEventListener("input", e => { state.place = e.target.value; render(); });
    executor.addEventListener("input", e => { state.executor = e.target.value; render(); });
    objectives.addEventListener("input", e => { state.objectives = e.target.value; render(); });

    openPdfBtn.addEventListener("click", async () => {
      // تحقق بسيط
      if(!state.programName.trim()){ alert("من فضلك أدخل اسم البرنامج."); return; }
      if(!state.date){ alert("من فضلك أدخل التاريخ."); return; }
      await openAsPdf();
    });

    printBtn.addEventListener("click", () => {
      if(!state.programName.trim()){ alert("من فضلك أدخل اسم البرنامج."); return; }
      if(!state.date){ alert("من فضلك أدخل التاريخ."); return; }
      printDirect();
    });

    resetBtn.addEventListener("click", () => {
      if(!confirm("هل تريد مسح جميع المدخلات والصور؟")) return;
      Object.assign(state, { programName:"", date:todayISO(), place:"", executor:"", objectives:"", images:[] });
      saveState(); bindInputsToState(); showMsg("");
    });

    // ---------- بدء التشغيل ----------
    (async function init(){
      loadState();
      if(!state.date){ state.date = todayISO(); }
      bindInputsToState();
      // تحميل الديباجة
      setLetterhead(null); // مبدئيًا
      const src = await resolveLetterheadSrc(SCHOOL_HEADER_BASENAME);
      setLetterhead(src);
    })();
  </script>
</body>
</html>
