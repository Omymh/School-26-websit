<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>بوابة التقارير المدرسية</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f9f7; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#006C35; --line:#e0efe7; --accent:#009879; --pill:#123; --radius:16px; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, Tahoma, Arial, sans-serif; background:var(--bg); color:var(--ink) }

    /* ======= واجهة الموقع ======= */
    header.site{ background:linear-gradient(180deg,#0f7a46 0%, #0a5b35 100%); color:#fff }
    .hero{ inline-size:100%; block-size:clamp(120px, 16vw, 180px); background-position:center; background-repeat:no-repeat; background-size:cover; mix-blend:normal; opacity:.95 }
    .page{ max-width:1000px; margin:0 auto; padding:16px }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px }
    .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }
    label{ font-size:14px; color:var(--muted); display:block; margin-bottom:6px }
    input[type="text"],input[type="date"],textarea{ width:100%; border:1px solid var(--line); border-radius:12px; padding:10px 12px; font-size:16px; background:#fff; outline:none }
    textarea{ min-height:110px; resize:vertical }
    input:focus,textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(0,108,53,.12) }

    .uploader-ctrl{ margin-top:8px }
    .uploader{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
    .slot{ border:1px dashed var(--line); border-radius:12px; aspect-ratio:4/3; position:relative; overflow:hidden; background:#f4faf7; display:grid; place-items:center }
    .slot input{ position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer }
    .slot img{ width:100%; height:100%; object-fit:cover }
    .slot .remove{ position:absolute; top:6px; left:6px; background:#ef4444; color:#fff; border:none; border-radius:8px; padding:4px 8px; cursor:pointer; font-weight:800 }

    .bar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .btn{ appearance:none; border:1px solid var(--brand); background:var(--brand); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800 }
    .btn.outline{ background:#fff; color:var(--brand) }

    footer.site{ margin-top:12px; background:#0b3d28; color:#d7f5e4 }
    footer.site .wrap{ max-width:1000px; margin:0 auto; padding:12px 16px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between }
    footer.site .item{ font-weight:800 }

    /* ======= قالب التقرير (مخفي، يظهر فقط وقت التصدير) ======= */
    .report-wrapper{ width:794px; min-height:1123px; margin:16px auto 30px; padding:26px; background:#fff; border:2px solid var(--brand); border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,0.06); position:relative; display:none }
    .report-banner{ height:120px; border-radius:10px; background:linear-gradient(90deg,#0f7a46,#099169); display:grid; place-items:center; margin-bottom:10px; overflow:hidden }
    .report-banner img{ max-height:100%; object-fit:contain }

    /* شريط العناوين */
    .pills{ display:grid; grid-template-columns:1fr; gap:8px; margin:4px 0 12px }
    .pill{ background:#123c2a; color:#e8fff3; padding:10px 16px; border-radius:12px; text-align:center; font-weight:800 }

    /* مربعات الحقول */
    .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
    .grid-2{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px }
    .field{ border:2px solid var(--brand); border-radius:12px; padding:10px; min-height:72px; position:relative; background:#fbfffd }
    .field .title{ position:absolute; top:-12px; inset-inline-start:12px; background:#fff; color:#0b5c35; padding:0 8px; font-weight:800 }
    .field .body{ padding-top:6px; min-height:46px; line-height:1.8 }
    .field .body.empty{ color:transparent } /* تُترك فارغة بصريًا */

    .section-title{ color:#0b5c35; margin:16px 0 6px; font-size:18px; font-weight:800 }

    .witnesses{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:6px }
    .witnesses figure{ margin:0; border:2px solid var(--brand); border-radius:12px; overflow:hidden; aspect-ratio:4/3; display:grid; place-items:center; background:#f3fbf6 }
    .witnesses img{ width:100%; height:100%; object-fit:cover }

    .report-footer{ display:flex; justify-content:space-between; border-top:2px solid var(--brand); padding-top:10px; font-weight:800; margin-top:14px; color:#0b5c35 }

    /* طباعة */
    @page{ size:A4; margin:10mm }
    @media print{ header.site, footer.site, .card, .bar { display:none !important } body{ background:#fff } .report-wrapper{ display:block !important; box-shadow:none; border-width:1px } }
  </style>
</head>
<body>
  <!-- ديباجة الموقع (ثابتة) -->
  <header class="site">
    <div class="hero" id="site-hero" role="img" aria-label="ديباجة المدرسة"></div>
  </header>

  <!-- واجهة الموقع فقط -->
  <main class="page">
    <section class="card">
      <h2 style="margin:0 0 10px;color:#064e2d">بيانات التقرير</h2>
      <div class="grid">
        <div><label>اسم المدرسة</label><input type="text" id="school" placeholder="مثال: مدرسة أسامة بن زيد"></div>
        <div><label>اسم البرنامج</label><input type="text" id="program" placeholder="مثال: مبادرة تعزيز القراءة"></div>
        <div><label>المنفذ</label><input type="text" id="executor" placeholder="مثال: أ. خالد التركي / أ. سلطان الفهد"></div>
        <div><label>المستهدفون</label><input type="text" id="audience" placeholder="مثال: الطلاب"></div>
        <div><label>عدد المستفيدين</label><input type="text" id="beneficiaries" placeholder="مثال: أكثر من 70 طالب"></div>
        <div><label>تاريخ التنفيذ</label><input type="text" id="execdate" placeholder="مثال: 1446/12/12هـ"></div>
        <div><label>مكان التنفيذ</label><input type="text" id="venue" placeholder="مثال: الفصول الدراسية"></div>
        <div style="grid-column:1/-1"><label>الأهداف (كل هدف في سطر)</label><textarea id="goals"></textarea></div>
      </div>

      <div class="uploader-ctrl">
        <label>الشواهد — حد أقصى 4 صور <span id="w-count" class="muted">(0/4)</span></label>
        <div class="uploader" id="uploader"></div>
        <div class="bar">
          <button class="btn outline" id="addImage">إضافة صورة</button>
          <button class="btn outline" id="clearImages">حذف كل الصور</button>
          <button class="btn" id="exportPdfBtn">تصدير PDF</button>
        </div>
      </div>
    </section>
  </main>

  <!-- تذييل الموقع (ثابت) -->
  <footer class="site">
    <div class="wrap">
      <div class="item">مديرة المدرسة: أماني آل عبشان</div>
      <div class="item">تصميم : أ ريم نافل</div>
    </div>
  </footer>

  <!-- قالب التقرير (مخفي — يظهر فقط أثناء التصدير/الطباعة) -->
  <div class="report-wrapper" id="report">
    <div class="report-banner"><img id="reportHeader" alt="ديباجة المدرسة (ثابتة)"></div>

    <!-- شريط العناوين -->
    <div class="pills">
      <div class="pill" id="pillSchool">&nbsp;</div>
      <div class="pill" id="pillProgram">&nbsp;</div>
    </div>

    <!-- مربعات منظمة -->
    <div class="grid-3">
      <div class="field"><div class="title">المنفذ</div><div class="body" id="fExecutor">&nbsp;</div></div>
      <div class="field"><div class="title">المستهدفون</div><div class="body" id="fAudience">&nbsp;</div></div>
      <div class="field"><div class="title">عدد المستفيدين</div><div class="body" id="fBeneficiaries">&nbsp;</div></div>
    </div>

    <div class="grid-2" style="margin-top:12px">
      <div class="field"><div class="title">مكان التنفيذ</div><div class="body" id="fVenue">&nbsp;</div></div>
      <div class="field"><div class="title">تاريخ التنفيذ</div><div class="body" id="fExecdate">&nbsp;</div></div>
    </div>

    <div class="section-title">الأهداف</div>
    <div class="field" style="min-height:160px">
      <div class="body" id="fGoals">&nbsp;</div>
    </div>

    <div class="section-title">الشواهد</div>
    <div class="witnesses" id="vWitnesses">
      <figure></figure><figure></figure><figure></figure><figure></figure>
    </div>

    <div class="report-footer">
      <div>مديرة المدرسة: أماني آل عبشان</div>
      <div>تصميم: أ ريم نافل</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    const $=s=>document.querySelector(s);
    const school=$('#school'); const program=$('#program'); const executor=$('#executor'); const audience=$('#audience'); const beneficiaries=$('#beneficiaries'); const execdate=$('#execdate'); const venue=$('#venue'); const goals=$('#goals');

    const pillSchool=$('#pillSchool'); const pillProgram=$('#pillProgram');
    const fExecutor=$('#fExecutor'), fAudience=$('#fAudience'), fBeneficiaries=$('#fBeneficiaries'), fVenue=$('#fVenue'), fExecdate=$('#fExecdate'), fGoals=$('#fGoals');

    const splitGoals = txt => txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);

    function syncReport(){
      // املأ بدون أي قيم افتراضية — اتركها فارغة إذا لم تُعبَّأ
      pillSchool.innerHTML = school.value.trim() || '&nbsp;';
      pillProgram.innerHTML = program.value.trim() || '&nbsp;';

      fExecutor.innerHTML = executor.value.trim() || '&nbsp;';
      fAudience.innerHTML = audience.value.trim() || '&nbsp;';
      fBeneficiaries.innerHTML = beneficiaries.value.trim() || '&nbsp;';
      fVenue.innerHTML = venue.value.trim() || '&nbsp;';
      fExecdate.innerHTML = execdate.value.trim() || '&nbsp;';

      const lines = splitGoals(goals.value);
      fGoals.innerHTML = lines.length ? `<ol style="margin:0;padding-inline-start:20px">${lines.map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ol>` : '&nbsp;';

      // صور الشواهد (أقصى 4). إن لم توجد صور، تبقى الإطارات فارغة
      const grid=$('#vWitnesses');
      const currentImgs=[...uploader.querySelectorAll('img')].slice(0,4).map(n=>n.src);
      grid.innerHTML='';
      for(let i=0;i<4;i++){
        const fig=document.createElement('figure');
        if(currentImgs[i]){ const im=document.createElement('img'); im.src=currentImgs[i]; fig.appendChild(im); }
        grid.appendChild(fig);
      }
    }

    function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    ;[school,program,executor,audience,beneficiaries,execdate,venue,goals].forEach(i=>i.addEventListener('input',syncReport));

    // ديباجة الموقع وديباجة التقرير (26.*)
    (function(){
      const exts=['webp','png','jpg','jpeg','svg'];
      const hero=$('#site-hero');
      function setHero(url){ hero.style.backgroundImage=`url('${url}')`; }
      (function tryNext(i){ if(i>=exts.length) return; const src=`26.${exts[i]}`; const img=new Image(); img.onload=()=>setHero(src); img.onerror=()=>tryNext(i+1); img.src=src; })(0);
      const rep=$('#reportHeader');
      (function tryNextR(i){ if(i>=exts.length) return; const src=`26.${exts[i]}`; const img=new Image(); img.onload=()=>rep.src=src; img.onerror=()=>tryNextR(i+1); img.src=src; })(0);
    })();

    // رافع الشواهد
    const uploader=$('#uploader'); const countEl=$('#w-count'); const MAX=4;
    function makeSlot(src){ const slot=document.createElement('div'); slot.className='slot';
      const input=document.createElement('input'); input.type='file'; input.accept='image/*';
      const img=document.createElement('img'); if(src) img.src=src;
      const rem=document.createElement('button'); rem.className='remove'; rem.textContent='حذف';
      rem.onclick=()=>{ slot.remove(); persist(); updateCount(); };
      input.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ img.src=ev.target.result; if(!img.isConnected) slot.appendChild(img); persist(); updateCount(); }; r.readAsDataURL(f); };
      slot.appendChild(rem); slot.appendChild(input); if(src) slot.appendChild(img); return slot; }

    function persist(){ const imgs=[...uploader.querySelectorAll('img')].map(i=>i.src); localStorage.setItem('witnesses', JSON.stringify(imgs.slice(0,MAX))); }
    function load(){ const imgs=JSON.parse(localStorage.getItem('witnesses')||'[]'); uploader.innerHTML=''; imgs.slice(0,MAX).forEach(s=>uploader.appendChild(makeSlot(s))); updateCount(); }
    function updateCount(){ const n=uploader.querySelectorAll('img').length; countEl.textContent = `(${n}/${MAX})`; }

    $('#addImage').onclick=()=>{ const n=uploader.querySelectorAll('img').length; if(n>=MAX){ alert('الحد الأقصى 4 صور'); return; } uploader.appendChild(makeSlot()); };
    $('#clearImages').onclick=()=>{ uploader.innerHTML=''; persist(); updateCount(); };
    load();

    // تصدير PDF: اظهار القالب، مزامنة، التقاط، اخفاء
    async function exportPDF(){
      syncReport();
      const report=$('#report');
      const prevDisplay=report.style.display; report.style.display='block';
      const { jsPDF }=window.jspdf;
      const scale=2; const canvas=await html2canvas(report,{scale, useCORS:true, background:'#fff'});
      const img=canvas.toDataURL('image/jpeg',0.95);
      const pdf=new jsPDF('p','mm','a4'); const pageW=pdf.internal.pageSize.getWidth(); const pageH=pdf.internal.pageSize.getHeight();
      const imgW=pageW; const imgH=(canvas.height*imgW)/canvas.width;
      pdf.addImage(img,'JPEG',0,0,imgW,imgH,'','FAST');
      let heightLeft=imgH-pageH; let position=-pageH;
      while(heightLeft>0){ pdf.addPage(); pdf.addImage(img,'JPEG',0,position,imgW,imgH,'','FAST'); heightLeft-=pageH; position-=pageH; }
      pdf.save('school-26-report.pdf');
      report.style.display=prevDisplay||'none';
    }
    $('#exportPdfBtn').addEventListener('click', exportPDF);

    // اختبارات مطوّر بسيطة
    (function devTests(){
      const eq=(a,b)=>JSON.stringify(a)===JSON.stringify(b);
      console.assert(eq(("هدف\nآخر").split(/\n+/), ['هدف','آخر']), 'split baseline');
      console.assert(eq((()=>{const a=splitGoals('أ\n\n ب '); return a;})(), ['أ','ب']), 'splitGoals trims');
      console.assert(typeof exportPDF==='function', 'export bound');
    })();
  </script>
</body>
</html>
