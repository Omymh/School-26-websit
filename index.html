<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام التقارير | يومية • أسبوعية • شهرية</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;800&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
  :root {
    --brand:#006C35; --brand-2:#0A8A4F; --accent:#00A36C; --brand-weak:#E8F4EC;
    --ink:#101315; --muted:#69707D; --bg:#F6F8F7; --card:#FFFFFF; --border:#E3E7EA; --danger:#DA3C3C;
    --radius:14px; --line:1.85; --page-w:920px; --shadow:0 14px 40px rgba(0,0,0,.06);
    --a4-w:210mm; --a4-h:297mm; --paper-pad:12mm;
  }
  html, body { margin:0; background:var(--bg); color:var(--ink); font-family:"Cairo",system-ui,-apple-system,"Segoe UI","Noto Kufi Arabic",Arial,sans-serif; line-height:var(--line);}  

  .site-letterhead { position: sticky; top: 0; z-index: 1000; background:#fff; border-bottom:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,.05);} 
  .site-letterhead .inner { max-width:var(--page-w); margin:0 auto; padding:8px 16px; }
  .site-letterhead img { display:block; margin:0 auto; max-width:100%; height:auto; max-height:140px; }
  .lh-placeholder { text-align:center; color:var(--muted); padding:16px 0; font-weight:700; }

  .container { max-width:var(--page-w); margin:22px auto 44px; padding:0 16px; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }

  .header { padding:16px 18px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; background:linear-gradient(180deg, var(--brand-weak), #fff); border-bottom:1px solid var(--border);} 
  .brand { display:flex; align-items:center; gap:10px; font-weight:800; color:var(--brand-2);} 
  .brand .dot { width:12px; height:12px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 6px rgba(0,108,53,.12);} 
  .tabs { display:flex; gap:8px; flex-wrap:wrap; }
  .tab { border:1px solid var(--border); background:#fff; color:#1f242b; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:800; transition:.2s; }
  .tab:hover { transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08);} 
  .tab.active { background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 6px 16px rgba(0,108,53,.25);} 

  .form { padding:20px; display:grid; gap:16px; }
  .row { display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  @media (max-width:680px){ .row{ grid-template-columns:1fr; } }
  label { font-weight:700; font-size:15px; margin-bottom:6px; color:#273036; display:block; }
  input[type="text"], input[type="date"], textarea { width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; color:var(--ink); font-size:15px; outline:none; transition:border .2s, box-shadow .2s, transform .08s; }
  input:focus, textarea:focus { border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-weak); }
  textarea { min-height:140px; resize:vertical; }
  ::placeholder { color:transparent; }
  .is-invalid { border-color:var(--danger) !important; box-shadow:0 0 0 3px rgba(218,60,60,.15) !important; }

  .upload { border:1.5px dashed var(--border); border-radius:12px; padding:16px; background:#FBFEFC; text-align:center; transition:background .2s, border-color .2s; }
  .upload input { display:none; }
  .thumbs { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .thumb { width:96px; height:72px; border-radius:10px; overflow:hidden; border:1px solid var(--border); background:#f2f6f4; position:relative; }
  .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
  .thumb button { position:absolute; inset-inline-start:4px; inset-block-start:4px; border:0; border-radius:8px; padding:4px 7px; font-size:12px; cursor:pointer; background:rgba(218,60,60,.9); color:#fff; }

  .btn { appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:14px; transition:.12s; }
  .btn:hover { filter:brightness(1.02); transform:translateY(-1px);} 
  .btn-primary { background:linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%); color:#fff; box-shadow:0 8px 22px rgba(0,108,53,.25); }
  .btn-secondary { background:var(--accent); color:#fff; box-shadow:0 8px 18px rgba(0,163,108,.22); }
  .btn-ghost { background:#fff; color:#1e232e; border:1px solid var(--border); }
  .btn-danger { background:var(--danger); color:#fff; }
  .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
  .note { color:var(--muted); font-size:12.5px; }

  .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(6,16,11,.55); z-index:9999; padding:20px; }
  .modal.show { display:flex; }
  .sheet { width:100%; max-width:980px; max-height:90vh; overflow:auto; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:0 22px 70px rgba(0,0,0,.35); transform-origin:center; opacity:0; transform:translateY(14px) scale(.98); transition:opacity .25s, transform .25s; }
  .modal.show .sheet { opacity:1; transform:translateY(0) scale(1); }
  .sheet-head { padding:10px 14px; border-bottom:1px solid var(--border); display:flex; gap:8px; justify-content:space-between; align-items:center; position:sticky; top:0; background:#fff; z-index:2; }
  .sheet-actions { display:flex; gap:8px; flex-wrap:wrap; }
  .sheet-body { padding:18px 20px 24px; }

  .paper { width:var(--a4-w); min-height:var(--a4-h); padding:var(--paper-pad); box-sizing:border-box; margin:0 auto; background:#fff; color:#000; -webkit-print-color-adjust:exact; print-color-adjust:exact; }

  .report .letterhead { display:block; margin:0 0 6mm 0; text-align:center; break-before:avoid-page; page-break-before:auto; }
  .report .title h1 { margin:.5mm 0 4mm; font-size:20pt; line-height:1.35; color:#0a5231; }
  .meta { display:grid; grid-template-columns:1fr 1fr; gap:4mm; margin-bottom:6mm; }
  .meta .field { border:1px solid #e6eaee; border-radius:8px; padding:3mm; background:#fafcfa; }
  .meta .label { font-weight:800; color:#1c3b2b; margin-bottom:1mm; }
  .meta .value { color:#222; }

  .block { margin-bottom:6mm; }
  .block h3 { margin:0 0 2mm; font-size:13pt; color:#0b6a3d; }
  .block ul { margin:0; padding-inline-start:18px; }

  .gallery { display:flex; flex-wrap:wrap; gap:4mm; }
  .gallery figure { width:calc(50% - 2mm); height:60mm; margin:0; border:1px solid #e6eaee; border-radius:8px; overflow:hidden; background:#fff; }
  .gallery img { width:100%; height:100%; object-fit:cover; display:block; }

  .footer { margin-top:8mm; display:flex; justify-content:space-between; color:var(--brand); font-weight:800; }

  .meta, .block, .gallery, .footer, .report .letterhead { break-inside:avoid; page-break-inside:avoid; }

  @media print {
    body > *:not(.print-area) { display:none !important; }
    .modal { display:block !important; background:transparent !important; padding:0 !important; }
    .sheet { box-shadow:none; border:none; max-width:unset; max-height:unset; }
    .sheet-head { display:none; }
    .sheet-body { padding:0; }
    .print-area { display:block; }
    html[dir="rtl"] *, .paper { direction:rtl; text-align:right; }
  }

  @page { size:A4 portrait; margin:0; }
</style>
</head>
<body>

<div class="site-letterhead">
  <div class="inner" id="siteLetterhead">
    <div class="lh-placeholder">سيتم تحميل الديباجة تلقائيًا (ملف باسم <b>26</b> في جذر المستودع).</div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="header">
      <div class="brand"><span class="dot"></span> نظام التقارير</div>
      <nav class="tabs" id="tabs">
        <button class="tab active" data-tab="daily" type="button" aria-pressed="true">تقارير يومية</button>
        <button class="tab" data-tab="weekly" type="button" aria-pressed="false">تقارير أسبوعية</button>
        <button class="tab" data-tab="monthly" type="button" aria-pressed="false">تقارير شهرية</button>
      </nav>
    </div>

    <form class="form" id="form" onsubmit="return false;" novalidate>
      <div>
        <label for="programName">اسم البرنامج</label>
        <input id="programName" type="text" />
      </div>

      <div class="row" id="row-date-one">
        <div>
          <label for="dateOne">التاريخ</label>
          <input id="dateOne" type="date" />
        </div>
        <div>
          <label for="place">مقر التنفيذ</label>
          <input id="place" type="text" />
        </div>
      </div>
      <div class="row" id="row-date-range" style="display:none">
        <div>
          <label for="dateFrom">من تاريخ</label>
          <input id="dateFrom" type="date" />
        </div>
        <div>
          <label for="dateTo">إلى تاريخ</label>
          <input id="dateTo" type="date" />
        </div>
      </div>

      <div>
        <label for="executor">المنفذة</label>
        <input id="executor" type="text" />
      </div>

      <div>
        <label for="audience">الفئة المستهدفة</label>
        <input id="audience" type="text" />
      </div>

      <div>
        <label for="objectives">الأهداف</label>
        <textarea id="objectives"></textarea>
      </div>

      <div>
        <label>الشواهد (حتى 4 صور)</label>
        <div class="upload" id="dropZone" role="button" tabindex="0" aria-label="رفع صور الشواهد">
          <input id="evidenceFiles" type="file" accept="image/*" multiple />
          <label for="evidenceFiles" class="btn btn-ghost">اختيار الصور</label>
          <div class="note" id="uploadMsg">يمكن سحب الصور وإفلاتها هنا. الحد 4 صور.</div>
          <div class="thumbs" id="thumbs" aria-live="polite"></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="downloadBtn" type="button">⬇️ تنزيل PDF</button>
        <button class="btn btn-ghost" id="saveBtn" type="button">💾 حفظ</button>
        <button class="btn btn-danger" id="clearBtn" type="button">مسح البيانات</button>
      </div>
      <div class="note">يتم حفظ النصوص محليًا (LocalStorage)، والصور مؤقتًا (SessionStorage) لتقليل استهلاك الذاكرة.</div>
    </form>
  </div>
</div>

<div class="modal" id="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
    <div class="sheet-head">
      <strong id="dlgTitle">معاينة التقرير</strong>
      <div class="sheet-actions">
        <button class="btn btn-primary" id="dlFromPreviewBtn" type="button">⬇️ تنزيل PDF</button>
        <button class="btn btn-ghost" id="closeModalBtn" type="button">✖️ إغلاق</button>
      </div>
    </div>
    <div class="sheet-body">
      <div id="printArea" class="print-area"></div>
    </div>
  </div>
</div>

<script>
  const SCHOOL_HEADER_BASENAME = "26"; 
  const STORAGE_KEY = "report-suite-pro-v3";
  const IMG_KEY_PREFIX = "report-suite-pro-v3-img-";

  const $ = (sel) => document.querySelector(sel);

  const tabsEl = $("#tabs"), thumbsEl = $("#thumbs"), dropZone = $("#dropZone");
  const filesInput = $("#evidenceFiles"), uploadMsg = $("#uploadMsg");
  const modal = $("#modal"), printArea = $("#printArea"), siteLetterhead = $("#siteLetterhead");

  const programName = $("#programName"), audience = $("#audience"), dateOne = $("#dateOne"), dateFrom = $("#dateFrom"), dateTo = $("#dateTo"), place = $("#place"), executor = $("#executor"), objectives = $("#objectives");
  const rowDateOne = $("#row-date-one"), rowDateRange = $("#row-date-range");

  const downloadBtn = $("#downloadBtn"), dlFromPrev = $("#dlFromPreviewBtn"), closeModalBtn = $("#closeModalBtn"), clearBtn = $("#clearBtn"), saveBtn = $("#saveBtn");

  const blank = () => ({ programName:"", audience:"", dateOne:"", dateFrom:"", dateTo:"", place:"", executor:"", objectives:"" });
  const state = { currentTab:"daily", daily:blank(), weekly:blank(), monthly:blank() };
  const cur = () => state[state.currentTab];
  const imgKey = () => IMG_KEY_PREFIX + state.currentTab;

  function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadAll(){ try{ const
