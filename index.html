<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ูุธุงู ุงูุชูุงุฑูุฑ โข ุชูุงุฑูุฑ ููุฑูุฉ</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* ======================== ุงูุฃููุงุท ุงูุฃุณุงุณูุฉ ======================== */
:root {
  --primary: #006C35;
  --primary-dark: #005B2E;
  --secondary: #27ae60;
  --text-dark: #2c3e50;
  --text-light: #7f8c8d;
  --bg-light: #f7f9fb;
  --bg-card: #ffffff;
  --border-color: #e0e6ed;
  --danger: #e74c3c;
  --radius: 12px;
  --font-tajawal: 'Tajawal', sans-serif;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

* {
  box-sizing: border-box;
}

body {
  font-family: var(--font-tajawal);
  background-color: var(--bg-light);
  color: var(--text-dark);
  margin: 0;
  line-height: 1.6;
  direction: rtl;
  text-align: right;
}

.container {
  max-width: 900px;
  margin: 30px auto;
  padding: 0 15px;
}

.card {
  background-color: var(--bg-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  border: 1px solid var(--border-color);
}

.header {
  padding: 25px;
  background: linear-gradient(to left, var(--primary), var(--secondary));
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.header h1 {
  margin: 0;
  font-size: 2rem;
  font-weight: 800;
  letter-spacing: 1px;
}

.header p {
  margin: 0;
  font-size: 0.9rem;
  opacity: 0.9;
}

.form-body {
  padding: 25px;
  display: grid;
  gap: 20px;
}

.form-group {
  margin-bottom: 0;
}

.form-group label {
  display: block;
  font-weight: 700;
  margin-bottom: 8px;
  font-size: 0.95rem;
  color: var(--text-dark);
}

.form-group input[type="text"],
.form-group input[type="date"],
.form-group textarea {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-family: inherit;
  font-size: 1rem;
  color: var(--text-dark);
  background-color: var(--bg-light);
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
}

.form-group textarea {
  min-height: 120px;
  resize: vertical;
}

/* ======================== ุงูุฃุฒุฑุงุฑ ูุงูุชุญูู ======================== */
.actions {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
}

.btn {
  padding: 12px 25px;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background-color: var(--primary);
  color: #fff;
}

.btn-primary:hover {
  background-color: var(--primary-dark);
  transform: translateY(-2px);
}

.btn-secondary {
  background-color: var(--secondary);
  color: #fff;
}

.btn-secondary:hover {
  background-color: #2ecc71;
  transform: translateY(-2px);
}

.btn-clear {
  background-color: var(--danger);
  color: #fff;
}

.btn-clear:hover {
  background-color: #c0392b;
  transform: translateY(-2px);
}

/* ======================== ุชุจููุจุงุช ุงูุชูุฑูุฑ ======================== */
.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 25px;
  border-bottom: 2px solid var(--border-color);
}

.tab {
  padding: 12px 20px;
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-light);
  background: none;
  border: none;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.3s ease;
}

.tab.active {
  color: var(--primary);
  border-bottom: 2px solid var(--primary);
}

/* ======================== ุชุญููู ุงูุตูุฑ (ุงูุดูุงูุฏ) ======================== */
.upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
  background-color: var(--bg-light);
}

.upload-area input[type="file"] {
  display: none;
}

.upload-area .label-btn {
  display: inline-block;
  padding: 8px 16px;
  background-color: var(--text-dark);
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
}

.thumbs-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 15px;
  justify-content: center;
}

.thumb {
  width: 90px;
  height: 70px;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  border: 1px solid var(--border-color);
  transition: transform 0.2s;
}
.thumb:hover {
    transform: scale(1.05);
}

.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.thumb .remove-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background-color: rgba(0, 0, 0, 0.6);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

/* ======================== ุชูุณูู ูุฑูุฉ ุงูุชูุฑูุฑ PDF ======================== */
.report-paper {
  width: 210mm;
  min-height: 297mm;
  padding: 20mm;
  box-sizing: border-box;
  background: #fff;
  color: #000;
  font-family: var(--font-tajawal);
  display: none; /* ูุฎูู ูู ุงูุนุฑุถ ุงูุนุงุฏู */
}

.report-header {
  text-align: center;
  margin-bottom: 15mm;
}

.report-header img {
  max-width: 100%;
  max-height: 35mm;
  margin-bottom: 5mm;
}

.report-header h2 {
  font-size: 28px;
  margin: 0;
  color: var(--primary-dark);
  font-weight: 800;
}

.report-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10mm;
  margin-bottom: 10mm;
}

.info-item {
  border: 1px solid #ddd;
  padding: 8mm;
  border-radius: 8px;
}

.info-item h4 {
  margin: 0 0 5mm;
  font-size: 16px;
  color: var(--text-light);
  font-weight: 500;
}

.info-item p {
  margin: 0;
  font-size: 15px;
  font-weight: 700;
}

.report-section {
  margin-bottom: 10mm;
}

.report-section h3 {
  font-size: 20px;
  border-right: 4px solid var(--primary);
  padding-right: 10px;
  margin: 0 0 8mm;
  color: var(--primary-dark);
}

.objectives-list {
  padding-right: 25px;
  margin: 0;
}

.objectives-list li {
  margin-bottom: 5px;
}

.gallery-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(45%, 1fr));
  gap: 8mm;
}

.gallery-section figure {
  margin: 0;
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
  aspect-ratio: 4/3;
}

.gallery-section img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.report-footer {
  margin-top: 15mm;
  border-top: 1px solid #ddd;
  padding-top: 5mm;
  display: flex;
  justify-content: space-between;
  font-weight: 500;
  font-size: 14px;
}

/* ======================== ุงูุทุจุงุนุฉ ูุงูุชุญููู ูู PDF ======================== */
@media print {
  body > :not(.report-paper) {
    display: none !important;
  }
  .report-paper {
    display: block !important;
    margin: 0;
    box-shadow: none;
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <div class="header">
      <h1>ูุธุงู ุงูุชูุงุฑูุฑ</h1>
      <p>ููููุฉ โข ุฃุณุจูุนูุฉ โข ุดูุฑูุฉ</p>
    </div>

    <div class="form-body">
      <div class="tabs">
        <button class="tab active" data-tab="daily">ุชูุฑูุฑ ูููู</button>
        <button class="tab" data-tab="weekly">ุชูุฑูุฑ ุฃุณุจูุนู</button>
        <button class="tab" data-tab="monthly">ุชูุฑูุฑ ุดูุฑู</button>
      </div>

      <form id="report-form">
        <div class="form-group">
          <label for="programName">ุงุณู ุงูุจุฑูุงูุฌ</label>
          <input type="text" id="programName" placeholder="ุฃุฏุฎู ุงุณู ุงูุจุฑูุงูุฌ" required>
        </div>
        
        <div class="form-group">
          <label for="audience">ุงููุฆุฉ ุงููุณุชูุฏูุฉ</label>
          <input type="text" id="audience" placeholder="ุฃุฏุฎู ุงููุฆุฉ ุงููุณุชูุฏูุฉ" required>
        </div>
        
        <div id="date-one-group">
          <div class="form-group">
            <label for="dateOne">ุงูุชุงุฑูุฎ</label>
            <input type="date" id="dateOne" required>
          </div>
        </div>
        
        <div id="date-range-group" style="display: none;">
          <div class="form-group">
            <label for="dateFrom">ูู ุชุงุฑูุฎ</label>
            <input type="date" id="dateFrom" required>
          </div>
          <div class="form-group">
            <label for="dateTo">ุฅูู ุชุงุฑูุฎ</label>
            <input type="date" id="dateTo" required>
          </div>
        </div>
        
        <div class="form-group">
          <label for="executor">ุงููููุฐุฉ</label>
          <input type="text" id="executor" placeholder="ุฃุฏุฎู ุงุณู ุงููููุฐุฉ" required>
        </div>
        
        <div class="form-group">
          <label for="objectives">ุงูุฃูุฏุงู (ุณุทุฑ ููู ูุฏู)</label>
          <textarea id="objectives" placeholder="ุงูุชุจ ุฃูุฏุงู ุงูุชูุฑูุฑ..."></textarea>
        </div>

        <div class="form-group">
          <label>ุงูุดูุงูุฏ (ุตูุฑ)</label>
          <div class="upload-area" id="upload-area">
            <input type="file" id="image-upload" accept="image/*" multiple>
            <label for="image-upload" class="label-btn">ุงุฎุชุฑ ุงูุตูุฑ</label>
            <p style="font-size: 0.9em; color: var(--text-light); margin: 10px 0 0;">ูููู ุณุญุจ ุงูุตูุฑ ูุฅููุงุชูุง ููุง. ุงูุญุฏ ุงูุฃูุตู 4 ุตูุฑ.</p>
            <div class="thumbs-container" id="thumbs-container"></div>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-secondary" id="preview-btn">๐๏ธโ๐จ๏ธ ูุนุงููุฉ</button>
          <button type="button" class="btn btn-primary" id="download-btn">โฌ๏ธ ุชูุฒูู PDF</button>
          <button type="button" class="btn btn-clear" id="clear-btn">๐งน ูุณุญ ุงูุจูุงูุงุช</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="report-paper" id="report-paper"></div>

<script>
// ==================== ูุชุบูุฑุงุช ุงูุญุงูุฉ ูุงูุชุฎุฒูู ====================
const state = {
  currentTab: 'daily',
  daily: { programName: '', audience: '', dateOne: '', executor: '', objectives: '', images: [] },
  weekly: { programName: '', audience: '', dateFrom: '', dateTo: '', executor: '', objectives: '', images: [] },
  monthly: { programName: '', audience: '', dateFrom: '', dateTo: '', executor: '', objectives: '', images: [] },
};

const saveState = () => localStorage.setItem('report_data', JSON.stringify(state));
const loadState = () => {
  try {
    const data = JSON.parse(localStorage.getItem('report_data'));
    if (data) {
      Object.keys(data).forEach(key => {
        if (state[key]) {
          Object.assign(state[key], data[key]);
        }
      });
      state.currentTab = data.currentTab || 'daily';
    }
  } catch (e) {
    console.error('Failed to load data:', e);
  }
};

// ==================== ุนูุงุตุฑ DOM ====================
const $ = selector => document.querySelector(selector);
const $$ = selector => document.querySelectorAll(selector);

const form = $('#report-form');
const tabsContainer = $('.tabs');
const reportPaper = $('#report-paper');
const thumbsContainer = $('#thumbs-container');
const imageUpload = $('#image-upload');
const dateOneGroup = $('#date-one-group');
const dateRangeGroup = $('#date-range-group');

// ==================== ูุธุงุฆู ุงููุงุฌูุฉ ====================
const updateForm = () => {
  const currentData = state[state.currentTab];
  for (const key in currentData) {
    const el = $(`#${key}`);
    if (el) el.value = currentData[key];
  }
  updateThumbs(currentData.images);
  updateDateInputs();
};

const updateDateInputs = () => {
  const isDaily = state.currentTab === 'daily';
  dateOneGroup.style.display = isDaily ? 'block' : 'none';
  dateRangeGroup.style.display = isDaily ? 'none' : 'grid';
  $$('input[type="date"]').forEach(el => el.required = !isDaily);
  if (!isDaily) $('#dateFrom').required = true;
};

const updateThumbs = (images) => {
  thumbsContainer.innerHTML = '';
  images.forEach((imgSrc, index) => {
    const thumbDiv = document.createElement('div');
    thumbDiv.className = 'thumb';
    thumbDiv.innerHTML = `<img src="${imgSrc}" alt="ุตูุฑุฉ ${index + 1}"><button type="button" class="remove-btn" data-index="${index}">ร</button>`;
    thumbsContainer.appendChild(thumbDiv);
  });
};

const switchTab = (tabName) => {
  state.currentTab = tabName;
  $$('.tab').forEach(tab => tab.classList.remove('active'));
  $(`.tab[data-tab="${tabName}"]`).classList.add('active');
  updateForm();
  saveState();
};

// ==================== ูุนุงูุฌุฉ ุงูุตูุฑ ====================
const handleImageUpload = (files) => {
  const currentImages = state[state.currentTab].images;
  const newImages = Array.from(files).slice(0, 4 - currentImages.length);
  newImages.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      currentImages.push(e.target.result);
      updateThumbs(currentImages);
      saveState();
    };
    reader.readAsDataURL(file);
  });
};

const removeImage = (index) => {
  state[state.currentTab].images.splice(index, 1);
  updateThumbs(state[state.currentTab].images);
  saveState();
};

// ==================== ุชูููุฏ ุงูุชูุฑูุฑ ====================
const generateReportHTML = () => {
  const data = state[state.currentTab];
  const dateText = state.currentTab === 'daily' ? (data.dateOne || '-') : `${data.dateFrom || '-'} ุฅูู ${data.dateTo || '-'}`;
  const imagesHTML = data.images.map(img => `<figure><img src="${img}" alt="ุดุงูุฏ"></figure>`).join('');
  const objectivesHTML = data.objectives.split('\n').filter(o => o.trim()).map(o => `<li>${o.trim()}</li>`).join('');

  return `
    <div class="report-header">
      <img src="https://via.placeholder.com/600x120.png?text=LOGO" alt="ุดุนุงุฑ">
      <h2>${state.currentTab === 'daily' ? 'ุชูุฑูุฑ ูููู' : (state.currentTab === 'weekly' ? 'ุชูุฑูุฑ ุฃุณุจูุนู' : 'ุชูุฑูุฑ ุดูุฑู')}</h2>
    </div>
    <div class="report-info">
      <div class="info-item"><h4>ุงุณู ุงูุจุฑูุงูุฌ</h4><p>${data.programName || '-'}</p></div>
      <div class="info-item"><h4>ุงููุฆุฉ ุงููุณุชูุฏูุฉ</h4><p>${data.audience || '-'}</p></div>
      <div class="info-item"><h4>ุงูุชุงุฑูุฎ</h4><p>${dateText}</p></div>
      <div class="info-item"><h4>ุงููููุฐุฉ</h4><p>${data.executor || '-'}</p></div>
    </div>
    <div class="report-section">
      <h3>ุงูุฃูุฏุงู</h3>
      <ul class="objectives-list">${objectivesHTML || '<li>ูุง ุชูุฌุฏ ุฃูุฏุงู ููุฏุฎูุฉ.</li>'}</ul>
    </div>
    <div class="report-section">
      <h3>ุงูุดูุงูุฏ</h3>
      <div class="gallery-section">${imagesHTML || 'ูุง ุชูุฌุฏ ุดูุงูุฏ ูุฑููุฉ.'}</div>
    </div>
    <div class="report-footer">
      <span>ุชูููุน ุงููููุฐุฉ: ........................</span>
      <span>${new Date().toLocaleDateString('ar-SA')}</span>
    </div>
  `;
};

const handleGeneratePDF = async () => {
  const reportHtml = generateReportHTML();
  reportPaper.innerHTML = reportHtml;

  // Wait for all images to load
  const images = reportPaper.querySelectorAll('img');
  const imagePromises = Array.from(images).map(img => new Promise(resolve => {
    if (img.complete) {
      resolve();
    } else {
      img.onload = resolve;
      img.onerror = resolve; // Continue even if an image fails to load
    }
  }));
  await Promise.all(imagePromises);

  // Generate PDF
  const options = {
    margin: 1,
    filename: `ุชูุฑูุฑ-${state[state.currentTab].programName || 'ุฌุฏูุฏ'}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(options).from(reportPaper).save();
};

const handlePreview = () => {
    const reportHtml = generateReportHTML();
    const newWindow = window.open('', '_blank');
    newWindow.document.write(`
        <html>
        <head>
            <title>ูุนุงููุฉ ุงูุชูุฑูุฑ</title>
            <style>${document.querySelector('style').textContent}</style>
            <style>
                body { background-color: #f0f0f0; display: flex; justify-content: center; padding: 20px; }
                .report-paper { display: block !important; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
            </style>
        </head>
        <body>
            <div class="report-paper">
                ${reportHtml}
            </div>
        </body>
        </html>
    `);
    newWindow.document.close();
};

// ==================== ุชููุฆุฉ ุงูุฃุญุฏุงุซ ====================
const init = () => {
  loadState();
  switchTab(state.currentTab);

  tabsContainer.addEventListener('click', (e) => {
    const tab = e.target.closest('.tab');
    if (tab) switchTab(tab.dataset.tab);
  });

  form.addEventListener('input', (e) => {
    const target = e.target;
    const currentData = state[state.currentTab];
    if (currentData.hasOwnProperty(target.id)) {
      currentData[target.id] = target.value;
      saveState();
    }
  });
  
  thumbsContainer.addEventListener('click', (e) => {
    const removeBtn = e.target.closest('.remove-btn');
    if (removeBtn) {
      const index = parseInt(removeBtn.dataset.index, 10);
      removeImage(index);
    }
  });

  imageUpload.addEventListener('change', (e) => handleImageUpload(e.target.files));

  $('#upload-area').addEventListener('dragover', (e) => e.preventDefault());
  $('#upload-area').addEventListener('drop', (e) => {
    e.preventDefault();
    handleImageUpload(e.dataTransfer.files);
  });

  $('#preview-btn').addEventListener('click', handlePreview);
  $('#download-btn').addEventListener('click', handleGeneratePDF);
  $('#clear-btn').addEventListener('click', () => {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุฌููุน ุงูุจูุงูุงุชุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.')) {
      localStorage.removeItem('report_data');
      location.reload();
    }
  });
};

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
