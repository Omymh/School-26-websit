<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>بوابة التقارير المدرسية</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f9f7; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#006C35; --line:#e5efe7; --accent:#009879; --radius:16px; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, Tahoma, Arial, sans-serif; background:var(--bg); color:var(--ink) }

    /* ======= موقع (واجهة فقط) ======= */
    header.site{ background:var(--card); border-bottom:1px solid var(--line); position:relative }
    .hero{ inline-size:100%; block-size:clamp(100px, 14vw, 170px); background-position:center; background-repeat:no-repeat; background-size:cover }
    .page{ max-width:1000px; margin:0 auto; padding:16px }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px }
    .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }
    label{ font-size:14px; color:var(--muted); display:block; margin-bottom:6px }
    input[type="text"],input[type="date"],textarea{ width:100%; border:1px solid var(--line); border-radius:12px; padding:10px 12px; font-size:16px; background:#fff; outline:none }
    textarea{ min-height:110px; resize:vertical }
    input:focus,textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(0,108,53,.12) }

    .uploader-ctrl{ margin-top:8px }
    .uploader{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
    .slot{ border:1px dashed var(--line); border-radius:12px; aspect-ratio:4/3; position:relative; overflow:hidden; background:#f4faf7; display:grid; place-items:center }
    .slot input{ position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer }
    .slot img{ width:100%; height:100%; object-fit:cover }
    .slot .remove{ position:absolute; top:6px; left:6px; background:#ef4444; color:#fff; border:none; border-radius:8px; padding:4px 8px; cursor:pointer; font-weight:800 }

    .bar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .btn{ appearance:none; border:1px solid var(--brand); background:var(--brand); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800 }
    .btn.outline{ background:#fff; color:var(--brand) }

    footer.site{ margin-top:12px; background:var(--card); border-top:1px solid var(--line) }
    footer.site .wrap{ max-width:1000px; margin:0 auto; padding:12px 16px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between }
    footer.site .item{ font-weight:800 }

    /* ======= التقرير (مخفي عن الموقع ويظهر فقط عند التصدير) ======= */
    .report-wrapper{ width:794px; min-height:1123px; margin:16px auto 30px; padding:32px; background:#fff; border:2px solid var(--brand); border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.06); position:relative; display:none }
    .report-banner{ text-align:center; margin-bottom:14px }
    .report-banner img{ max-width:100%; height:auto }
    h1.report-title{ text-align:center; color:var(--brand); margin:10px 0 18px; font-size:24px }
    .meta{ margin-bottom:14px }
    .meta-row{ display:grid; grid-template-columns:160px 1fr; gap:10px; padding:8px 0; border-bottom:1px solid #e5e5e5 }
    .meta-row .key{ font-weight:800; color:var(--brand) }
    .objectives ul{ list-style:disc; padding-right:20px; margin:10px 0 14px }
    .section-title{ color:var(--brand); margin:8px 0 6px; font-size:18px }
    .witnesses{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:16px }
    .witnesses figure{ margin:0; border:1px solid #e5e5e5; border-radius:10px; overflow:hidden; aspect-ratio:4/3; display:grid; place-items:center; background:#f4f6f5 }
    .witnesses img{ width:100%; height:100%; object-fit:cover }
    .report-footer{ display:flex; justify-content:space-between; border-top:2px solid var(--brand); padding-top:10px; font-weight:800; margin-top:16px }

    /* طباعة */
    @page{ size:A4; margin:10mm }
    @media print{ header.site, footer.site, .card, .bar { display:none !important } body{ background:#fff } .report-wrapper{ display:block !important; box-shadow:none; border-width:1px } }
  </style>
</head>
<body>
  <!-- ديباجة الموقع (ثابتة في الواجهة) -->
  <header class="site">
    <div class="hero" id="site-hero" role="img" aria-label="ديباجة المدرسة"></div>
  </header>

  <!-- واجهة الموقع فقط -->
  <main class="page">
    <section class="card">
      <h2 style="margin:0 0 10px;color:#064e2d">بيانات التقرير</h2>
      <div class="grid">
        <div><label>اسم البرنامج</label><input type="text" id="program" placeholder="مثال: مبادرة تعزيز القراءة"></div>
        <div><label>التاريخ</label><input type="date" id="date"></div>
        <div><label>مقر التنفيذ</label><input type="text" id="venue" placeholder="مثال: مسرح المدرسة / قاعة النشاط"></div>
        <div><label>المنفذة</label><input type="text" id="owner" placeholder="مثال: أ. نورة الحربي"></div>
        <div style="grid-column:1/-1"><label>الأهداف (كل هدف في سطر)</label><textarea id="goals"></textarea></div>
      </div>

      <div class="uploader-ctrl">
        <label>الشواهد — حد أقصى 4 صور <span id="w-count" class="muted">(0/4)</span></label>
        <div class="uploader" id="uploader"></div>
        <div class="bar">
          <button class="btn outline" id="addImage">إضافة صورة</button>
          <button class="btn outline" id="clearImages">حذف كل الصور</button>
          <button class="btn" id="exportPdfBtn">تصدير PDF</button>
        </div>
      </div>
    </section>
  </main>

  <!-- تذييل الموقع (ثابت في الواجهة) -->
  <footer class="site">
    <div class="wrap">
      <div class="item">مديرة المدرسة: أماني آل عبشان</div>
      <div class="item">تصميم : أ ريم نافل</div>
    </div>
  </footer>

  <!-- قالب التقرير (مخفي — يظهر فقط أثناء التصدير/الطباعة) -->
  <div class="report-wrapper" id="report">
    <div class="report-banner"><img id="reportHeader" alt="ديباجة المدرسة (ثابتة في التقرير)"></div>
    <h1 class="report-title">تقرير برنامج</h1>
    <div class="meta">
      <div class="meta-row"><div class="key">اسم البرنامج:</div><div id="vProgram">—</div></div>
      <div class="meta-row"><div class="key">التاريخ:</div><div id="vDate">—</div></div>
      <div class="meta-row"><div class="key">مقر التنفيذ:</div><div id="vVenue">—</div></div>
      <div class="meta-row"><div class="key">المنفذة:</div><div id="vOwner">—</div></div>
    </div>
    <div class="objectives">
      <h2 class="section-title">الأهداف</h2>
      <ul id="vGoals"><li>—</li></ul>
    </div>
    <h2 class="section-title">الشواهد (صور)</h2>
    <div class="witnesses" id="vWitnesses"></div>
    <div class="report-footer">
      <div>مديرة المدرسة: أماني آل عبشان</div>
      <div>تصميم: أ ريم نافل</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    const $=s=>document.querySelector(s);
    const program=$('#program'); const date=$('#date'); const venue=$('#venue'); const owner=$('#owner'); const goals=$('#goals');
    const vProgram=$('#vProgram'); const vDate=$('#vDate'); const vVenue=$('#vVenue'); const vOwner=$('#vOwner'); const vGoals=$('#vGoals');

    function formatDate(iso){ if(!iso) return '—'; try{ return new Intl.DateTimeFormat('ar-SA',{year:'numeric',month:'long',day:'numeric'}).format(new Date(iso+'T00:00:00')); }catch{ return iso } }
    const splitGoals = txt => txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);

    function syncReport(){
      vProgram.textContent = program.value.trim()||'—';
      vDate.textContent = formatDate(date.value);
      vVenue.textContent = venue.value.trim()||'—';
      vOwner.textContent = owner.value.trim()||'—';
      const lines = splitGoals(goals.value);
      vGoals.innerHTML = lines.length ? lines.map(s=>`<li>${escapeHTML(s)}</li>`).join('') : '<li>—</li>';
      // صور الشواهد
      const grid=$('#vWitnesses'); grid.innerHTML='';
      [...uploader.querySelectorAll('img')].slice(0,4).forEach(src=>{ const fig=document.createElement('figure'); const im=document.createElement('img'); im.src=src.src; fig.appendChild(im); grid.appendChild(fig); });
    }
    function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    [program,date,venue,owner,goals].forEach(i=>i.addEventListener('input',syncReport));

    // ===== ديباجة الموقع والتقرير من 26.* أو باراميتر =====
    (function(){
      const exts=['webp','png','jpg','jpeg','svg'];
      // موقع (hero)
      const hero=$('#site-hero');
      const qpHero=new URLSearchParams(location.search).get('dibajah');
      const savedHero=localStorage.getItem('dibajah_img_bg');
      function setHero(url){ hero.style.backgroundImage=`url('${url}')`; }
      if(savedHero) setHero(savedHero); else if(qpHero) setHero(qpHero); else {
        (function tryNext(i){ if(i>=exts.length) return; const src=`26.${exts[i]}`; const img=new Image(); img.onload=()=>setHero(src); img.onerror=()=>tryNext(i+1); img.src=src; })(0);
      }
      // تقرير (صورة في الأعلى ثابتة)
      const rep=$('#reportHeader');
      (function tryNextR(i){ if(i>=exts.length) return; const src=`26.${exts[i]}`; const img=new Image(); img.onload=()=>rep.src=src; img.onerror=()=>tryNextR(i+1); img.src=src; })(0);
    })();

    // ===== رافع الشواهد (حد أقصى 4) =====
    const uploader=$('#uploader'); const countEl=$('#w-count'); const MAX=4;
    function makeSlot(src){ const slot=document.createElement('div'); slot.className='slot';
      const input=document.createElement('input'); input.type='file'; input.accept='image/*';
      const img=document.createElement('img'); if(src) img.src=src;
      const rem=document.createElement('button'); rem.className='remove'; rem.textContent='حذف';
      rem.onclick=()=>{ slot.remove(); persist(); updateCount(); };
      input.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ img.src=ev.target.result; if(!img.isConnected) slot.appendChild(img); persist(); updateCount(); }; r.readAsDataURL(f); };
      slot.appendChild(rem); slot.appendChild(input); if(src) slot.appendChild(img); return slot; }

    function persist(){ const imgs=[...uploader.querySelectorAll('img')].map(i=>i.src); localStorage.setItem('witnesses', JSON.stringify(imgs.slice(0,MAX))); }
    function load(){ const imgs=JSON.parse(localStorage.getItem('witnesses')||'[]'); uploader.innerHTML=''; imgs.slice(0,MAX).forEach(s=>uploader.appendChild(makeSlot(s))); updateCount(); }
    function updateCount(){ const n=uploader.querySelectorAll('img').length; countEl.textContent = `(${n}/${MAX})`; }

    $('#addImage').onclick=()=>{ const n=uploader.querySelectorAll('img').length; if(n>=MAX){ alert('الحد الأقصى 4 صور'); return; } uploader.appendChild(makeSlot()); };
    $('#clearImages').onclick=()=>{ uploader.innerHTML=''; persist(); updateCount(); };
    load();

    // ===== تصدير PDF: يُظهر التقرير مؤقتًا ثم يُخفيه =====
    async function exportPDF(){
      // مزامنة البيانات إلى قالب التقرير
      syncReport();
      const report=$('#report');
      const { jsPDF }=window.jspdf;
      // إظهار التقرير مؤقتًا (بدون تغييره في الموقع)
      const prevDisplay=report.style.display; report.style.display='block';
      // التقاط
      const scale=2; const canvas=await html2canvas(report,{scale, useCORS:true, background:'#fff'});
      const img=canvas.toDataURL('image/jpeg',0.95);
      const pdf=new jsPDF('p','mm','a4'); const pageW=pdf.internal.pageSize.getWidth(); const pageH=pdf.internal.pageSize.getHeight();
      const imgW=pageW; const imgH=(canvas.height*imgW)/canvas.width;
      pdf.addImage(img,'JPEG',0,0,imgW,imgH,'','FAST');
      let heightLeft=imgH-pageH; let position=-pageH;
      while(heightLeft>0){ pdf.addPage(); pdf.addImage(img,'JPEG',0,position,imgW,imgH,'','FAST'); heightLeft-=pageH; position-=pageH; }
      pdf.save('school-26-report.pdf');
      // إخفاء من جديد
      report.style.display=prevDisplay || 'none';
    }
    $('#exportPdfBtn').addEventListener('click', exportPDF);

    // ===== اختبارات بسيطة (Console) =====
    (function devTests(){
      const eq=(a,b)=>JSON.stringify(a)===JSON.stringify(b);
      console.assert(eq(splitGoals('هدف ١\nهدف ٢'), ['هدف ١','هدف ٢']), 'splitGoals basic');
      console.assert(eq(splitGoals('a\n\n b '), ['a','b']), 'splitGoals trims/empties');
      console.assert(eq(splitGoals('x\r\ny'), ['x','y']), 'splitGoals CRLF');
      console.assert(typeof exportPDF === 'function', 'export button bound');
      console.log('[tests] ok');
    })();
  </script>
</body>
</html>
