<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>بوابة التقارير المدرسية</title>
  <!-- الخط -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#1e40af; --line:#e5e7eb; --accent:#0ea5e9; --radius:16px; --hero-h: clamp(100px, 14vw, 170px); }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:'Almarai', system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Kufi Arabic', 'Noto Naskh Arabic', Tahoma, Arial, sans-serif; background:var(--bg); color:var(--ink) }

    /* Header as background banner (no gaps) */
    header{ background:var(--card); border-bottom:1px solid var(--line); position:relative; margin:0; padding:0 }
    .hero{ inline-size:100%; block-size:var(--hero-h); background-position:center; background-repeat:no-repeat; background-size:cover; margin:0 }
    .dibajah-actions{ position:absolute; inset-inline-end:8px; top:8px; display:flex; gap:8px; align-items:center; background:rgba(255,255,255,.75); backdrop-filter:blur(3px); padding:4px 6px; border-radius:10px; border:1px solid var(--line) }

    /* Page */
    .page{ max-width:1100px; margin:0 auto; padding:12px 16px 16px 16px }

    /* Tabs */
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin:0 0 8px 0 }
    .tab{ appearance:none; border:1px solid var(--line); background:var(--card); padding:10px 16px; border-radius:999px; cursor:pointer; font-weight:800; color:var(--ink) }
    .tab[aria-selected="true"]{ background:var(--brand); color:#fff; border-color:var(--brand); box-shadow:0 1px 0 rgba(0,0,0,.02), 0 4px 8px rgba(30,64,175,.08) }

    /* Card & inputs */
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px; box-shadow:0 1px 0 rgba(0,0,0,.02) }
    .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }
    label{ font-size:14px; color:var(--muted); display:block; margin-bottom:6px }
    input[type="text"],input[type="date"],input[type="number"],select,textarea{ width:100%; border:1px solid var(--line); border-radius:12px; padding:10px 12px; font-size:16px; background:#fff; outline:none }
    input:focus,textarea:focus,select:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(14,165,233,.15) }
    textarea{ min-height:110px; resize:vertical }

    .section-title{ margin:16px 0 8px; font-size:18px; font-weight:800 }

    .bar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .btn{ appearance:none; border:1px solid var(--line); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800 }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
    .muted{ color:var(--muted) }

    /* Dynamic uploader */
    .uploader{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px }
    @media (max-width:720px){ .uploader{ grid-template-columns:repeat(2,1fr) } }
    .slot{ border:1px dashed var(--line); border-radius:12px; min-height:120px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; background:#fafafa }
    .slot input{ position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer }
    .slot img{ max-width:100%; max-height:100%; object-fit:cover }
    .slot .remove{ position:absolute; top:6px; left:6px; background:#ef4444; color:#fff; border:none; border-radius:8px; padding:4px 8px; cursor:pointer; font-weight:800 }

    /* Footer */
    footer{ margin-top:12px; background:var(--card); border-top:1px solid var(--line) }
    footer .wrap{ max-width:1100px; margin:0 auto; padding:12px 16px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between }
    footer .item{ font-weight:800 }

    /* Print: hide controls completely */
    @media print{
      .tabs,.bar,footer,.dibajah-actions, .slot .remove, .slot input, #dibajah-btn, #dibajah-file{ display:none !important }
      body{ background:#fff }
      .card{ border:0 }
      header{ border:0 }
    }
  </style>
</head>
<body>
  <!-- ديباجة كبانر خلفية: لا فراغات إضافية -->
  <header>
    <div class="hero" id="dibajah-bg" role="img" aria-label="ديباجة المدرسة"></div>
    <div class="dibajah-actions">
      <button class="btn" id="dibajah-btn">تغيير صورة الديباجة</button>
      <input type="file" id="dibajah-file" accept="image/*" hidden>
    </div>
  </header>

  <main class="page">
    <div class="tabs" role="tablist">
      <button class="tab" id="tab-daily" role="tab" aria-controls="panel-daily" aria-selected="true">التقرير اليومي</button>
      <button class="tab" id="tab-weekly" role="tab" aria-controls="panel-weekly" aria-selected="false">التقرير الأسبوعي</button>
      <button class="tab" id="tab-monthly" role="tab" aria-controls="panel-monthly" aria-selected="false">التقرير الشهري</button>
    </div>

    <!-- اليومي -->
    <section id="panel-daily" class="card" role="tabpanel" aria-labelledby="tab-daily">
      <div class="grid">
        <div><label>إدارة التعليم</label><input type="text" data-k="d_admin"></div>
        <div><label>اسم المدرسة</label><input type="text" data-k="d_school"></div>
        <div><label>اسم المعلمة</label><input type="text" data-k="d_teacher"></div>
        <div><label>التخصص</label><input type="text" data-k="d_major"></div>
        <div><label>الفصل الدراسي</label><input type="text" data-k="d_term"></div>
        <div><label>الصف</label><input type="text" data-k="d_grade"></div>
        <div><label>الوحدة الدراسية</label><input type="text" data-k="d_unit"></div>
        <div><label>عنوان الدرس</label><input type="text" data-k="d_title"></div>
        <div><label>التاريخ</label><input type="date" data-k="d_date"></div>
        <div><label>الحصة</label><input type="text" data-k="d_period"></div>
      </div>

      <div class="section-title">أهداف الدرس</div>
      <textarea data-k="d_goals"></textarea>

      <div class="section-title">نسبة تحقق أهداف الدرس</div>
      <input type="number" min="0" max="100" step="1" placeholder="%" data-k="d_achv">

      <div class="section-title">ملاحظات حول تفاعل الطالبات</div>
      <textarea data-k="d_notes"></textarea>

      <div class="section-title">التحديات الصفية</div>
      <textarea data-k="d_challenges"></textarea>

      <div class="section-title">رفع صور <span class="muted" id="d-count">عدد الصور: 0</span></div>
      <div class="uploader" id="d-uploader"></div>
      <div class="bar">
        <button class="btn" data-add="d">إضافة صورة</button>
        <button class="btn" data-clear="d">حذف كل الصور</button>
      </div>

      <div class="bar">
        <button class="btn primary" onclick="printSection('panel-daily')">طباعة التقرير اليومي</button>
        <button class="btn" onclick="clearSection('daily')">حذف البيانات</button>
      </div>
    </section>

    <!-- الأسبوعي -->
    <section id="panel-weekly" class="card" role="tabpanel" aria-labelledby="tab-weekly" hidden>
      <div class="grid">
        <div><label>إدارة التعليم</label><input type="text" data-k="w_admin"></div>
        <div><label>اسم المدرسة</label><input type="text" data-k="w_school"></div>
        <div><label>اسم المعلمة</label><input type="text" data-k="w_teacher"></div>
        <div><label>التخصص</label><input type="text" data-k="w_major"></div>
        <div><label>الفصل الدراسي</label><input type="text" data-k="w_term"></div>
        <div><label>الصف</label><input type="text" data-k="w_grade"></div>
        <div><label>الأسبوع</label><input type="text" data-k="w_week"></div>
        <div><label>التاريخ</label><input type="date" data-k="w_date"></div>
      </div>

      <div class="section-title">أهم الدروس المنفذة</div>
      <textarea data-k="w_lessons"></textarea>

      <div class="section-title">أبرز نقاط القوة لدى الطالبات</div>
      <textarea data-k="w_strengths"></textarea>

      <div class="section-title">أبرز نقاط الضعف لدى الطالبات</div>
      <textarea data-k="w_weaknesses"></textarea>

      <div class="section-title">أبرز التحديات التعليمية</div>
      <textarea data-k="w_challenges"></textarea>

      <div class="section-title">الإجراءات العلاجية</div>
      <textarea data-k="w_actions"></textarea>

      <div class="section-title">أثر الإجراءات على تقدم الطالبات</div>
      <textarea data-k="w_impact"></textarea>

      <div class="section-title">توصيات الأسبوع القادم</div>
      <textarea data-k="w_next"></textarea>

      <div class="section-title">رفع صور <span class="muted" id="w-count">عدد الصور: 0</span></div>
      <div class="uploader" id="w-uploader"></div>
      <div class="bar">
        <button class="btn" data-add="w">إضافة صورة</button>
        <button class="btn" data-clear="w">حذف كل الصور</button>
      </div>

      <div class="bar">
        <button class="btn primary" onclick="printSection('panel-weekly')">طباعة التقرير الأسبوعي</button>
        <button class="btn" onclick="clearSection('weekly')">حذف البيانات</button>
      </div>
    </section>

    <!-- الشهري -->
    <section id="panel-monthly" class="card" role="tabpanel" aria-labelledby="tab-monthly" hidden>
      <div class="grid">
        <div><label>إدارة التعليم</label><input type="text" data-k="m_admin"></div>
        <div><label>اسم المدرسة</label><input type="text" data-k="m_school"></div>
        <div><label>اسم المعلمة</label><input type="text" data-k="m_teacher"></div>
        <div><label>التخصص</label><input type="text" data-k="m_major"></div>
        <div><label>الفصل الدراسي</label><input type="text" data-k="m_term"></div>
        <div><label>الصف</label><input type="text" data-k="m_grade"></div>
        <div><label>الشهر</label><input type="text" data-k="m_month"></div>
        <div><label>التاريخ</label><input type="date" data-k="m_date"></div>
      </div>

      <div class="section-title">نسبة إنجاز الخطة</div>
      <input type="number" min="0" max="100" step="1" placeholder="%" data-k="m_progress">

      <div class="section-title">أبرز التحسينات في أداء الطالبات</div>
      <textarea data-k="m_improvements"></textarea>

      <div class="section-title">القضايا المستمرة التي تحتاج متابعة</div>
      <textarea data-k="m_issues"></textarea>

      <div class="section-title">خطط المعالجة المقترحة</div>
      <textarea data-k="m_plans"></textarea>

      <div class="section-title">الطالبات المتميزات</div>
      <textarea data-k="m_top"></textarea>

      <div class="section-title">الخطة الإثرائية للطالبات المتميزات</div>
      <textarea data-k="m_enrich"></textarea>

      <div class="section-title">الطالبات المخفقات</div>
      <textarea data-k="m_low"></textarea>

      <div class="section-title">الخطة العلاجية للطالبات المخفقات</div>
      <textarea data-k="m_remedial"></textarea>

      <div class="section-title">رفع صور <span class="muted" id="m-count">عدد الصور: 0</span></div>
      <div class="uploader" id="m-uploader"></div>
      <div class="bar">
        <button class="btn" data-add="m">إضافة صورة</button>
        <button class="btn" data-clear="m">حذف كل الصور</button>
      </div>

      <div class="bar">
        <button class="btn primary" onclick="printSection('panel-monthly')">طباعة التقرير الشهري</button>
        <button class="btn" onclick="clearSection('monthly')">حذف البيانات</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <div class="item">مديرة المدرسة: أماني آل عبشان</div>
      <div class="item">تصميم : أ ريم نافل</div>
    </div>
  </footer>

  <script>
    const MAX_IMAGES = 20; // غيّريه لو تبين
    // ديباجة كبانر خلفية مع تحكم بالارتفاع (?dh=150)
    (function(){
      const hero = document.getElementById('dibajah-bg');
      const dh = parseInt(new URLSearchParams(location.search).get('dh'), 10);
      if(!isNaN(dh) && dh>60) hero.style.blockSize = dh + 'px';

      function setHero(url){ hero.style.backgroundImage = `url('${url}')`; }
      const saved = localStorage.getItem('dibajah_img_bg');
      const qp = new URLSearchParams(location.search).get('dibajah');

      if(saved) setHero(saved);
      else if(qp) setHero(qp);
      else{
        const base='26', exts=['.webp','.png','.jpg','.jpeg'];
        (function tryNext(i){
          if(i>=exts.length) return;
          const src = base + exts[i];
          const img = new Image();
          img.onload = ()=> setHero(src);
          img.onerror = ()=> tryNext(i+1);
          img.src = src;
        })(0);
      }

      document.getElementById('dibajah-btn').addEventListener('click',()=>document.getElementById('dibajah-file').click());
      document.getElementById('dibajah-file').addEventListener('change',e=>{
        const file=e.target.files[0]; if(!file) return;
        const r=new FileReader();
        r.onload=ev=>{ setHero(ev.target.result); localStorage.setItem('dibajah_img_bg', ev.target.result); };
        r.readAsDataURL(file);
      });
    })();

    // Tabs
    const tabs=[
      {btn:'tab-daily',panel:'panel-daily',scope:'d'},
      {btn:'tab-weekly',panel:'panel-weekly',scope:'w'},
      {btn:'tab-monthly',panel:'panel-monthly',scope:'m'},
    ];
    tabs.forEach(t=>{
      const btn=document.getElementById(t.btn);
      const panel=document.getElementById(t.panel);
      btn.addEventListener('click',()=>{
        tabs.forEach(o=>{
          document.getElementById(o.btn).setAttribute('aria-selected',String(o.btn===t.btn));
          document.getElementById(o.panel).hidden = o.panel!==t.panel;
        })
      })
    });

    // Storage fields
    const map = Array.from(document.querySelectorAll('[data-k]'));
    function loadAll(){
      map.forEach(el=>{
        const key=el.getAttribute('data-k');
        the_v=localStorage.getItem(key);
        if(the_v!==null){ if(el.tagName==='TEXTAREA'||el.tagName==='INPUT'){ el.value=the_v; } }
      });
      ['d','w','m'].forEach(prefix=>{
        initUploader(prefix);
        updateCounter(prefix);
      });
    }
    map.forEach(el=>{
      const key=el.getAttribute('data-k');
      el.addEventListener('input',()=>localStorage.setItem(key,el.value||''));
    });

    // Print one section
    function printSection(id){
      tabs.forEach(o=>{ document.getElementById(o.panel).hidden = o.panel!==id; document.getElementById(o.btn).setAttribute('aria-selected', String(o.panel===id)); });
      window.print();
    }

    // Clear section (fields + images)
    function clearSection(scope){
      const pref = scope==='daily'?'d':scope==='weekly'?'w':'m';
      Object.keys(localStorage).forEach(k=>{ if(k.startsWith(pref+'_')) localStorage.removeItem(k); });
      document.querySelectorAll('[data-k^="'+pref+'_"]').forEach(el=>{ if(el.tagName==='INPUT'||el.tagName==='TEXTAREA'){ el.value=''; }});
      localStorage.removeItem(pref+'-img-list');
      const cont=document.getElementById(pref+'-uploader');
      cont.innerHTML=''; initUploader(pref); updateCounter(pref);
    }

    // Uploader
    function initUploader(prefix){
      const container=document.getElementById(prefix+'-uploader');
      container.innerHTML='';
      const stored = JSON.parse(localStorage.getItem(prefix+'-img-list')||'[]').filter(Boolean);
      stored.forEach(src=>container.appendChild(makeSlot(prefix, src)));

      const addBtn=document.querySelector(`[data-add="${prefix}"]`);
      if(addBtn){
        addBtn.onclick = ()=>{
          const list = JSON.parse(localStorage.getItem(prefix+'-img-list')||'[]').filter(Boolean);
          if(list.length>=MAX_IMAGES){ alert('وصلتِ للحد الأقصى للصور'); return; }
          container.appendChild(makeSlot(prefix));
        };
      }
      const clearBtn=document.querySelector(`[data-clear="${prefix}"]`);
      if(clearBtn){
        clearBtn.onclick = ()=>{ container.innerHTML=''; persist(prefix); updateCounter(prefix); };
      }
    }

    function makeSlot(prefix, src){
      const slot=document.createElement('div');
      slot.className='slot';
      const input=document.createElement('input'); input.type='file'; input.accept='image/*';
      const img=document.createElement('img'); if(src) img.src=src;
      const remove=document.createElement('button'); remove.className='remove'; remove.textContent='حذف';
      remove.onclick = ()=>{ slot.remove(); persist(prefix); updateCounter(prefix); };
      slot.appendChild(remove);
      slot.appendChild(input);
      if(src) slot.appendChild(img);
      input.addEventListener('change',e=>{
        const file=e.target.files[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=ev=>{ img.src=ev.target.result; if(!img.isConnected) slot.appendChild(img); persist(prefix); updateCounter(prefix); };
        reader.readAsDataURL(file);
      });
      return slot;
    }

    function persist(prefix){
      const container=document.getElementById(prefix+'-uploader');
      const imgs=[...container.querySelectorAll('img')].map(i=>i.src);
      if(imgs.length){ localStorage.setItem(prefix+'-img-list',JSON.stringify(imgs)); }
      else{ localStorage.removeItem(prefix+'-img-list'); }
    }

    function updateCounter(prefix){
      const el=document.getElementById(prefix+'-count');
      const imgs=JSON.parse(localStorage.getItem(prefix+'-img-list')||'[]').filter(Boolean);
      el.textContent = `عدد الصور: ${imgs.length}`;
    }

    ['d','w','m'].forEach(prefix=>{
      const container=document.getElementById(prefix+'-uploader');
      const obs=new MutationObserver(()=>{ persist(prefix); updateCounter(prefix); });
      obs.observe(container,{childList:true,subtree:true});
    });

    loadAll();
  </script>
</body>
</html>
