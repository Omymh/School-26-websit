<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام التقارير | يومية • أسبوعية • شهرية</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;800&display=swap" rel="stylesheet">

<script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
  :root{
    /* ألوان وهوية */
    --brand:#006C35; --brand-2:#0A8A4F; --accent:#00A36C; --brand-weak:#E8F4EC;
    --ink:#101315; --muted:#69707D; --bg:#F6F8F7; --card:#FFFFFF; --border:#E3E7EA; --danger:#DA3C3C;
    --radius:14px; --line:1.85; --page-w:920px;

    /* قياسات A4 للشاشة */
    --a4-w:210mm; --a4-h:297mm; --paper-pad:12mm;
  }

  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Cairo",system-ui,-apple-system,"Segoe UI","Noto Kufi Arabic",Arial,sans-serif;
    line-height:var(--line);
  }

  /* ====== ديباجة ثابتة في واجهة الموقع ====== */
  .site-letterhead{
    position:sticky; top:0; z-index:1000; background:#fff;
    border-bottom:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,.05);
  }
  .site-letterhead .inner{ max-width:var(--page-w); margin:0 auto; padding:8px 16px; }
  .site-letterhead img{ display:block; margin:0 auto; max-width:100%; height:auto; max-height:140px; }
  .lh-placeholder{ text-align:center; color:var(--muted); padding:16px 0; font-weight:700; }

  /* ====== غلاف المحتوى ====== */
  .container{ max-width:var(--page-w); margin:22px auto 44px; padding:0 16px; }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:0 14px 40px rgba(0,0,0,.05); overflow:hidden;
  }

  .header{
    padding:16px 18px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg, var(--brand-weak), #fff); border-bottom:1px solid var(--border);
  }
  .brand{ display:flex; align-items:center; gap:10px; font-weight:800; color:var(--brand-2); }
  .brand .dot{ width:12px; height:12px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 6px rgba(0,108,53,.12); }
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
  .tab{
    border:1px solid var(--border); background:#fff; color:#1f242b; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:800;
    transition:transform .2s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
  }
  .tab:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08); }
  .tab.active{ background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 6px 16px rgba(0,108,53,.25); }

  .form{ padding:20px; display:grid; gap:16px; }
  .row{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  @media (max-width:680px){ .row{ grid-template-columns:1fr; } }
  label{ display:block; font-weight:700; font-size:15px; margin-bottom:6px; color:#273036; }

  input[type="text"], input[type="date"], textarea{
    width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; color:var(--ink); font-size:15px;
    outline:none; transition:border .2s, box-shadow .2s, transform .08s ease;
  }
  input:focus, textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-weak); }
  input:active, textarea:active{ transform:scale(0.998); }
  textarea{ min-height:140px; resize:vertical; }
  ::placeholder{ color:transparent; }

  .upload{ border:1.5px dashed var(--border); border-radius:12px; padding:16px; background:#FBFEFC; text-align:center; transition:background .2s, border-color .2s; }
  .upload input{ display:none; }
  .thumbs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .thumb{ width:84px; height:64px; border-radius:10px; overflow:hidden; border:1px solid var(--border); background:#f2f6f4; position:relative; }
  .thumb .remove-img{
    position:absolute; top:2px; right:2px; background:rgba(0,0,0,.5); color:#fff;
    border:0; border-radius:50%; width:20px; height:20px;
    font-size:14px; line-height:1; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

  .btn{
    appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:14px;
    transition:transform .12s ease, filter .2s ease, box-shadow .2s ease;
  }
  .btn:hover{ filter:brightness(1.02); transform:translateY(-1px); }
  .btn:active{ transform:translateY(0); }
  .btn-primary{ background:linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%); color:#fff; box-shadow:0 8px 22px rgba(0,108,53,.25); }
  .btn-secondary{ background:var(--accent); color:#fff; box-shadow:0 8px 18px rgba(0,163,108,.22); }
  .btn-ghost{ background:#fff; color:#1e232e; border:1px solid var(--border); }
  .btn-danger{ background:var(--danger); color:#fff; }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
  .note{ color:var(--muted); font-size:12.5px; }

  /* ====== نافذة المعاينة + ورقة A4 ====== */
  .modal{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(6,16,11,.55);
    z-index:9999; padding:20px;
  }
  .modal.show{ display:flex; }
  .sheet{
    width:100%; max-width:920px; max-height:90vh; overflow:auto; background:#fff; border-radius:16px; border:1px solid var(--border);
    box-shadow:0 22px 70px rgba(0,0,0,.35); transform-origin:center; opacity:0; transform:translateY(14px) scale(.98);
    transition:opacity .25s ease, transform .25s ease;
  }
  .modal.show .sheet{ opacity:1; transform:translateY(0) scale(1); }
  .sheet-head{
    padding:10px 14px; border-bottom:1px solid var(--border); display:flex; gap:8px; justify-content:space-between; align-items:center;
    position:sticky; top:0; background:#fff; z-index:2;
  }
  .sheet-actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .sheet-body{ padding:18px 20px 24px; }

  /* ورقة A4 دقيقة للشاشة */
  .paper{
    width:var(--a4-w);
    min-height:var(--a4-h);
    padding:var(--paper-pad);
    box-sizing:border-box;
    margin:0 auto;
    background:#fff; color:#000;
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }

  .report{ font-size:14.5px; }
  .letterhead{ margin-bottom:10mm; text-align:center; }
  .letterhead img{ max-width:100%; height:auto; display:block; margin:0 auto; max-height:28mm; }
  .title{ text-align:center; margin:0 0 6mm; }
  .title h1{ font-size:22px; margin:0; font-weight:800; color:#0b3f25; letter-spacing:.1px; }

  .meta{ display:grid; gap:6mm; grid-template-columns:1fr 1fr; margin:0 0 6mm; }
  .meta .field{ border:1px solid var(--border); border-radius:10px; padding:4mm; }
  .meta .label{ color:#6c7280; font-size:12.5px; margin-bottom:1.5mm; }
  .meta .value{ font-weight:800; word-break:break-word; }

  .block{ margin:0 0 6mm; }
  .block h3{ margin:0 0 3mm; font-size:18px; border-right:4px solid var(--brand); padding-right:3mm; color:#0b3f25; }

  .objectives ul{ margin:0; padding:0 6mm; }
  .objectives li{ margin:2mm 0; }

  .gallery{ display:grid; gap:4mm; grid-template-columns:1fr 1fr; }
  .gallery figure{
    margin:0; border:1px solid var(--border); border-radius:10px; overflow:hidden;
    aspect-ratio:4/3; background:#fafafa; display:flex; align-items:center; justify-content:center;
  }
  .gallery img{ width:100%; height:100%; object-fit:cover; display:block; }

  .footer{
    margin-top:8mm; border-top:1px solid var(--border); padding-top:4mm;
    display:flex; justify-content:space-between; gap:8px; font-weight:800;
  }

  /* منع انكسارات سيئة داخل أقسام حساسة */
  .meta, .block, .gallery, .footer { break-inside: avoid; page-break-inside: avoid; }

  /* ====== ضبط الطباعة: نطبع الورقة فقط ====== */
  @media print{
    body > *:not(.print-area){ display:none !important; }
    .modal{ display:block !important; background:transparent !important; padding:0 !important; }
    .sheet{ box-shadow:none; border:none; max-width:unset; max-height:unset; }
    .sheet-head{ display:none; }
    .sheet-body{ padding:0; }
    .print-area{ display:block; }

    /* نسخة أبسط للمعرض لتجنب مشاكل grid عند التحويل */
    .gallery{ display:flex !important; flex-wrap:wrap !important; gap:4mm !important; }
    .gallery figure{ width:calc(50% - 2mm); break-inside: avoid; page-break-inside: avoid; }

    html[dir="rtl"] *, .paper { direction: rtl; text-align: right; }
  }
</style>

/* ====== @page على مستوى الجذر لضبط A4 للطباعة ====== */
<style>
  @page {
    size: A4 portrait;  /* 210mm x 297mm */
    margin: 0;          /* الهوامش داخل .paper */
  }
</style>
</head>
<body>

<div class="site-letterhead">
  <div class="inner" id="siteLetterhead">
    <div class="lh-placeholder">سيتم تحميل الديباجة تلقائيًا (ملف باسم <b>26</b> في جذر المستودع).</div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="header">
      <div class="brand"><span class="dot"></span> نظام التقارير</div>
      <nav class="tabs" id="tabs">
        <button class="tab active" data-tab="daily">تقارير يومية</button>
        <button class="tab" data-tab="weekly">تقارير أسبوعية</button>
        <button class="tab" data-tab="monthly">تقارير شهرية</button>
      </nav>
    </div>

    <form class="form" id="form" onsubmit="return false;">
      <div>
        <label for="programName">اسم البرنامج</label>
        <input id="programName" type="text">
      </div>

      <div>
        <label for="audience">الفئة المستهدفة</label>
        <input id="audience" type="text">
      </div>

            <div class="row" id="row-date-one">
        <div>
          <label for="dateOne">التاريخ</label>
          <input id="dateOne" type="date">
        </div>
        <div>
          <label for="place">مقر التنفيذ</label>
          <input id="place" type="text">
        </div>
      </div>

            <div class="row" id="row-date-range" style="display:none">
        <div>
          <label for="dateFrom">من تاريخ</label>
          <input id="dateFrom" type="date">
        </div>
        <div>
          <label for="dateTo">إلى تاريخ</label>
          <input id="dateTo" type="date">
        </div>
      </div>

      <div>
        <label for="executor">المنفذة</label>
        <input id="executor" type="text">
      </div>

      <div>
        <label for="objectives">الأهداف (سطر لكل هدف)</label>
        <textarea id="objectives"></textarea>
      </div>

            <div>
        <label>الشواهد (حتى 4 صور)</label>
        <div class="upload" id="dropZone">
          <input id="evidenceFiles" type="file" accept="image/*" multiple>
          <label for="evidenceFiles" class="btn btn-ghost">اختيار الصور</label>
          <div class="note" id="uploadMsg">يمكن سحب الصور وإفلاتها هنا. الحد 4 صور.</div>
          <div class="thumbs" id="thumbs"></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-secondary" id="previewBtn">👁️‍🗨️ معاينة / طباعة</button>
        <button class="btn btn-primary" id="downloadBtn">⬇️ تنزيل PDF</button>
        <button class="btn btn-ghost" id="saveBtn">💾 حفظ</button>
        <button class="btn btn-danger" id="clearBtn" type="button">مسح البيانات</button>
      </div>
      <div class="note">يتم حفظ البيانات محليًا على جهازك فقط (LocalStorage).</div>
    </form>
  </div>
</div>

<div class="modal" id="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
    <div class="sheet-head">
      <strong id="dlgTitle">معاينة التقرير</strong>
      <div class="sheet-actions">
        <button class="btn btn-secondary" id="printBtn">🖨️ طباعة</button>
        <button class="btn btn-primary" id="dlFromPreviewBtn">⬇️ تنزيل PDF</button>
        <button class="btn btn-ghost" id="closeModalBtn">✖️ إغلاق</button>
      </div>
    </div>
    <div class="sheet-body">
      <div id="printArea" class="print-area"></div>
    </div>
  </div>
</div>

<script>
/* =================== ثابت اسم ملف الديباجة =================== */
const SCHOOL_HEADER_BASENAME = "26";

/* =================== أدوات مختصرة =================== */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

/* عناصر الواجهة */
const tabsEl = $("#tabs"), formEl = $("#form"), thumbsEl = $("#thumbs"), dropZone = $("#dropZone");
const filesInput = $("#evidenceFiles"), uploadMsg = $("#uploadMsg"), modal = $("#modal"), printArea = $("#printArea");
const siteLetterhead = $("#siteLetterhead");

/* الحقول */
const programName=$("#programName"), audience=$("#audience"), dateOne=$("#dateOne");
const dateFrom=$("#dateFrom"), dateTo=$("#dateTo"), place=$("#place"), executor=$("#executor"), objectives=$("#objectives");
const rowDateOne=$("#row-date-one"), rowDateRange=$("#row-date-range");

/* أزرار */
const previewBtn=$("#previewBtn"), downloadBtn=$("#downloadBtn"), dlFromPrev=$("#dlFromPreviewBtn");
const printBtn=$("#printBtn"), closeModalBtn=$("#closeModalBtn"), clearBtn=$("#clearBtn"), saveBtn=$("#saveBtn");

/* =================== الحالة والتخزين =================== */
const blank = () => ({ programName:"", audience:"", dateOne:"", dateFrom:"", dateTo:"", place:"", executor:"", objectives:"", images:[] });
const state = { currentTab:"daily", daily:blank(), weekly:blank(), monthly:blank() };
const cur = () => state[state.currentTab];
const saveAll = () => localStorage.setItem("report-suite-pro", JSON.stringify(state));

function loadAll(){
  try{
    const raw = localStorage.getItem("report-suite-pro");
    if(!raw) return;
    const p = JSON.parse(raw);
    if(p && typeof p === 'object'){
      if(p.daily) state.daily = {...blank(), ...p.daily};
      if(p.weekly) state.weekly = {...blank(), ...p.weekly};
      if(p.monthly) state.monthly = {...blank(), ...p.monthly};
      if(p.currentTab) state.currentTab = p.currentTab;
    }
  }catch(e){
    console.error("Failed to load state from LocalStorage", e);
  }
}

/* =================== تحميل الديباجة (واجهة + تقرير) =================== */
let letterheadSrc = null;
async function resolveLetterheadSrc(base){
  const exts=[".png",".jpg",".jpeg",".webp",".svg"];
  for(const ext of exts){
    const url = `${base}${ext}`;
    try {
      const res = await fetch(url, {method: 'HEAD'});
      if (res.ok) return url;
    } catch (e) {
      // Network error, continue to next extension
    }
  }
  return null;
}
async function loadSiteLetterhead(){
  siteLetterhead.innerHTML = "";
  letterheadSrc = await resolveLetterheadSrc(SCHOOL_HEADER_BASENAME);
  if(letterheadSrc){
    const img = document.createElement("img");
    img.alt = "ديباجة المدرسة";
    img.crossOrigin = "anonymous"; // لمخرجات PDF بدون مشاكل CORS
    img.src = letterheadSrc;
    siteLetterhead.appendChild(img);
  }else{
    const div = document.createElement("div");
    div.className = "lh-placeholder";
    div.innerHTML = `تعذّر العثور على ملف الديباجة باسم <b>${SCHOOL_HEADER_BASENAME}</b> (مثال: 26.png / 26.jpg / 26.svg)`;
    siteLetterhead.appendChild(div);
  }
}

/* =================== تبويبات =================== */
function switchTab(tab){
  state.currentTab = tab;
  $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
  rowDateOne.style.display = (tab === "daily") ? "grid" : "none";
  rowDateRange.style.display = (tab === "daily") ? "none" : "grid";

  const s = cur();
  programName.value=s.programName||""; audience.value=s.audience||"";
  dateOne.value=s.dateOne||""; dateFrom.value=s.dateFrom||""; dateTo.value=s.dateTo||"";
  place.value=s.place||""; executor.value=s.executor||""; objectives.value=s.objectives||"";
  renderThumbs(s.images);
  saveAll();
}

/* =================== الشواهد (الصور) =================== */
function renderThumbs(images){
  thumbsEl.innerHTML = "";
  images.forEach((imgSrc, index) => {
    const thumb = document.createElement("div");
    thumb.className = "thumb";
    thumb.innerHTML = `<img src="${imgSrc}" alt="صورة ${index+1}"><button class="remove-img" data-index="${index}">×</button>`;
    thumbsEl.appendChild(thumb);
  });
  uploadMsg.textContent = `يمكن سحب الصور وإفلاتها هنا. الحد الأقصى 4 صور. (تم إضافة ${images.length} صور)`;
  if(images.length >= 4) {
    filesInput.disabled = true;
    dropZone.style.pointerEvents = 'none';
  } else {
    filesInput.disabled = false;
    dropZone.style.pointerEvents = 'auto';
  }
}

function handleImageUpload(files){
  const s = cur();
  const newImages = Array.from(files).slice(0, 4 - s.images.length);
  newImages.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      s.images.push(e.target.result);
      saveAll();
      renderThumbs(s.images);
    };
    reader.readAsDataURL(file);
  });
}

/* =================== إنشاء التقرير (HTML) =================== */
async function generateReport(){
  const s = cur();
  const date = (s.dateOne) ? s.dateOne : `${s.dateFrom} - ${s.dateTo}`;
  const titleText = (s.dateOne) ? "تقرير يومي" : (s.dateFrom && s.dateTo) ? "تقرير أسبوعي / شهري" : "تقرير";

  const letterheadHtml = letterheadSrc ? `<div class="letterhead"><img src="${letterheadSrc}" alt="ديباجة"></div>` : "";
  const objectivesHtml = s.objectives.split('\n').filter(o=>o.trim()).map(o=>`<li>${o.trim()}</li>`).join("");
  const galleryHtml = s.images.length > 0 ?
    `<div class="block">
      <h3>الشواهد</h3>
      <div class="gallery">
        ${s.images.map(imgSrc=>`<figure><img src="${imgSrc}" alt="شاهد"></figure>`).join('')}
      </div>
    </div>` : "";

  const reportHtml = `
    <div class="paper report">
      ${letterheadHtml}
      <div class="title"><h1>${titleText}</h1></div>
      <div class="meta">
        <div class="field"><div class="label">اسم البرنامج</div><div class="value">${s.programName||"-"}</div></div>
        <div class="field"><div class="label">الفئة المستهدفة</div><div class="value">${s.audience||"-"}</div></div>
        <div class="field"><div class="label">التاريخ</div><div class="value">${date||"-"}</div></div>
        <div class="field"><div class="label">مقر التنفيذ</div><div class="value">${s.place||"-"}</div></div>
        <div class="field"><div class="label">المنفذة</div><div class="value">${s.executor||"-"}</div></div>
      </div>
      <div class="block">
        <h3>الأهداف</h3>
        <div class="objectives"><ul>${objectivesHtml||"<li>لا توجد أهداف مُدخلة</li>"}</ul></div>
      </div>
      ${galleryHtml}
      <div class="footer">
        <div>اسم المنفذة: ${s.executor||"-"}</div>
      </div>
    </div>
  `;
  
  // عرض التقرير في منطقة المعاينة
  printArea.innerHTML = reportHtml;

  // انتظار تحميل جميع الصور
  const images = printArea.querySelectorAll('img');
  const promises = Array.from(images).map(img => new Promise((resolve) => {
    if (img.complete) {
      resolve();
    } else {
      img.onload = resolve;
      img.onerror = resolve; // Resolve even on error to avoid stalling
    }
  }));
  await Promise.all(promises);
}

/* =================== دوال التصدير والطباعة =================== */
async function handleReportAction(action){
  await generateReport();
  if (action === 'download') {
    const filename = `تقرير-${cur().programName||"بدون اسم"}-${cur().dateOne||cur().dateFrom||Date.now()}.pdf`;
    const opt = {
      margin: [0, 0, 0, 0], // الهوامش داخل ملف PDF
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, logging: true, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().from(printArea).set(opt).save();
  } else if (action === 'preview') {
    modal.classList.add("show");
  } else if (action === 'print') {
    window.print();
  }
}

/* =================== تهيئة وتشغيل =================== */
function setupEventListeners(){
  // Tab switching
  tabsEl.addEventListener("click",(e)=>{
    const b=e.target.closest(".tab");
    if(!b) return;
    switchTab(b.dataset.tab);
  });

  // Form input saving
  formEl.addEventListener("input", e=>{
    const el = e.target;
    if(el.id in cur()) cur()[el.id] = el.value;
    saveAll();
  });

  // Image upload and drag/drop
  filesInput.addEventListener("change", (e) => handleImageUpload(e.target.files));
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--brand)"; });
  dropZone.addEventListener("dragleave", (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--border)"; });
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.style.borderColor = "var(--border)";
    handleImageUpload(e.dataTransfer.files);
  });
  thumbsEl.addEventListener("click", (e) => {
    const removeBtn = e.target.closest(".remove-img");
    if(removeBtn){
      const indexToRemove = parseInt(removeBtn.dataset.index);
      cur().images.splice(indexToRemove, 1);
      saveAll();
      renderThumbs(cur().images);
    }
  });

  // Buttons
  previewBtn.addEventListener("click", () => handleReportAction('preview'));
  downloadBtn.addEventListener("click", () => handleReportAction('download'));
  dlFromPrev.addEventListener("click", () => handleReportAction('download'));
  printBtn.addEventListener("click", () => handleReportAction('print'));
  closeModalBtn.addEventListener("click", () => modal.classList.remove("show"));
  clearBtn.addEventListener("click", () => {
    if(confirm("هل أنت متأكد من مسح جميع البيانات؟")){
      localStorage.removeItem("report-suite-pro");
      location.reload();
    }
  });
  saveBtn.addEventListener("click", saveAll);
}

// Initial setup
document.addEventListener("DOMContentLoaded", () => {
  loadAll();
  switchTab(state.currentTab);
  loadSiteLetterhead();
  setupEventListeners();
});
</script>

</body>
</html>
