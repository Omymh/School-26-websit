<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± | ÙŠÙˆÙ…ÙŠØ© â€¢ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© â€¢ Ø´Ù‡Ø±ÙŠØ©</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;800&display=swap" rel="stylesheet">

<script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
Â  :root{
Â  Â  /* Ø£Ù„ÙˆØ§Ù† ÙˆÙ‡ÙˆÙŠØ© */
Â  Â  --brand:#006C35; --brand-2:#0A8A4F; --accent:#00A36C; --brand-weak:#E8F4EC;
Â  Â  --ink:#101315; --muted:#69707D; --bg:#F6F8F7; --card:#FFFFFF; --border:#E3E7EA; --danger:#DA3C3C;
Â  Â  --radius:14px; --line:1.85; --page-w:920px;

Â  Â  /* Ù‚ÙŠØ§Ø³Ø§Øª A4 Ù„Ù„Ø´Ø§Ø´Ø© */
Â  Â  --a4-w:210mm; --a4-h:297mm; --paper-pad:12mm;
Â  }

Â  html,body{
Â  Â  margin:0; background:var(--bg); color:var(--ink);
Â  Â  font-family:"Cairo",system-ui,-apple-system,"Segoe UI","Noto Kufi Arabic",Arial,sans-serif;
Â  Â  line-height:var(--line);
Â  }

Â  /* ====== Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø«Ø§Ø¨ØªØ© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ ====== */
Â  .site-letterhead{
Â  Â  position:sticky; top:0; z-index:1000; background:#fff;
Â  Â  border-bottom:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,.05);
Â  }
Â  .site-letterhead .inner{ max-width:var(--page-w); margin:0 auto; padding:8px 16px; }
Â  .site-letterhead img{ display:block; margin:0 auto; max-width:100%; height:auto; max-height:140px; }
Â  .lh-placeholder{ text-align:center; color:var(--muted); padding:16px 0; font-weight:700; }

Â  /* ====== ØºÙ„Ø§Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ====== */
Â  .container{ max-width:var(--page-w); margin:22px auto 44px; padding:0 16px; }
Â  .card{
Â  Â  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
Â  Â  box-shadow:0 14px 40px rgba(0,0,0,.05); overflow:hidden;
Â  }

Â  .header{
Â  Â  padding:16px 18px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
Â  Â  background:linear-gradient(180deg, var(--brand-weak), #fff); border-bottom:1px solid var(--border);
Â  }
Â  .brand{ display:flex; align-items:center; gap:10px; font-weight:800; color:var(--brand-2); }
Â  .brand .dot{ width:12px; height:12px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 6px rgba(0,108,53,.12); }
Â  .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
Â  .tab{
Â  Â  border:1px solid var(--border); background:#fff; color:#1f242b; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:800;
Â  Â  transition:transform .2s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
Â  }
Â  .tab:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08); }
Â  .tab.active{ background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 6px 16px rgba(0,108,53,.25); }

Â  .form{ padding:20px; display:grid; gap:16px; }
Â  .row{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
Â  @media (max-width:680px){ .row{ grid-template-columns:1fr; } }
Â  label{ display:block; font-weight:700; font-size:15px; margin-bottom:6px; color:#273036; }

Â  input[type="text"], input[type="date"], textarea{
Â  Â  width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; color:var(--ink); font-size:15px;
Â  Â  outline:none; transition:border .2s, box-shadow .2s, transform .08s ease;
Â  }
Â  input:focus, textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-weak); }
Â  input:active, textarea:active{ transform:scale(0.998); }
Â  textarea{ min-height:140px; resize:vertical; }
Â  ::placeholder{ color:transparent; }

Â  .upload{ border:1.5px dashed var(--border); border-radius:12px; padding:16px; background:#FBFEFC; text-align:center; transition:background .2s, border-color .2s; }
Â  .upload input{ display:none; }
Â  .thumbs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
Â  .thumb{ width:84px; height:64px; border-radius:10px; overflow:hidden; border:1px solid var(--border); background:#f2f6f4; position:relative; }
  .thumb .remove-img{
    position:absolute; top:2px; right:2px; background:rgba(0,0,0,.5); color:#fff;
    border:0; border-radius:50%; width:20px; height:20px;
    font-size:14px; line-height:1; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }
Â  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

Â  .btn{
Â  Â  appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:14px;
Â  Â  transition:transform .12s ease, filter .2s ease, box-shadow .2s ease;
Â  }
Â  .btn:hover{ filter:brightness(1.02); transform:translateY(-1px); }
Â  .btn:active{ transform:translateY(0); }
Â  .btn-primary{ background:linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%); color:#fff; box-shadow:0 8px 22px rgba(0,108,53,.25); }
Â  .btn-secondary{ background:var(--accent); color:#fff; box-shadow:0 8px 18px rgba(0,163,108,.22); }
Â  .btn-ghost{ background:#fff; color:#1e232e; border:1px solid var(--border); }
Â  .btn-danger{ background:var(--danger); color:#fff; }
Â  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
Â  .note{ color:var(--muted); font-size:12.5px; }

Â  /* ====== Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© + ÙˆØ±Ù‚Ø© A4 ====== */
Â  .modal{
Â  Â  position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(6,16,11,.55);
Â  Â  z-index:9999; padding:20px;
Â  }
Â  .modal.show{ display:flex; }
Â  .sheet{
Â  Â  width:100%; max-width:920px; max-height:90vh; overflow:auto; background:#fff; border-radius:16px; border:1px solid var(--border);
Â  Â  box-shadow:0 22px 70px rgba(0,0,0,.35); transform-origin:center; opacity:0; transform:translateY(14px) scale(.98);
Â  Â  transition:opacity .25s ease, transform .25s ease;
Â  }
Â  .modal.show .sheet{ opacity:1; transform:translateY(0) scale(1); }
Â  .sheet-head{
Â  Â  padding:10px 14px; border-bottom:1px solid var(--border); display:flex; gap:8px; justify-content:space-between; align-items:center;
Â  Â  position:sticky; top:0; background:#fff; z-index:2;
Â  }
Â  .sheet-actions{ display:flex; gap:8px; flex-wrap:wrap; }
Â  .sheet-body{ padding:18px 20px 24px; }

Â  /* ÙˆØ±Ù‚Ø© A4 Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø´Ø§Ø´Ø© */
Â  .paper{
Â  Â  width:var(--a4-w);
Â  Â  min-height:var(--a4-h);
Â  Â  padding:var(--paper-pad);
Â  Â  box-sizing:border-box;
Â  Â  margin:0 auto;
Â  Â  background:#fff; color:#000;
Â  Â  -webkit-print-color-adjust: exact; print-color-adjust: exact;
Â  }

Â  .report{ font-size:14.5px; }
Â  .letterhead{ margin-bottom:10mm; text-align:center; }
Â  .letterhead img{ max-width:100%; height:auto; display:block; margin:0 auto; max-height:28mm; }
Â  .title{ text-align:center; margin:0 0 6mm; }
Â  .title h1{ font-size:22px; margin:0; font-weight:800; color:#0b3f25; letter-spacing:.1px; }

Â  .meta{ display:grid; gap:6mm; grid-template-columns:1fr 1fr; margin:0 0 6mm; }
Â  .meta .field{ border:1px solid var(--border); border-radius:10px; padding:4mm; }
Â  .meta .label{ color:#6c7280; font-size:12.5px; margin-bottom:1.5mm; }
Â  .meta .value{ font-weight:800; word-break:break-word; }

Â  .block{ margin:0 0 6mm; }
Â  .block h3{ margin:0 0 3mm; font-size:18px; border-right:4px solid var(--brand); padding-right:3mm; color:#0b3f25; }

Â  .objectives ul{ margin:0; padding:0 6mm; }
Â  .objectives li{ margin:2mm 0; }

Â  .gallery{ display:grid; gap:4mm; grid-template-columns:1fr 1fr; }
Â  .gallery figure{
Â  Â  margin:0; border:1px solid var(--border); border-radius:10px; overflow:hidden;
Â  Â  aspect-ratio:4/3; background:#fafafa; display:flex; align-items:center; justify-content:center;
Â  }
Â  .gallery img{ width:100%; height:100%; object-fit:cover; display:block; }

Â  .footer{
Â  Â  margin-top:8mm; border-top:1px solid var(--border); padding-top:4mm;
Â  Â  display:flex; justify-content:space-between; gap:8px; font-weight:800;
Â  }

Â  /* Ù…Ù†Ø¹ Ø§Ù†ÙƒØ³Ø§Ø±Ø§Øª Ø³ÙŠØ¦Ø© Ø¯Ø§Ø®Ù„ Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø§Ø³Ø© */
Â  .meta, .block, .gallery, .footer { break-inside: avoid; page-break-inside: avoid; }

Â  /* ====== Ø¶Ø¨Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ù†Ø·Ø¨Ø¹ Ø§Ù„ÙˆØ±Ù‚Ø© ÙÙ‚Ø· ====== */
Â  @media print{
Â  Â  body > *:not(.print-area){ display:none !important; }
Â  Â  .modal{ display:block !important; background:transparent !important; padding:0 !important; }
Â  Â  .sheet{ box-shadow:none; border:none; max-width:unset; max-height:unset; }
Â  Â  .sheet-head{ display:none; }
Â  Â  .sheet-body{ padding:0; }
Â  Â  .print-area{ display:block; }

Â  Â  /* Ù†Ø³Ø®Ø© Ø£Ø¨Ø³Ø· Ù„Ù„Ù…Ø¹Ø±Ø¶ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ grid Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ */
Â  Â  .gallery{ display:flex !important; flex-wrap:wrap !important; gap:4mm !important; }
Â  Â  .gallery figure{ width:calc(50% - 2mm); break-inside: avoid; page-break-inside: avoid; }

Â  Â  html[dir="rtl"] *, .paper { direction: rtl; text-align: right; }
Â  }
</style>

/* ====== @page Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø°Ø± Ù„Ø¶Ø¨Ø· A4 Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ====== */
<style>
Â  @page {
Â  Â  size: A4 portrait;Â  /* 210mm x 297mm */
Â  Â  margin: 0;Â  Â  Â  Â  Â  /* Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø¯Ø§Ø®Ù„ .paper */
Â  }
</style>
</head>
<body>

<div class="site-letterhead">
Â  <div class="inner" id="siteLetterhead">
Â  Â  <div class="lh-placeholder">Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù…Ù„Ù Ø¨Ø§Ø³Ù… <b>26</b> ÙÙŠ Ø¬Ø°Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹).</div>
Â  </div>
</div>

<div class="container">
Â  <div class="card">
Â  Â  <div class="header">
Â  Â  Â  <div class="brand"><span class="dot"></span> Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
Â  Â  Â  <nav class="tabs" id="tabs">
Â  Â  Â  Â  <button class="tab active" data-tab="daily">ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠØ©</button>
Â  Â  Â  Â  <button class="tab" data-tab="weekly">ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</button>
Â  Â  Â  Â  <button class="tab" data-tab="monthly">ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ©</button>
Â  Â  Â  </nav>
Â  Â  </div>

Â  Â  <form class="form" id="form" onsubmit="return false;">
Â  Â  Â  <div>
Â  Â  Â  Â  <label for="programName">Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
Â  Â  Â  Â  <input id="programName" type="text">
Â  Â  Â  </div>

Â  Â  Â  <div>
Â  Â  Â  Â  <label for="audience">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
Â  Â  Â  Â  <input id="audience" type="text">
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="row" id="row-date-one">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="dateOne">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
Â  Â  Â  Â  Â  <input id="dateOne" type="date">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="place">Ù…Ù‚Ø± Ø§Ù„ØªÙ†ÙÙŠØ°</label>
Â  Â  Â  Â  Â  <input id="place" type="text">
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="row" id="row-date-range" style="display:none">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="dateFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
Â  Â  Â  Â  Â  <input id="dateFrom" type="date">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="dateTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
Â  Â  Â  Â  Â  <input id="dateTo" type="date">
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div>
Â  Â  Â  Â  <label for="executor">Ø§Ù„Ù…Ù†ÙØ°Ø©</label>
Â  Â  Â  Â  <input id="executor" type="text">
Â  Â  Â  </div>

Â  Â  Â  <div>
Â  Â  Â  Â  <label for="objectives">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ø³Ø·Ø± Ù„ÙƒÙ„ Ù‡Ø¯Ù)</label>
Â  Â  Â  Â  <textarea id="objectives"></textarea>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  <label>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (Ø­ØªÙ‰ 4 ØµÙˆØ±)</label>
Â  Â  Â  Â  <div class="upload" id="dropZone">
Â  Â  Â  Â  Â  <input id="evidenceFiles" type="file" accept="image/*" multiple>
Â  Â  Â  Â  Â  <label for="evidenceFiles" class="btn btn-ghost">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±</label>
Â  Â  Â  Â  Â  <div class="note" id="uploadMsg">ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ Ù‡Ù†Ø§. Ø§Ù„Ø­Ø¯ 4 ØµÙˆØ±.</div>
Â  Â  Â  Â  Â  <div class="thumbs" id="thumbs"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button class="btn btn-secondary" id="previewBtn">ğŸ‘ï¸â€ğŸ—¨ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© / Ø·Ø¨Ø§Ø¹Ø©</button>
Â  Â  Â  Â  <button class="btn btn-primary" id="downloadBtn">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ PDF</button>
Â  Â  Â  Â  <button class="btn btn-ghost" id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
Â  Â  Â  Â  <button class="btn btn-danger" id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="note">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (LocalStorage).</div>
Â  Â  </form>
Â  </div>
</div>

<div class="modal" id="modal" aria-hidden="true">
Â  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
Â  Â  <div class="sheet-head">
Â  Â  Â  <strong id="dlgTitle">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</strong>
Â  Â  Â  <div class="sheet-actions">
Â  Â  Â  Â  <button class="btn btn-secondary" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
Â  Â  Â  Â  <button class="btn btn-primary" id="dlFromPreviewBtn">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ PDF</button>
Â  Â  Â  Â  <button class="btn btn-ghost" id="closeModalBtn">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="sheet-body">
Â  Â  Â  <div id="printArea" class="print-area"></div>
Â  Â  </div>
Â  </div>
</div>

<script>
/* =================== Ø«Ø§Ø¨Øª Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© =================== */
const SCHOOL_HEADER_BASENAME = "26";

/* =================== Ø£Ø¯ÙˆØ§Øª Ù…Ø®ØªØµØ±Ø© =================== */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
const tabsEl = $("#tabs"), formEl = $("#form"), thumbsEl = $("#thumbs"), dropZone = $("#dropZone");
const filesInput = $("#evidenceFiles"), uploadMsg = $("#uploadMsg"), modal = $("#modal"), printArea = $("#printArea");
const siteLetterhead = $("#siteLetterhead");

/* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
const programName=$("#programName"), audience=$("#audience"), dateOne=$("#dateOne");
const dateFrom=$("#dateFrom"), dateTo=$("#dateTo"), place=$("#place"), executor=$("#executor"), objectives=$("#objectives");
const rowDateOne=$("#row-date-one"), rowDateRange=$("#row-date-range");

/* Ø£Ø²Ø±Ø§Ø± */
const previewBtn=$("#previewBtn"), downloadBtn=$("#downloadBtn"), dlFromPrev=$("#dlFromPreviewBtn");
const printBtn=$("#printBtn"), closeModalBtn=$("#closeModalBtn"), clearBtn=$("#clearBtn"), saveBtn=$("#saveBtn");

/* =================== Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† =================== */
const blank = () => ({ programName:"", audience:"", dateOne:"", dateFrom:"", dateTo:"", place:"", executor:"", objectives:"", images:[] });
const state = { currentTab:"daily", daily:blank(), weekly:blank(), monthly:blank() };
const cur = () => state[state.currentTab];
const saveAll = () => localStorage.setItem("report-suite-pro", JSON.stringify(state));

function loadAll(){
Â  try{
Â  Â  const raw = localStorage.getItem("report-suite-pro");
Â  Â  if(!raw) return;
Â  Â  const p = JSON.parse(raw);
Â  Â  if(p && typeof p === 'object'){
Â  Â  Â  if(p.daily) state.daily = {...blank(), ...p.daily};
Â  Â  Â  if(p.weekly) state.weekly = {...blank(), ...p.weekly};
Â  Â  Â  if(p.monthly) state.monthly = {...blank(), ...p.monthly};
Â  Â  Â  if(p.currentTab) state.currentTab = p.currentTab;
Â  Â  }
Â  }catch(e){
Â  Â  console.error("Failed to load state from LocalStorage", e);
Â  }
}

/* =================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© (ÙˆØ§Ø¬Ù‡Ø© + ØªÙ‚Ø±ÙŠØ±) =================== */
let letterheadSrc = null;
async function resolveLetterheadSrc(base){
Â  const exts=[".png",".jpg",".jpeg",".webp",".svg"];
Â  for(const ext of exts){
Â  Â  const url = `${base}${ext}`;
Â  Â  try {
Â  Â  Â  const res = await fetch(url, {method: 'HEAD'});
Â  Â  Â  if (res.ok) return url;
Â  Â  } catch (e) {
Â  Â  Â  // Network error, continue to next extension
Â  Â  }
Â  }
Â  return null;
}
async function loadSiteLetterhead(){
Â  siteLetterhead.innerHTML = "";
Â  letterheadSrc = await resolveLetterheadSrc(SCHOOL_HEADER_BASENAME);
Â  if(letterheadSrc){
Â  Â  const img = document.createElement("img");
Â  Â  img.alt = "Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©";
Â  Â  img.crossOrigin = "anonymous"; // Ù„Ù…Ø®Ø±Ø¬Ø§Øª PDF Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ CORS
Â  Â  img.src = letterheadSrc;
Â  Â  siteLetterhead.appendChild(img);
Â  }else{
Â  Â  const div = document.createElement("div");
Â  Â  div.className = "lh-placeholder";
Â  Â  div.innerHTML = `ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø¨Ø§Ø³Ù… <b>${SCHOOL_HEADER_BASENAME}</b> (Ù…Ø«Ø§Ù„: 26.png / 26.jpg / 26.svg)`;
Â  Â  siteLetterhead.appendChild(div);
Â  }
}

/* =================== ØªØ¨ÙˆÙŠØ¨Ø§Øª =================== */
function switchTab(tab){
Â  state.currentTab = tab;
Â  $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
Â  rowDateOne.style.display = (tab === "daily") ? "grid" : "none";
Â  rowDateRange.style.display = (tab === "daily") ? "none" : "grid";

Â  const s = cur();
Â  programName.value=s.programName||""; audience.value=s.audience||"";
Â  dateOne.value=s.dateOne||""; dateFrom.value=s.dateFrom||""; dateTo.value=s.dateTo||"";
Â  place.value=s.place||""; executor.value=s.executor||""; objectives.value=s.objectives||"";
Â  renderThumbs(s.images);
Â  saveAll();
}

/* =================== Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (Ø§Ù„ØµÙˆØ±) =================== */
function renderThumbs(images){
Â  thumbsEl.innerHTML = "";
Â  images.forEach((imgSrc, index) => {
Â  Â  const thumb = document.createElement("div");
Â  Â  thumb.className = "thumb";
Â  Â  thumb.innerHTML = `<img src="${imgSrc}" alt="ØµÙˆØ±Ø© ${index+1}"><button class="remove-img" data-index="${index}">Ã—</button>`;
Â  Â  thumbsEl.appendChild(thumb);
Â  });
Â  uploadMsg.textContent = `ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ Ù‡Ù†Ø§. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 4 ØµÙˆØ±. (ØªÙ… Ø¥Ø¶Ø§ÙØ© ${images.length} ØµÙˆØ±)`;
Â  if(images.length >= 4) {
Â  Â  filesInput.disabled = true;
Â  Â  dropZone.style.pointerEvents = 'none';
Â  } else {
Â  Â  filesInput.disabled = false;
Â  Â  dropZone.style.pointerEvents = 'auto';
Â  }
}

function handleImageUpload(files){
Â  const s = cur();
Â  const newImages = Array.from(files).slice(0, 4 - s.images.length);
Â  newImages.forEach(file => {
Â  Â  const reader = new FileReader();
Â  Â  reader.onload = (e) => {
Â  Â  Â  s.images.push(e.target.result);
Â  Â  Â  saveAll();
Â  Â  Â  renderThumbs(s.images);
Â  Â  };
Â  Â  reader.readAsDataURL(file);
Â  });
}

/* =================== Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (HTML) =================== */
async function generateReport(){
Â  const s = cur();
Â  const date = (s.dateOne) ? s.dateOne : `${s.dateFrom} - ${s.dateTo}`;
Â  const titleText = (s.dateOne) ? "ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ" : (s.dateFrom && s.dateTo) ? "ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ / Ø´Ù‡Ø±ÙŠ" : "ØªÙ‚Ø±ÙŠØ±";

Â  const letterheadHtml = letterheadSrc ? `<div class="letterhead"><img src="${letterheadSrc}" alt="Ø¯ÙŠØ¨Ø§Ø¬Ø©"></div>` : "";
Â  const objectivesHtml = s.objectives.split('\n').filter(o=>o.trim()).map(o=>`<li>${o.trim()}</li>`).join("");
Â  const galleryHtml = s.images.length > 0 ?
Â  Â  `<div class="block">
Â  Â  Â  <h3>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</h3>
Â  Â  Â  <div class="gallery">
Â  Â  Â  Â  ${s.images.map(imgSrc=>`<figure><img src="${imgSrc}" alt="Ø´Ø§Ù‡Ø¯"></figure>`).join('')}
Â  Â  Â  </div>
Â  Â  </div>` : "";

Â  const reportHtml = `
Â  Â  <div class="paper report">
Â  Â  Â  ${letterheadHtml}
Â  Â  Â  <div class="title"><h1>${titleText}</h1></div>
Â  Â  Â  <div class="meta">
Â  Â  Â  Â  <div class="field"><div class="label">Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</div><div class="value">${s.programName||"-"}</div></div>
Â  Â  Â  Â  <div class="field"><div class="label">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</div><div class="value">${s.audience||"-"}</div></div>
Â  Â  Â  Â  <div class="field"><div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</div><div class="value">${date||"-"}</div></div>
Â  Â  Â  Â  <div class="field"><div class="label">Ù…Ù‚Ø± Ø§Ù„ØªÙ†ÙÙŠØ°</div><div class="value">${s.place||"-"}</div></div>
Â  Â  Â  Â  <div class="field"><div class="label">Ø§Ù„Ù…Ù†ÙØ°Ø©</div><div class="value">${s.executor||"-"}</div></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="block">
Â  Â  Â  Â  <h3>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</h3>
Â  Â  Â  Â  <div class="objectives"><ul>${objectivesHtml||"<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‡Ø¯Ø§Ù Ù…ÙØ¯Ø®Ù„Ø©</li>"}</ul></div>
Â  Â  Â  </div>
Â  Â  Â  ${galleryHtml}
Â  Â  Â  <div class="footer">
Â  Â  Â  Â  <div>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ÙØ°Ø©: ${s.executor||"-"}</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  `;
Â  
Â  // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
Â  printArea.innerHTML = reportHtml;

Â  // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±
Â  const images = printArea.querySelectorAll('img');
Â  const promises = Array.from(images).map(img => new Promise((resolve) => {
Â  Â  if (img.complete) {
Â  Â  Â  resolve();
Â  Â  } else {
Â  Â  Â  img.onload = resolve;
Â  Â  Â  img.onerror = resolve; // Resolve even on error to avoid stalling
Â  Â  }
Â  }));
Â  await Promise.all(promises);
}

/* =================== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© =================== */
async function handleReportAction(action){
Â  await generateReport();
Â  if (action === 'download') {
Â  Â  const filename = `ØªÙ‚Ø±ÙŠØ±-${cur().programName||"Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}-${cur().dateOne||cur().dateFrom||Date.now()}.pdf`;
Â  Â  const opt = {
Â  Â  Â  margin: [0, 0, 0, 0], // Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø¯Ø§Ø®Ù„ Ù…Ù„Ù PDF
Â  Â  Â  filename: filename,
Â  Â  Â  image: { type: 'jpeg', quality: 0.98 },
Â  Â  Â  html2canvas: { scale: 2, logging: true, useCORS: true },
Â  Â  Â  jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
Â  Â  };
Â  Â  html2pdf().from(printArea).set(opt).save();
Â  } else if (action === 'preview') {
Â  Â  modal.classList.add("show");
Â  } else if (action === 'print') {
Â  Â  window.print();
Â  }
}

/* =================== ØªÙ‡ÙŠØ¦Ø© ÙˆØªØ´ØºÙŠÙ„ =================== */
function setupEventListeners(){
Â  // Tab switching
Â  tabsEl.addEventListener("click",(e)=>{
Â  Â  const b=e.target.closest(".tab");
Â  Â  if(!b) return;
Â  Â  switchTab(b.dataset.tab);
Â  });

Â  // Form input saving
Â  formEl.addEventListener("input", e=>{
Â  Â  const el = e.target;
Â  Â  if(el.id in cur()) cur()[el.id] = el.value;
Â  Â  saveAll();
Â  });

Â  // Image upload and drag/drop
Â  filesInput.addEventListener("change", (e) => handleImageUpload(e.target.files));
Â  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--brand)"; });
Â  dropZone.addEventListener("dragleave", (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--border)"; });
Â  dropZone.addEventListener("drop", (e) => {
Â  Â  e.preventDefault();
Â  Â  dropZone.style.borderColor = "var(--border)";
Â  Â  handleImageUpload(e.dataTransfer.files);
Â  });
Â  thumbsEl.addEventListener("click", (e) => {
Â  Â  const removeBtn = e.target.closest(".remove-img");
Â  Â  if(removeBtn){
Â  Â  Â  const indexToRemove = parseInt(removeBtn.dataset.index);
Â  Â  Â  cur().images.splice(indexToRemove, 1);
Â  Â  Â  saveAll();
Â  Â  Â  renderThumbs(cur().images);
Â  Â  }
Â  });

Â  // Buttons
Â  previewBtn.addEventListener("click", () => handleReportAction('preview'));
Â  downloadBtn.addEventListener("click", () => handleReportAction('download'));
Â  dlFromPrev.addEventListener("click", () => handleReportAction('download'));
Â  printBtn.addEventListener("click", () => handleReportAction('print'));
Â  closeModalBtn.addEventListener("click", () => modal.classList.remove("show"));
Â  clearBtn.addEventListener("click", () => {
Â  Â  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")){
Â  Â  Â  localStorage.removeItem("report-suite-pro");
Â  Â  Â  location.reload();
Â  Â  }
Â  });
Â  saveBtn.addEventListener("click", saveAll);
}

// Initial setup
document.addEventListener("DOMContentLoaded", () => {
Â  loadAll();
Â  switchTab(state.currentTab);
Â  loadSiteLetterhead();
Â  setupEventListeners();
});
</script>

</body>
</html>
