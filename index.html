<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تقرير البرنامج — الثانوية السادسة والعشرون</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#144076; /* لون الوزارة: الأزرق الداكن */
      --secondary:#d4af37; /* لون ذهبي للتفاصيل */
      --bg:#fdfdfd;--card:#ffffff;--ink:#0e0f10;--muted:#5d6166;--line:#e6e7eb;
      --radius:16px;
    }
    body{
      margin:0;background:var(--bg);color:var(--ink);font-family:"Tajawal", sans-serif;line-height:1.7;
    }
    .container{max-width:950px;margin:24px auto;padding:0 14px}

    .school-banner{width:100%;border-bottom:4px solid var(--primary);padding:12px 0;margin-bottom:16px;text-align:center}
    .school-banner img{max-width:100%;height:auto}

    .report{background:var(--card);border:2px solid var(--primary);border-radius:var(--radius);padding:24px}
    .report header{text-align:center;border-bottom:2px solid var(--primary);padding-bottom:10px;margin-bottom:14px}
    .report-title{font-size:24px;color:var(--primary);margin:0}

    .meta{margin:14px 0}
    .meta-row{display:flex;gap:8px;margin:6px 0}
    .meta-row .key{min-width:120px;font-weight:700;color:var(--primary)}

    .objectives{margin:8px 0 18px;padding-inline-start:22px}
    .objectives li{margin:6px 0}

    .witnesses{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:14px}
    .witnesses figure{margin:0;border:1px solid var(--line);border-radius:12px;overflow:hidden;height:210px;display:grid;place-items:center;background:#f2f4f7}
    .witnesses img{width:100%;height:100%;object-fit:cover}

    .footer{margin-top:22px;border-top:2px solid var(--primary);padding-top:10px;display:flex;justify-content:space-between;gap:12px;font-weight:600;color:var(--primary)}

    /* Print styles */
    @page { size: A4; margin: 14mm; }
    @media print{
      body{background:#fff}
      .no-print{display:none !important}
      .container{max-width:none;margin:0;padding:0}
      .report{border:none;padding:0}
      .witnesses figure{height:160px}
    }

    /* Input form hidden on screen (only used for editing before printing) */
    .form-area{background:#eef2f8;border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin-bottom:18px}
    label{display:block;font-weight:600;margin:10px 0 6px;color:var(--primary)}
    input[type="text"], input[type="date"], textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
    textarea{min-height:100px}
    button{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;margin-top:12px}
    button:hover{background:#0d2c50}
  </style>
</head>
<body>
  <div class="container">
    <!-- school banner -->
    <div class="school-banner">
      <img id="schoolHeader" alt="ديباجة المدرسة">
    </div>

    <!-- form to enter data -->
    <section class="form-area no-print">
      <label for="program">اسم البرنامج</label>
      <input type="text" id="program" placeholder="اكتب هنا">

      <label for="date">التاريخ</label>
      <input type="date" id="date">

      <label for="venue">مقر التنفيذ</label>
      <input type="text" id="venue" placeholder="مثال: قاعة النشاط">

      <label for="owner">المنفذة</label>
      <input type="text" id="owner" placeholder="اسم المنفذة">

      <label for="goals">الأهداف</label>
      <textarea id="goals" placeholder="كل هدف في سطر مستقل"></textarea>

      <label for="witness">الشواهد (حد أقصى 4 صور)</label>
      <input id="witness" type="file" accept="image/*" multiple>

      <button id="exportPdfBtn" title="تصدير التقرير إلى ملف PDF صفحة واحدة">تصدير PDF</button>
    </section>

    <!-- report preview -->
    <section class="report" id="report">
      <header>
        <h2 class="report-title">تقرير برنامج</h2>
      </header>
      <div class="meta">
        <div class="meta-row"><div class="key">اسم البرنامج:</div><div class="val" id="vProgram">—</div></div>
        <div class="meta-row"><div class="key">التاريخ:</div><div class="val" id="vDate">—</div></div>
        <div class="meta-row"><div class="key">مقر التنفيذ:</div><div class="val" id="vVenue">—</div></div>
        <div class="meta-row"><div class="key">المنفذة:</div><div class="val" id="vOwner">—</div></div>
      </div>

      <h3>الأهداف</h3>
      <ul class="objectives" id="vGoals"><li>—</li></ul>

      <h3>الشواهد (صور)</h3>
      <div class="witnesses" id="vWitnesses"></div>

      <div class="footer">
        <div>مديرة المدرسة: أماني آل عبشان</div>
        <div>تصميم: أ ريم نافل</div>
      </div>
    </section>
  </div>

  <script>
    // Load banner image named "26" with common extensions
    (function loadBanner(){
      const el = document.getElementById('schoolHeader');
      const hint = document.getElementById('bannerHint');
      const exts = ['png','jpg','jpeg','webp','svg'];
      let i = 0;
      function tryNext(){ if(i>=exts.length){ hint.style.display='block'; return; }
        const src = `26.${exts[i++]}`; const probe = new Image();
        probe.onload = ()=>{ el.src = src; hint.style.display='none'; };
        probe.onerror = tryNext; probe.src = src; }
      tryNext();
    })();

    const $ = sel=>document.querySelector(sel);
    const program=$('#program'), date=$('#date'), venue=$('#venue'), owner=$('#owner'), goals=$('#goals');
    const vProgram=$('#vProgram'), vDate=$('#vDate'), vVenue=$('#vVenue'), vOwner=$('#vOwner'), vGoals=$('#vGoals');

    function formatDateISOtoArabic(iso){ if(!iso) return '—';
      try{ const d = new Date(iso + 'T00:00:00');
        const fmt = new Intl.DateTimeFormat('ar-SA', {year:'numeric', month:'long', day:'numeric'});
        return fmt.format(d);
      }catch{ return iso }
    }

    function update(){
      vProgram.textContent = program.value.trim()||'—';
      vDate.textContent = formatDateISOtoArabic(date.value);
      vVenue.textContent = venue.value.trim()||'—';
      vOwner.textContent = owner.value.trim()||'—';
      const lines = goals.value.split(/
+/).map(s=>s.trim()).filter(Boolean);
      vGoals.innerHTML = lines.length? lines.map(s=>`<li>${escapeHTML(s)}</li>`).join('') : '<li>—</li>';
    }
    [program,date,venue,owner,goals].forEach(inp=>inp.addEventListener('input', update));
    update();

    function escapeHTML(s){return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",
      ">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    // Witness image uploads (max 4)
    const inputFiles = $('#witness');
    const grid = $('#vWitnesses');
    const clearBtn = $('#clearImages');

    function renderImages(fileList){ grid.innerHTML = '';
      Array.from(fileList).slice(0,4).forEach(file=>{ const url = URL.createObjectURL(file);
        const fig = document.createElement('figure'); const img = document.createElement('img');
        img.src = url; img.alt = file.name; fig.appendChild(img); grid.appendChild(fig); }); }

    inputFiles.addEventListener('change', (e)=>{
      const files = e.target.files || [];
      if(files.length>4){ alert('يمكن رفع 4 صور كحد أقصى. سيتم الاحتفاظ بأول 4 فقط.'); }
      renderImages(files);
    });
    clearBtn.addEventListener('click', ()=>{ inputFiles.value=''; grid.innerHTML=''; });

    // Export single-page PDF using html2canvas + jsPDF
    async function exportSinglePagePDF(){
      const missing = [];
      if(!program.value.trim()) missing.push('اسم البرنامج');
      if(!date.value) missing.push('التاريخ');
      if(!venue.value.trim()) missing.push('مقر التنفيذ');
      if(!owner.value.trim()) missing.push('المنفذة');
      if(missing.length){ const ok = confirm('هناك حقول ناقصة: '+missing.join('، ')+'
هل تريد المتابعة بالتصدير؟'); if(!ok) return; }

      const report = document.getElementById('report');
      const { jsPDF } = window.jspdf;
      const canvas = await html2canvas(report, {scale:2, useCORS:true, background:'#ffffff'});
      const imgData = canvas.toDataURL('image/jpeg', 0.95);

      const pdf = new jsPDF('p','mm','a4');
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 10; // mm

      let drawW = pageW - 2*margin;
      let drawH = (canvas.height * drawW) / canvas.width;
      if(drawH > pageH - 2*margin){
        drawH = pageH - 2*margin;
        drawW = (canvas.width * drawH) / canvas.height;
      }
      const x = (pageW - drawW)/2; const y = (pageH - drawH)/2;
      pdf.addImage(imgData, 'JPEG', x, y, drawW, drawH, undefined, 'FAST');
      pdf.save('school-26-report.pdf');
    }

    document.getElementById('exportPdfBtn').addEventListener('click', exportSinglePagePDF);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</body>
</html>

