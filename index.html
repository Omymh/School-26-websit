<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± | ÙŠÙˆÙ…ÙŠØ© - Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© - Ø´Ù‡Ø±ÙŠØ©</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ù…ØªÙˆØ§Ø²Ù† -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- html2pdf (ÙŠØ´Ù…Ù„ html2canvas + jsPDF) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
    integrity="sha512-YcsIPfS+vJr4k2bV5Sef9cYk1Y1gE0jYbHcUarWnms0i3dHf/9QF9lqzNwbtCw2dTmtQ1qClgZsxK9Y1sGfLwQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --ink:#151515;
      --muted:#6c7280;
      --brand:#185adb;
      --brand-weak:#eaf1ff;
      --accent:#00a37a;
      --border:#e6e8ef;
      --danger:#d9363e;
      --radius:14px;
      --page-w:880px;
      --line:1.9;
    }

    html,body{
      background:var(--bg);
      color:var(--ink);
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, "Segoe UI", "Noto Kufi Arabic", Arial, sans-serif;
      line-height:var(--line);
    }

    .container{
      max-width:var(--page-w);
      margin:32px auto 40px;
      padding:0 16px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(20,25,40,.06);
    }

    .header{
      padding:18px 20px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      font-weight:800;
      letter-spacing:.2px;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      color:#2a2f3a;
    }
    .tab.active{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }

    .form{
      padding:20px;
      display:grid;
      gap:14px;
    }
    label{font-weight:700; font-size:15px; margin-bottom:6px; display:block;}
    .row{display:grid; gap:12px; grid-template-columns:1fr 1fr;}
    @media (max-width:620px){ .row{grid-template-columns:1fr;} }

    input[type="text"], input[type="date"], textarea{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:15px;
      outline:none;
      background:#fff;
      color:var(--ink);
      transition:border .2s, box-shadow .2s;
    }
    textarea{ min-height:140px; resize:vertical; }
    input:focus, textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-weak); }

    .upload{
      border:1.5px dashed var(--border);
      border-radius:12px;
      padding:16px;
      background:#fbfcff;
      text-align:center;
    }
    .upload input{ display:none; }
    .btn{
      appearance:none; border:0; border-radius:12px;
      padding:12px 16px; font-weight:800; cursor:pointer; font-size:14px;
    }
    .btn-primary{ background:var(--accent); color:#fff; }
    .btn-secondary{ background:var(--brand); color:#fff; }
    .btn-ghost{ background:#fff; color:#1e232e; border:1px solid var(--border); }
    .btn-danger{ background:var(--danger); color:#fff; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }

    .note{ color:var(--muted); font-size:12.5px; }
    .thumbs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; justify-content:flex-start;}
    .thumb{
      width:80px; height:60px; border-radius:10px; overflow:hidden; border:1px solid var(--border);
      background:#f2f4f8;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(15,20,30,.55); z-index:9999; padding:20px;
    }
    .modal.show{ display:flex; }
    .sheet{
      width:100%; max-width:900px; max-height:90vh; overflow:auto;
      background:#fff; border-radius:16px; border:1px solid var(--border);
      box-shadow:0 20px 60px rgba(10,15,30,.25);
    }
    .sheet-head{
      padding:10px 14px; border-bottom:1px solid var(--border); display:flex; gap:8px; justify-content:space-between; align-items:center;
      position:sticky; top:0; background:#fff; z-index:2;
    }
    .sheet-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .sheet-body{ padding:18px 20px 24px; }

    /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
    .report{
      position:relative;
      background:#fff;
      color:#000;
      font-size:14.5px;
    }
    .letterhead{ margin-bottom:12px; text-align:center; }
    .letterhead img{ max-width:100%; height:auto; display:block; margin:0 auto; }
    .title{ text-align:center; margin:10px 0 12px; }
    .title h1{ font-size:22px; margin:0; font-weight:800; }
    .meta{
      display:grid; gap:12px; grid-template-columns:repeat(2,1fr);
      margin:8px 0 14px;
    }
    .meta .field{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .meta .label{ color:#6c7280; font-size:12.5px; margin-bottom:2px; }
    .meta .value{ font-weight:800; }
    .block{ margin:16px 0; }
    .block h3{ margin:0 0 8px; font-size:18px; border-right:4px solid var(--brand); padding-right:8px; }
    .objectives ul{ margin:0; padding:0 18px; }
    .objectives li{ margin:6px 0; }

    .gallery{
      display:grid; gap:10px; grid-template-columns:repeat(2,1fr);
    }
    .gallery figure{
      margin:0; border:1px solid var(--border); border-radius:10px; overflow:hidden;
      aspect-ratio:4/3; background:#fafafa; display:flex; align-items:center; justify-content:center;
    }
    .gallery img{ width:100%; height:100%; object-fit:cover; display:block; }

    .footer{
      margin-top:20px; border-top:1px solid var(--border); padding-top:12px;
      display:flex; justify-content:space-between; gap:8px; font-weight:800;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ù†Ø¸Ù‡Ø± Ø§Ù„ÙˆØ±Ù‚Ø© ÙÙ‚Ø· */
    @media print{
      body > *:not(.print-area){ display:none !important; }
      .modal{ display:block !important; background:transparent !important; padding:0 !important; }
      .sheet{ box-shadow:none; border:none; max-width:unset; max-height:unset; }
      .sheet-head{ display:none; }
      .sheet-body{ padding:0; }
      .print-area{ display:block; }
      @page{ size:A4; margin:12mm; }
      .block, .meta, .gallery{ break-inside:avoid; }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="card">
      <div class="header">
        <div class="brand">ğŸ“‹ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
        <nav class="tabs" id="tabs">
          <button class="tab active" data-tab="daily">ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠØ©</button>
          <button class="tab" data-tab="weekly">ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</button>
          <button class="tab" data-tab="monthly">ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ©</button>
        </nav>
      </div>

      <form class="form" id="form" onsubmit="return false;">
        <div>
          <label for="programName">Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
          <input id="programName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù‚ÙŠÙ…" required>
        </div>

        <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
        <div class="row" id="row-date-one">
          <div>
            <label for="dateOne">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input id="dateOne" type="date">
          </div>
          <div>
            <label for="place">Ù…Ù‚Ø± Ø§Ù„ØªÙ†ÙÙŠØ°</label>
            <input id="place" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚Ø§Ø¹Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰">
          </div>
        </div>

        <!-- ÙØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ / Ø§Ù„Ø´Ù‡Ø±ÙŠ) -->
        <div class="row" id="row-date-range" style="display:none">
          <div>
            <label for="dateFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="dateFrom" type="date">
          </div>
          <div>
            <label for="dateTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="dateTo" type="date">
          </div>
        </div>

        <div>
          <label for="executor">Ø§Ù„Ù…Ù†ÙØ°Ø©</label>
          <input id="executor" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ÙØ°Ø©">
        </div>

        <div>
          <label for="objectives">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ø³Ø·Ø± Ù„ÙƒÙ„ Ù‡Ø¯Ù)</label>
          <textarea id="objectives" placeholder="Ø§ÙƒØªØ¨ÙŠ ÙƒÙ„ Ù‡Ø¯Ù ÙÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„"></textarea>
        </div>

        <!-- Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ -->
        <div>
          <label>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (Ø­ØªÙ‰ 4 ØµÙˆØ±)</label>
          <div class="upload" id="dropZone">
            <input id="evidenceFiles" type="file" accept="image/*" multiple>
            <label for="evidenceFiles" class="btn btn-secondary">Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±</label>
            <div class="note" id="uploadMsg">ÙŠÙ…ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù‡Ù†Ø§.</div>
            <div class="thumbs" id="thumbs"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" id="previewBtn">ğŸ‘ï¸â€ğŸ—¨ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© / Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn btn-primary" id="downloadBtn">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ PDF</button>
          <button class="btn btn-ghost" id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="btn btn-danger" id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <div class="note">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ (LocalStorage). Ù„Ø§ ØªÙØ±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø¥Ù†ØªØ±Ù†Øª.</div>
      </form>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠÙØ¨Ù†Ù‰ Ù‡Ù†Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø·) -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-head">
        <strong>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</strong>
        <div class="sheet-actions">
          <button class="btn btn-secondary" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn btn-primary" id="dlFromPreviewBtn">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ PDF</button>
          <button class="btn btn-ghost" id="closeModalBtn">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="sheet-body">
        <div id="printArea" class="report print-area"></div>
      </div>
    </div>
  </div>

<script>
/* ======================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ======================= */
const SCHOOL_HEADER_BASENAME = "26"; // Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø¨Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ¯Ø§Ø¯)

/* ======================= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ======================= */
const $ = (sel) => document.querySelector(sel);
const tabsEl = $("#tabs");
const formEl = $("#form");
const thumbsEl = $("#thumbs");
const dropZone = $("#dropZone");
const filesInput = $("#evidenceFiles");
const uploadMsg = $("#uploadMsg");
const modal = $("#modal");
const printArea = $("#printArea");

// Ø­Ù‚ÙˆÙ„
const programName = $("#programName");
const dateOne     = $("#dateOne");
const dateFrom    = $("#dateFrom");
const dateTo      = $("#dateTo");
const place       = $("#place");
const executor    = $("#executor");
const objectives  = $("#objectives");

const rowDateOne  = $("#row-date-one");
const rowDateRange= $("#row-date-range");

const previewBtn  = $("#previewBtn");
const downloadBtn = $("#downloadBtn");
const dlFromPrev  = $("#dlFromPreviewBtn");
const printBtn    = $("#printBtn");
const closeModalBtn = $("#closeModalBtn");
const clearBtn    = $("#clearBtn");
const saveBtn     = $("#saveBtn");

/* ======================= Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† ======================= */
const todayISO = () => {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
};

const blank = () => ({
  programName:"", dateOne:todayISO(), dateFrom:"", dateTo:"",
  place:"", executor:"", objectives:"", images:[]
});

const state = {
  currentTab: "daily",
  daily:   blank(),
  weekly:  {...blank(), dateOne:""}, // Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… dateOne Ù‡Ù†Ø§
  monthly: {...blank(), dateOne:""}
};

function saveAll(){
  localStorage.setItem("report-suite-v2", JSON.stringify(state));
}
function loadAll(){
  try{
    const raw = localStorage.getItem("report-suite-v2");
    if(!raw) return;
    const parsed = JSON.parse(raw);
    // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if(parsed && typeof parsed === 'object'){
      if(parsed.daily)   state.daily = {...blank(), ...parsed.daily};
      if(parsed.weekly)  state.weekly = {...blank(), ...parsed.weekly};
      if(parsed.monthly) state.monthly= {...blank(), ...parsed.monthly};
      if(parsed.currentTab) state.currentTab = parsed.currentTab;
    }
  }catch{}
}

/* ======================= ØªØ¨ÙˆÙŠØ¨Ø§Øª ======================= */
function switchTab(tab){
  state.currentTab = tab;
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === tab);
  });

  const s = state[tab];

  // Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  if(tab === "daily"){
    rowDateOne.style.display = "";
    rowDateRange.style.display = "none";
    if(!s.dateOne) s.dateOne = todayISO();
  }else{
    rowDateOne.style.display = "none";
    rowDateRange.style.display = "";
  }

  // Ø¶Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­Ù‚Ù„
  programName.value = s.programName || "";
  dateOne.value     = s.dateOne || "";
  dateFrom.value    = s.dateFrom || "";
  dateTo.value      = s.dateTo || "";
  place.value       = s.place || "";
  executor.value    = s.executor || "";
  objectives.value  = s.objectives || "";

  // Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…ØµØºÙ‘Ø±Ø§Øª Ø§Ù„ØµÙˆØ±
  renderThumbs(s.images);
  saveAll();
}

tabsEl.addEventListener("click", (e)=>{
  const b = e.target.closest(".tab");
  if(!b) return;
  switchTab(b.dataset.tab);
});

/* ======================= Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ======================= */
programName.addEventListener("input", e=>{ cur().programName = e.target.value; saveAll(); });
dateOne.addEventListener("input", e=>{ cur().dateOne = e.target.value; saveAll(); });
dateFrom.addEventListener("input", e=>{ cur().dateFrom = e.target.value; saveAll(); });
dateTo.addEventListener("input", e=>{ cur().dateTo = e.target.value; saveAll(); });
place.addEventListener("input", e=>{ cur().place = e.target.value; saveAll(); });
executor.addEventListener("input", e=>{ cur().executor = e.target.value; saveAll(); });
objectives.addEventListener("input", e=>{ cur().objectives = e.target.value; saveAll(); });

saveBtn.addEventListener("click", ()=>{ saveAll(); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ”ï¸"); });

clearBtn.addEventListener("click", ()=>{
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø·ØŸ")) return;
  state[state.currentTab] = blank();
  switchTab(state.currentTab);
  toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
});

/* ======================= Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ======================= */
filesInput.addEventListener("change", ()=> handleFiles(filesInput.files));

dropZone.addEventListener("dragover", e=>{
  e.preventDefault(); dropZone.style.background="#f0f6ff"; dropZone.style.borderColor="var(--brand)";
});
dropZone.addEventListener("dragleave", ()=>{
  dropZone.style.background="#fbfcff"; dropZone.style.borderColor="var(--border)";
});
dropZone.addEventListener("drop", e=>{
  e.preventDefault();
  dropZone.style.background="#fbfcff"; dropZone.style.borderColor="var(--border)";
  handleFiles(e.dataTransfer.files);
});

async function handleFiles(files){
  const arr = Array.from(files || []);
  if(!arr.length) return;
  const s = cur();
  const room = Math.max(0, 4 - s.images.length);
  if(room <= 0){ uploadMsg.textContent = "ÙˆØµÙ„ØªÙ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (4 ØµÙˆØ±)."; uploadMsg.style.color="var(--danger)"; return; }
  if(arr.length > room){
    uploadMsg.textContent = `Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ${room} ØµÙˆØ± ÙÙ‚Ø· (Ø§Ù„Ø­Ø¯ 4).`;
    uploadMsg.style.color="var(--danger)";
  }else{
    uploadMsg.textContent = "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± âœ”ï¸";
    uploadMsg.style.color="var(--muted)";
  }
  for(const f of arr.slice(0, room)){
    if(!f.type.startsWith("image/")) continue;
    const data = await compressImage(f, 1400, 0.9);
    s.images.push(data);
  }
  renderThumbs(s.images);
  saveAll();
}

function renderThumbs(list){
  thumbsEl.innerHTML = "";
  list.slice(0,4).forEach((src, idx)=>{
    const d = document.createElement("div");
    d.className = "thumb";
    const img = document.createElement("img");
    img.src = src; img.alt = "Ø´Ø§Ù‡ÙØ¯";
    d.appendChild(img);
    thumbsEl.appendChild(d);
  });
}

/* Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ù€PDF */
function fileToDataURL(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
function loadImage(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = src;
  });
}
async function compressImage(file, maxW=1200, quality=0.9){
  const dataUrl = await fileToDataURL(file);
  const img = await loadImage(dataUrl);
  const ratio = img.width / img.height;
  const w = Math.min(maxW, img.width);
  const h = Math.round(w / ratio);
  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#fff"; ctx.fillRect(0,0,w,h);
  ctx.drawImage(img, 0, 0, w, h);
  return canvas.toDataURL("image/jpeg", quality);
}

/* ======================= Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ======================= */
function cur(){ return state[state.currentTab]; }

function ensureValid(){
  const s = cur();
  if(!s.programName.trim()) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬."), false;
  if(state.currentTab === "daily"){
    if(!s.dateOne) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø­Ø¯Ø¯ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®."), false;
  }else{
    if(!s.dateFrom || !s.dateTo) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø­Ø¯Ø¯ÙŠ ÙØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù† / Ø¥Ù„Ù‰)."), false;
    if(new Date(s.dateFrom) > new Date(s.dateTo)) return alert("ØªØ³Ù„Ø³Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­ (Ù…Ù† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ Ø¥Ù„Ù‰)."), false;
  }
  return true;
}

function fmtDate(iso){
  if(!iso) return "â€”";
  try{ return new Intl.DateTimeFormat('ar', { dateStyle:'long' }).format(new Date(iso)); }
  catch{ return iso; }
}
function fmtRange(a,b){
  if(!a || !b) return "â€”";
  return `${fmtDate(a)} â€” ${fmtDate(b)}`;
}

function objectivesHTML(text){
  const lines = (text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!lines.length) return `<ul><li>â€”</li></ul>`;
  return `<ul>${lines.map(li=>`<li>${escapeHtml(li)}`).join("")}</ul>`;
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

function buildReportDOM(){
  const s = cur();
  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="letterhead" id="rep-letterhead"><div class="note">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø©â€¦</div></div>
    <div class="title"><h1>${escapeHtml(s.programName || "â€”")}</h1></div>
    <div class="meta">
      <div class="field">
        <div class="label">${state.currentTab === "daily" ? "Ø§Ù„ØªØ§Ø±ÙŠØ®" : "Ø§Ù„ÙØªØ±Ø©"}</div>
        <div class="value">${state.currentTab === "daily" ? fmtDate(s.dateOne) : fmtRange(s.dateFrom, s.dateTo)}</div>
      </div>
      <div class="field">
        <div class="label">Ù…Ù‚Ø± Ø§Ù„ØªÙ†ÙÙŠØ°</div>
        <div class="value">${escapeHtml(s.place || "â€”")}</div>
      </div>
      <div class="field">
        <div class="label">Ø§Ù„Ù…Ù†ÙØ°Ø©</div>
        <div class="value">${escapeHtml(s.executor || "â€”")}</div>
      </div>
      <div class="field">
        <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</div>
        <div class="value">${(s.images||[]).length} / 4</div>
      </div>
    </div>

    <div class="block objectives">
      <h3>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</h3>
      <div>${objectivesHTML(s.objectives)}</div>
    </div>

    <div class="block">
      <h3>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (ØµÙˆØ±)</h3>
      <div class="gallery" id="rep-gallery"></div>
    </div>

    <div class="footer">
      <div>Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£Ù…Ø§Ù†ÙŠ Ø¢Ù„ Ø¹Ø¨Ø´Ø§Ù†</div>
      <div>ØªØµÙ…ÙŠÙ… : Ø£ Ø±ÙŠÙ… Ù†Ø§ÙÙ„</div>
    </div>
  `;
  return wrap;
}

/* ======================= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© (Ù…Ù„Ù 26) ======================= */
// ØªØ¬Ù†Ù‘Ø¨Ù†Ø§ Ø·Ù„Ø¨ HEAD Ù„Ø£Ù† Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ§Øª ØªÙ…Ù†Ø¹Ù‡. Ù†Ø³ØªØ¹Ù…Ù„ Image.onload
async function resolveLetterheadSrc(base){
  const exts = ["", ".png",".jpg",".jpeg",".webp",".svg"];
  for(const ext of exts){
    const url = `${base}${ext}`;
    const ok = await imgExists(url);
    if(ok) return url;
  }
  return null;
}
function imgExists(url){
  return new Promise(res=>{
    const i = new Image();
    i.onload = ()=>res(true);
    i.onerror = ()=>res(false);
    // cache-bust Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ø­Ø¯ÙŠØ«Ù‹Ø§
    i.src = `${url}?v=${Date.now()}`;
  });
}

/* ======================= Ù…Ø¹Ø§ÙŠÙ†Ø© / Ø·Ø¨Ø§Ø¹Ø© / PDF ======================= */
previewBtn.addEventListener("click", async ()=>{
  if(!ensureValid()) return;
  openPreview();
});

downloadBtn.addEventListener("click", async ()=>{
  if(!ensureValid()) return;
  // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙŠØ¶Ù‹Ø§ (Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ ØªØ´ÙˆÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆÙ‚Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„)
  await openPreview(true); // true = Ø«Ù… ØªÙ†Ø²ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
});

dlFromPrev.addEventListener("click", ()=> generatePdf());

printBtn.addEventListener("click", ()=>{
  window.print();
});

closeModalBtn.addEventListener("click", closePreview);

async function openPreview(autoDownload=false){
  // Ø§Ø¨Ù†ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  printArea.innerHTML = "";
  const dom = buildReportDOM();
  printArea.appendChild(dom);

  // Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø©
  const src = await resolveLetterheadSrc(SCHOOL_HEADER_BASENAME);
  const holder = printArea.querySelector("#rep-letterhead");
  holder.innerHTML = "";
  if(src){
    const img = document.createElement("img");
    img.alt = "Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©";
    img.src = src;
    holder.appendChild(img);
  }else{
    holder.innerHTML = `<div class="note" style="color:#b00020">ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø¨Ø§Ø³Ù… <b>${SCHOOL_HEADER_BASENAME}</b> (Ø¬Ø±Ø¨: 26.png / 26.jpg / 26.svg)</div>`;
  }

  // Ø£Ø¶Ù Ø§Ù„ØµÙˆØ± (Ø¨Ù…Ù‚Ø§Ø³ Ù…ÙˆØ­Ù‘Ø¯ 4:3)
  const gal = printArea.querySelector("#rep-gallery");
  (cur().images || []).slice(0,4).forEach(src=>{
    const fig = document.createElement("figure");
    const img = document.createElement("img");
    img.src = src; img.alt = "Ø´Ø§Ù‡ÙØ¯";
    fig.appendChild(img);
    gal.appendChild(fig);
  });

  modal.classList.add("show");
  if(autoDownload){
    // Ø§Ù†ØªØ¸Ø± Ø¥Ø·Ø§Ø± Ø§Ù„Ø±Ø³Ù… Ø«Ù… Ù†Ø²Ù‘Ù„
    setTimeout(generatePdf, 250);
  }
}

function closePreview(){
  modal.classList.remove("show");
}

function pdfFileName(){
  const s = cur();
  const base = (s.programName || "ØªÙ‚Ø±ÙŠØ±").replace(/[\\/:*?"<>|]/g,"").trim() || "ØªÙ‚Ø±ÙŠØ±";
  let suffix = "";
  if(state.currentTab === "daily" && s.dateOne) suffix = s.dateOne;
  if(state.currentTab !== "daily" && s.dateFrom && s.dateTo) suffix = `${s.dateFrom}_Ø§Ù„Ù‰_${s.dateTo}`;
  return `${base}-${suffix || new Date().toISOString().slice(0,10)}.pdf`;
}

async function generatePdf(){
  const opt = {
    margin:       [10,10,12,10],
    filename:     pdfFileName(),
    image:        { type:'jpeg', quality:0.96 },
    html2canvas:  { scale:2, useCORS:true, backgroundColor:"#ffffff" },
    jsPDF:        { unit:'mm', format:'a4', orientation:'portrait' },
    pagebreak:    { mode:['css','legacy'] }
  };
  // Ù†Ø³ØªØ®Ø¯Ù… save() Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¸Ø± ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
  await html2pdf().set(opt).from(printArea).save();
}

/* ======================= Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØµØºÙŠØ±Ø© ======================= */
function toast(msg){
  uploadMsg.textContent = msg;
  uploadMsg.style.color = "var(--muted)";
  setTimeout(()=>{ uploadMsg.textContent = "ÙŠÙ…ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù‡Ù†Ø§."; uploadMsg.style.color = "var(--muted)"; }, 2000);
}

/* ======================= Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ======================= */
(function init(){
  loadAll();
  switchTab(state.currentTab || "daily");
})();
</script>
</body>
</html>
