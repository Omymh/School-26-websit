<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± | ÙŠÙˆÙ…ÙŠØ© â€¢ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© â€¢ Ø´Ù‡Ø±ÙŠØ©</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;800&display=swap" rel="stylesheet">

  <!-- html2pdf (Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙˆÙ„Ù‰) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      /* Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ²Ø§Ø±Ø© */
      --brand:#006C35; --brand-2:#0A8A4F; --accent:#00A36C; --brand-weak:#E8F4EC;
      --ink:#101315; --muted:#69707D; --bg:#F6F8F7; --card:#FFFFFF; --border:#E3E7EA; --danger:#DA3C3C;
      --radius:14px; --line:1.85; --page-w:920px;
    }
    html,body{ margin:0; background:var(--bg); color:var(--ink);
      font-family:"Cairo",system-ui,-apple-system,"Segoe UI","Noto Kufi Arabic",Arial,sans-serif; line-height:var(--line);
    }

    /* ====== Ø¨Ø§Ù†Ø± Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© (Ø«Ø§Ø¨Øª Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©) ====== */
    .site-letterhead{
      position:sticky; top:0; z-index:1000;
      background:#fff;
      border-bottom:1px solid var(--border);
      box-shadow:0 8px 24px rgba(0,0,0,.05);
    }
    .site-letterhead .inner{
      max-width:var(--page-w); margin:0 auto; padding:10px 16px;
    }
    .site-letterhead img{
      display:block; margin:0 auto;
      max-width:100%; max-height:140px; height:auto;
    }
    .lh-placeholder{
      text-align:center; color:var(--muted); padding:20px 0; font-weight:700;
    }

    /* ====== Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ====== */
    .container{ max-width:var(--page-w); margin:22px auto 44px; padding:0 16px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:0 14px 40px rgba(0,0,0,.05); overflow:hidden; }

    .header{ padding:16px 18px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, var(--brand-weak), #fff); border-bottom:1px solid var(--border); }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; color:var(--brand-2); }
    .brand .dot{ width:12px; height:12px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 6px rgba(0,108,53,.12); }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ border:1px solid var(--border); background:#fff; color:#1f242b; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:800;
      transition:transform .2s ease, background .2s ease, color .2s ease, box-shadow .2s ease; }
    .tab:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08); }
    .tab.active{ background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 6px 16px rgba(0,108,53,.25); }

    .form{ padding:20px; display:grid; gap:16px; }
    .row{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    @media (max-width:680px){ .row{ grid-template-columns:1fr; } }
    label{ display:block; font-weight:700; font-size:15px; margin-bottom:6px; color:#273036; }

    input[type="text"], input[type="date"], textarea{
      width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; color:var(--ink); font-size:15px;
      outline:none; transition:border .2s, box-shadow .2s, transform .08s ease;
    }
    input:focus, textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px var(--brand-weak); }
    input:active, textarea:active{ transform:scale(0.998); }
    textarea{ min-height:140px; resize:vertical; }
    ::placeholder{ color:transparent; } /* Ù„Ø§ Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª */

    .upload{ border:1.5px dashed var(--border); border-radius:12px; padding:16px; background:#FBFEFC; text-align:center; transition:background .2s, border-color .2s; }
    .upload input{ display:none; }
    .thumbs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; justify-content:flex-start; }
    .thumb{ width:84px; height:64px; border-radius:10px; overflow:hidden; border:1px solid var(--border); background:#f2f6f4; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:14px;
      transition:transform .12s ease, filter .2s ease, box-shadow .2s ease; }
    .btn:hover{ filter:brightness(1.02); transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); }
    .btn-primary{ background:linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%); color:#fff; box-shadow:0 8px 22px rgba(0,108,53,.25); }
    .btn-secondary{ background:var(--accent); color:#fff; box-shadow:0 8px 18px rgba(0,163,108,.22); }
    .btn-ghost{ background:#fff; color:#1e232e; border:1px solid var(--border); }
    .btn-danger{ background:var(--danger); color:#fff; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    .note{ color:var(--muted); font-size:12.5px; }

    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(6,16,11,.55); z-index:9999; padding:20px; }
    .modal.show{ display:flex; }
    .sheet{ width:100%; max-width:900px; max-height:90vh; overflow:auto; background:#fff; border-radius:16px; border:1px solid var(--border);
      box-shadow:0 22px 70px rgba(0,0,0,.35); transform-origin:center; opacity:0; transform:translateY(14px) scale(.98);
      transition:opacity .25s ease, transform .25s ease; }
    .modal.show .sheet{ opacity:1; transform:translateY(0) scale(1); }
    .sheet-head{ padding:10px 14px; border-bottom:1px solid var(--border); display:flex; gap:8px; justify-content:space-between; align-items:center;
      position:sticky; top:0; background:#fff; z-index:2; }
    .sheet-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .sheet-body{ padding:18px 20px 24px; }

    /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
    .report{ color:#000; font-size:14.5px; }
    .letterhead{ margin-bottom:12px; text-align:center; }
    .letterhead img{ max-width:100%; height:auto; display:block; margin:0 auto; max-height:140px; }
    .title{ text-align:center; margin:10px 0 12px; }
    .title h1{ font-size:22px; margin:0; font-weight:800; color:#0b3f25; letter-spacing:.1px; }
    .meta{ display:grid; gap:12px; grid-template-columns:repeat(2,1fr); margin:8px 0 14px; }
    .meta .field{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .meta .label{ color:#6c7280; font-size:12.5px; margin-bottom:2px; }
    .meta .value{ font-weight:800; word-break:break-word; }
    .block{ margin:16px 0; }
    .block h3{ margin:0 0 8px; font-size:18px; border-right:4px solid var(--brand); padding-right:8px; color:#0b3f25; }
    .objectives ul{ margin:0; padding:0 18px; }
    .objectives li{ margin:6px 0; }
    .gallery{ display:grid; gap:10px; grid-template-columns:repeat(2,1fr); }
    .gallery figure{ margin:0; border:1px solid var(--border); border-radius:10px; overflow:hidden; aspect-ratio:4/3; background:#fafafa; display:flex; align-items:center; justify-content:center; }
    .gallery img{ width:100%; height:100%; object-fit:cover; display:block; }
    .footer{ margin-top:20px; border-top:1px solid var(--border); padding-top:12px; display:flex; justify-content:space-between; gap:8px; font-weight:800; }

    /* Ø­Ø±ÙƒØ© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ */
    .tab-panel{ animation:fadeSlide .28s ease; }
    @keyframes fadeSlide{ from{opacity:0;transform:translateY(8px);} to{opacity:1;transform:translateY(0);} }

    /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ù†Ø¸Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙ‚Ø· */
    @media print{
      body > *:not(.print-area){ display:none !important; }
      .modal{ display:block !important; background:transparent !important; padding:0 !important; }
      .sheet{ box-shadow:none; border:none; max-width:unset; max-height:unset; }
      .sheet-head{ display:none; }
      .sheet-body{ padding:0; }
      .print-area{ display:block; }
      @page{ size:A4; margin:12mm; }
      .block, .meta, .gallery{ break-inside:avoid; }
    }

    /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© */
    @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; } }
  </style>
</head>
<body>

  <!-- === Ø¨Ø§Ù†Ø± Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© === -->
  <div class="site-letterhead">
    <div class="inner" id="siteLetterhead">
      <div class="lh-placeholder">Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù…Ù„Ù Ø¨Ø§Ø³Ù… <b>26</b> ÙÙŠ Ø¬Ø°Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹).</div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="header">
        <div class="brand"><span class="dot"></span> Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
        <nav class="tabs" id="tabs">
          <button class="tab active" data-tab="daily">ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠØ©</button>
          <button class="tab" data-tab="weekly">ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</button>
          <button class="tab" data-tab="monthly">ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ©</button>
        </nav>
      </div>

      <form class="form tab-panel" id="form" onsubmit="return false;">
        <div>
          <label for="programName">Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
          <input id="programName" type="text">
        </div>

        <!-- Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© -->
        <div>
          <label for="audience">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
          <input id="audience" type="text">
        </div>

        <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
        <div class="row" id="row-date-one">
          <div>
            <label for="dateOne">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input id="dateOne" type="date">
          </div>
          <div>
            <label for="place">Ù…Ù‚Ø± Ø§Ù„ØªÙ†ÙÙŠØ°</label>
            <input id="place" type="text">
          </div>
        </div>

        <!-- ÙØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ / Ø§Ù„Ø´Ù‡Ø±ÙŠ) -->
        <div class="row" id="row-date-range" style="display:none">
          <div>
            <label for="dateFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="dateFrom" type="date">
          </div>
          <div>
            <label for="dateTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="dateTo" type="date">
          </div>
        </div>

        <div>
          <label for="executor">Ø§Ù„Ù…Ù†ÙØ°Ø©</label>
          <input id="executor" type="text">
        </div>

        <div>
          <label for="objectives">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ø³Ø·Ø± Ù„ÙƒÙ„ Ù‡Ø¯Ù)</label>
          <textarea id="objectives"></textarea>
        </div>

        <!-- Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ -->
        <div>
          <label>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (Ø­ØªÙ‰ 4 ØµÙˆØ±)</label>
          <div class="upload" id="dropZone">
            <input id="evidenceFiles" type="file" accept="image/*" multiple>
            <label for="evidenceFiles" class="btn btn-ghost">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±</label>
            <div class="note" id="uploadMsg">ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ Ù‡Ù†Ø§. Ø§Ù„Ø­Ø¯ 4 ØµÙˆØ±.</div>
            <div class="thumbs" id="thumbs"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" id="previewBtn">ğŸ‘ï¸â€ğŸ—¨ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© / Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn btn-primary" id="downloadBtn">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ PDF</button>
          <button class="btn btn-ghost" id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="btn btn-danger" id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <div class="note">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (LocalStorage).</div>
      </form>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙŠ ÙŠÙØ·Ø¨ÙØ¹ ÙˆÙŠÙØ­ÙØ¸) -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <div class="sheet-head">
        <strong id="dlgTitle">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</strong>
        <div class="sheet-actions">
          <button class="btn btn-secondary" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn btn-primary" id="dlFromPreviewBtn">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ PDF</button>
          <button class="btn btn-ghost" id="closeModalBtn">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="sheet-body">
        <div id="printArea" class="report print-area" aria-live="polite"></div>
      </div>
    </div>
  </div>

<script>
/* ============== Ø«ÙˆØ§Ø¨Øª ============== */
const SCHOOL_HEADER_BASENAME = "26"; // Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© ÙÙŠ Ø¬Ø°Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ¯Ø§Ø¯)

/* ============== Ø£Ø¯ÙˆØ§Øª Ù…Ø®ØªØµØ±Ø© ============== */
const $ = (sel) => document.querySelector(sel);

/* Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© */
const tabsEl = $("#tabs"), formEl = $("#form"), thumbsEl = $("#thumbs"), dropZone = $("#dropZone");
const filesInput = $("#evidenceFiles"), uploadMsg = $("#uploadMsg"), modal = $("#modal"), printArea = $("#printArea");
const siteLetterhead = $("#siteLetterhead");

/* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
const programName=$("#programName"), audience=$("#audience"), dateOne=$("#dateOne");
const dateFrom=$("#dateFrom"), dateTo=$("#dateTo"), place=$("#place"), executor=$("#executor"), objectives=$("#objectives");
const rowDateOne=$("#row-date-one"), rowDateRange=$("#row-date-range");

/* Ø£Ø²Ø±Ø§Ø± */
const previewBtn=$("#previewBtn"), downloadBtn=$("#downloadBtn"), dlFromPrev=$("#dlFromPreviewBtn");
const printBtn=$("#printBtn"), closeModalBtn=$("#closeModalBtn"), clearBtn=$("#clearBtn"), saveBtn=$("#saveBtn");

/* Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© + ØªØ®Ø²ÙŠÙ† */
const blank = () => ({
  programName:"", audience:"", dateOne:"", dateFrom:"", dateTo:"",
  place:"", executor:"", objectives:"", images:[]
});
const state = { currentTab:"daily", daily:blank(), weekly:blank(), monthly:blank() };
const cur = () => state[state.currentTab];
const saveAll = () => localStorage.setItem("report-suite-v5", JSON.stringify(state));
function loadAll(){
  try{
    const raw = localStorage.getItem("report-suite-v5"); if(!raw) return;
    const p = JSON.parse(raw);
    if(p && typeof p === 'object'){
      if(p.daily) state.daily = {...blank(), ...p.daily};
      if(p.weekly) state.weekly = {...blank(), ...p.weekly};
      if(p.monthly) state.monthly = {...blank(), ...p.monthly};
      if(p.currentTab) state.currentTab = p.currentTab;
    }
  }catch{}
}

/* ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© ÙˆØ§Ø³ØªØ¹Ù…Ø§Ù„Ù‡Ø§ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± ====== */
let letterheadSrc = null;

async function resolveLetterheadSrc(base){
  const exts=["",".png",".jpg",".jpeg",".webp",".svg"];
  for(const ext of exts){
    const url=`${base}${ext}`;
    if(await imgExists(url)) return url;
  }
  return null;
}
function imgExists(url){
  return new Promise(res=>{
    const i=new Image();
    i.onload=()=>res(true);
    i.onerror=()=>res(false);
    i.src=`${url}?v=${Date.now()}`; // ÙƒØ³Ø± Ø§Ù„ÙƒØ§Ø´
  });
}

async function loadSiteLetterhead(){
  letterheadSrc = await resolveLetterheadSrc(SCHOOL_HEADER_BASENAME);
  siteLetterhead.innerHTML = "";
  if(letterheadSrc){
    const img = document.createElement("img");
    img.alt = "Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©";
    img.src = `${letterheadSrc}?v=${Date.now()}`; // Ø§Ø¶Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
    siteLetterhead.appendChild(img);
  }else{
    const div = document.createElement("div");
    div.className = "lh-placeholder";
    div.innerHTML = `ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø¨Ø§Ø³Ù… <b>${SCHOOL_HEADER_BASENAME}</b> (Ù…Ø«Ø§Ù„: 26.png / 26.jpg / 26.svg)`;
    siteLetterhead.appendChild(div);
  }
}

/* ====== ØªØ¨ÙˆÙŠØ¨Ø§Øª ====== */
function switchTab(tab){
  state.currentTab = tab;
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
  rowDateOne.style.display = (tab === "daily") ? "" : "none";
  rowDateRange.style.display = (tab === "daily") ? "none" : "";

  const s = cur();
  programName.value=s.programName||""; audience.value=s.audience||"";
  dateOne.value=s.dateOne||""; dateFrom.value=s.dateFrom||""; dateTo.value=s.dateTo||"";
  place.value=s.place||""; executor.value=s.executor||""; objectives.value=s.objectives||"";
  renderThumbs(s.images);

  // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø±ÙƒØ©
  formEl.classList.remove("tab-panel"); void formEl.offsetWidth; formEl.classList.add("tab-panel");
  saveAll();
}
tabsEl.addEventListener("click",(e)=>{ const b=e.target.closest(".tab"); if(!b) return; switchTab(b.dataset.tab); });

/* ====== Ø±Ø¨Ø· Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ====== */
programName.addEventListener("input", e=>{ cur().programName=e.target.value; saveAll(); });
audience.addEventListener("input", e=>{ cur().audience=e.target.value; saveAll(); });
dateOne.addEventListener("input", e=>{ cur().dateOne=e.target.value; saveAll(); });
dateFrom.addEventListener("input", e=>{ cur().dateFrom=e.target.value; saveAll(); });
dateTo.addEventListener("input", e=>{ cur().dateTo=e.target.value; saveAll(); });
place.addEventListener("input", e=>{ cur().place=e.target.value; saveAll(); });
executor.addEventListener("input", e=>{ cur().executor=e.target.value; saveAll(); });
objectives.addEventListener("input", e=>{ cur().objectives=e.target.value; saveAll(); });
saveBtn.addEventListener("click", ()=>{ saveAll(); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ”ï¸"); });

clearBtn.addEventListener("click", ()=>{
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø·ØŸ")) return;
  state[state.currentTab] = blank();
  switchTab(state.currentTab);
  toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
});

/* ====== Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± (Ø­ØªÙ‰ 4) ====== */
filesInput.addEventListener("change", ()=> handleFiles(filesInput.files));
dropZone.addEventListener("dragover", e=>{ e.preventDefault(); dropZone.style.background="#E8F4EC"; dropZone.style.borderColor="var(--brand)"; });
dropZone.addEventListener("dragleave", ()=>{ dropZone.style.background="#FBFEFC"; dropZone.style.borderColor="var(--border)"; });
dropZone.addEventListener("drop", e=>{ e.preventDefault(); dropZone.style.background="#FBFEFC"; dropZone.style.borderColor="var(--border)"; handleFiles(e.dataTransfer.files); });

async function handleFiles(files){
  const arr = Array.from(files||[]); if(!arr.length) return;
  const s = cur(); const room = Math.max(0, 4 - s.images.length);
  if(room <= 0){ setUploadMsg("ÙˆØµÙ„ØªÙ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (4 ØµÙˆØ±).", true); return; }
  if(arr.length > room){ setUploadMsg(`Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ${room} ØµÙˆØ± ÙÙ‚Ø· (Ø§Ù„Ø­Ø¯ 4).`, true); } else { setUploadMsg("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± âœ”ï¸"); }
  for(const f of arr.slice(0, room)){
    if(!f.type.startsWith("image/")) continue;
    const data = await compressImage(f, 1400, 0.9);
    s.images.push(data);
  }
  renderThumbs(s.images); saveAll();
}
function renderThumbs(list){
  thumbsEl.innerHTML=""; (list||[]).slice(0,4).forEach(src=>{ const d=document.createElement("div");
    d.className="thumb"; const img=document.createElement("img"); img.src=src; img.alt="Ø´Ø§Ù‡ÙØ¯"; d.appendChild(img); thumbsEl.appendChild(d); });
}
function setUploadMsg(msg, danger=false){
  uploadMsg.textContent=msg; uploadMsg.style.color = danger ? "var(--danger)" : "var(--muted)";
  if(!danger){ setTimeout(()=>{ uploadMsg.textContent="ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ Ù‡Ù†Ø§. Ø§Ù„Ø­Ø¯ 4 ØµÙˆØ±."; uploadMsg.style.color="var(--muted)"; }, 2000); }
}

/* ====== Ø£Ø¯ÙˆØ§Øª ØµÙˆØ± ====== */
function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
function loadImage(src){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; }); }
async function compressImage(file, maxW=1200, quality=0.9){
  const dataUrl = await fileToDataURL(file); const img = await loadImage(dataUrl); const ratio=img.width/img.height;
  const w=Math.min(maxW,img.width), h=Math.round(w/ratio);
  const canvas=document.createElement("canvas"); canvas.width=w; canvas.height=h; const ctx=canvas.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h); return canvas.toDataURL("image/jpeg", quality);
}
async function waitForImages(container){
  const imgs = Array.from(container.querySelectorAll("img"));
  await Promise.all(imgs.map(img => img.complete ? Promise.resolve() : new Promise(res=>{ img.onload=res; img.onerror=()=>res(); })));
}

/* ====== Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ====== */
function fmtDate(iso){ if(!iso) return "â€”"; try{ return new Intl.DateTimeFormat('ar',{dateStyle:'long'}).format(new Date(iso)); }catch{ return iso; } }
function fmtRange(a,b){ if(!a||!b) return "â€”"; return `${fmtDate(a)} â€” ${fmtDate(b)}`; }
function objectivesHTML(text){ const lines=(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!lines.length) return `<ul><li>â€”</li></ul>`; return `<ul>${lines.map(li=>`<li>${escapeHtml(li)}`).join("")}</ul>`; }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

function buildReportDOM(){
  const s = cur();
  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="letterhead" id="rep-letterhead">
      ${letterheadSrc ? `<img alt="Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" src="${letterheadSrc}?v=${Date.now()}">` : `<div class="note" style="color:#b00020">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø©</div>`}
    </div>
    <div class="title"><h1>${escapeHtml(s.programName || "â€”")}</h1></div>
    <div class="meta">
      <div class="field">
        <div class="label">${state.currentTab === "daily" ? "Ø§Ù„ØªØ§Ø±ÙŠØ®" : "Ø§Ù„ÙØªØ±Ø©"}</div>
        <div class="value">${state.currentTab === "daily" ? fmtDate(s.dateOne) : fmtRange(s.dateFrom, s.dateTo)}</div>
      </div>
      <div class="field">
        <div class="label">Ù…Ù‚Ø± Ø§Ù„ØªÙ†ÙÙŠØ°</div>
        <div class="value">${escapeHtml(s.place || "â€”")}</div>
      </div>
      <div class="field">
        <div class="label">Ø§Ù„Ù…Ù†ÙØ°Ø©</div>
        <div class="value">${escapeHtml(s.executor || "â€”")}</div>
      </div>
      <div class="field">
        <div class="label">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</div>
        <div class="value">${escapeHtml(s.audience || "â€”")}</div>
      </div>
      <div class="field">
        <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</div>
        <div class="value">${(s.images||[]).length} / 4</div>
      </div>
    </div>

    <div class="block objectives">
      <h3>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</h3>
      <div>${objectivesHTML(s.objectives)}</div>
    </div>

    <div class="block">
      <h3>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (ØµÙˆØ±)</h3>
      <div class="gallery" id="rep-gallery"></div>
    </div>

    <div class="footer">
      <div>Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£Ù…Ø§Ù†ÙŠ Ø¢Ù„ Ø¹Ø¨Ø´Ø§Ù†</div>
      <div>ØªØµÙ…ÙŠÙ… : Ø£ Ø±ÙŠÙ… Ù†Ø§ÙÙ„</div>
    </div>
  `;
  return wrap;
}

/* ====== Ù…Ø¹Ø§ÙŠÙ†Ø© / Ø·Ø¨Ø§Ø¹Ø© / PDF ====== */
function ensureValid(){
  const s=cur();
  if(!s.programName.trim()){ alert("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬."); return false; }
  if(state.currentTab==="daily"){
    if(!s.dateOne){ alert("Ø­Ø¯Ø¯ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®."); return false; }
  }else{
    if(!s.dateFrom||!s.dateTo){ alert("Ø­Ø¯Ø¯ÙŠ ÙØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù† / Ø¥Ù„Ù‰)."); return false; }
    if(new Date(s.dateFrom)>new Date(s.dateTo)){ alert("ØªØ³Ù„Ø³Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­."); return false; }
  }
  return true;
}

async function openPreview(autoDownload=false){
  // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ ÙˆØ¥Ù† Ù„Ù… ØªÙƒÙ† ÙØ­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø§Ù„Ø¢Ù†
  if(!letterheadSrc) await loadSiteLetterhead();

  printArea.innerHTML="";
  const dom=buildReportDOM(); printArea.appendChild(dom);

  // ØµÙˆØ± Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯
  const gal=printArea.querySelector("#rep-gallery");
  (cur().images||[]).slice(0,4).forEach(src=>{ const fig=document.createElement("figure"); const img=document.createElement("img"); img.src=src; img.alt="Ø´Ø§Ù‡ÙØ¯"; fig.appendChild(img); gal.appendChild(fig); });

  modal.classList.add("show"); modal.setAttribute("aria-hidden","false");

  await waitForImages(printArea); // Ø§Ù†ØªØ¸Ø± Ø§Ù„ØµÙˆØ± ÙƒØ§Ù…Ù„Ø©

  if(autoDownload){ await generatePdf(); }
}

function closePreview(){ modal.classList.remove("show"); modal.setAttribute("aria-hidden","true"); }

function pdfFileName(){
  const s=cur();
  const base=(s.programName||"ØªÙ‚Ø±ÙŠØ±").replace(/[\\/:*?"<>|]/g,"").trim()||"ØªÙ‚Ø±ÙŠØ±";
  let suffix="";
  if(state.currentTab==="daily" && s.dateOne) suffix=s.dateOne;
  if(state.currentTab!=="daily" && s.dateFrom && s.dateTo) suffix=`${s.dateFrom}_Ø§Ù„Ù‰_${s.dateTo}`;
  return `${base}-${suffix || new Date().toISOString().slice(0,10)}.pdf`;
}

/* ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© html2pdf Ø§Ø­ØªÙŠØ§Ø·ÙŠÙ‹Ø§ Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ± */
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement("script"); s.src=src; s.onload=()=>res(true); s.onerror=()=>rej(new Error("load fail")); document.head.appendChild(s); }); }
async function ensureHtml2Pdf(){
  if(window.html2pdf) return true;
  const cdns=[
    "https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
  ];
  for(const url of cdns){ try{ await loadScript(url); if(window.html2pdf) return true; }catch{} }
  alert("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø¥Ù†Ø´Ø§Ø¡ PDF. ØªØ­Ù‚Ù‘Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†ØªØŒ Ø«Ù… Ø£Ø¹ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."); return false;
}

async function generatePdf(){
  const ok = await ensureHtml2Pdf(); if(!ok) return;
  const opt={
    margin:[10,10,12,10], filename:pdfFileName(),
    image:{type:'jpeg',quality:0.96},
    html2canvas:{scale:2,useCORS:true,backgroundColor:"#ffffff"},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
    pagebreak:{mode:['css','legacy']}
  };
  await waitForImages(printArea);
  try{
    await window.html2pdf().set(opt).from(printArea).save(); // ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±
  }catch(e){
    console.error(e);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù€PDF. Ù„Ùˆ Ø³Ù…Ø­ØªÙ Ø¬Ø±Ù‘Ø¨ÙŠ Ù…Ù† Ù…ØªØµÙØ­ Ù…Ø®ØªÙ„Ù Ø£Ùˆ Ø£Ø¹ÙŠØ¯ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
  }
}

/* ====== Ø£Ø²Ø±Ø§Ø± ====== */
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closePreview(); });
previewBtn.addEventListener("click", async ()=>{ if(!ensureValid()) return; await openPreview(false); });
downloadBtn.addEventListener("click", async ()=>{ if(!ensureValid()) return; await openPreview(true); });
dlFromPrev.addEventListener("click", async ()=>{ await generatePdf(); });
printBtn.addEventListener("click", ()=>{ window.print(); });
closeModalBtn.addEventListener("click", closePreview);

/* ====== Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ± ====== */
function toast(msg){ uploadMsg.textContent=msg; uploadMsg.style.color="var(--muted)"; setTimeout(()=>{ uploadMsg.textContent="ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± ÙˆØ¥ÙÙ„Ø§ØªÙ‡Ø§ Ù‡Ù†Ø§. Ø§Ù„Ø­Ø¯ 4 ØµÙˆØ±."; uploadMsg.style.color="var(--muted)"; },2000); }

/* ====== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ====== */
(async function init(){
  loadAll();
  switchTab(state.currentTab || "daily");
  await loadSiteLetterhead(); // Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© ÙˆØ§Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ù‹Ø§
})();
</script>
</body>
</html>
